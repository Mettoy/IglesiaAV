<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión de Miembros</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0a1a2a;
      color: #d4af37; /* dorado */
      margin: 0;
      padding: 0;
    }
    header {
      background: #06122a;
      padding: 10px 20px;
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
    }
    button {
      background: #d4af37;
      border: none;
      padding: 10px 15px;
      font-weight: bold;
      color: #06122a;
      cursor: pointer;
      border-radius: 5px;
    }
    button:hover {
      background: #b28d22;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.8);
    }
    .modal-content {
      background-color: #0a1a2a;
      margin: 5% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      color: #d4af37;
    }
    .close {
      color: #d4af37;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #d4af37;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      background: #06122a;
      margin-right: 5px;
      user-select: none;
    }
    .tab.active {
      background: #d4af37;
      color: #06122a;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      background: #06122a;
      border: 1px solid #d4af37;
      color: #d4af37;
      border-radius: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #d4af37;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #06122a;
    }
    img.member-photo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }
  </style>
</head>
<body>

<header>Gestión de Miembros</header>
<div style="padding: 20px;">
  <button id="btnOpenModal">Añadir Miembro</button>
  <table id="tablaMiembros">
    <thead>
      <tr>
        <th>Foto</th>
        <th>Nombre</th>
        <th>Código</th>
      </tr>
    </thead>
    <tbody>
      <!-- Aquí se cargarán los miembros -->
    </tbody>
  </table>
</div>

<!-- Modal -->
<div id="modalForm" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>

    <div class="tabs">
      <div class="tab active" data-tab="personal">Datos Personales</div>
      <div class="tab" data-tab="familiares">Datos Familiares</div>
      <div class="tab" data-tab="espirituales">Datos Espirituales</div>
    </div>

    <form id="formMiembro">
      <div class="tab-content active" id="tab-personal">
        <label for="nombre">Nombre completo</label>
        <input type="text" id="nombre" required />

        <label for="codigo">Código</label>
        <input type="text" id="codigo" required />

        <label for="foto">Foto</label>
        <input type="file" id="foto" accept="image/*" required />
      </div>

      <div class="tab-content" id="tab-familiares">
        <label for="conyuge">Cónyuge</label>
        <input type="text" id="conyuge" />

        <label for="hijos">Hijos (cantidad)</label>
        <input type="number" id="hijos" min="0" />
      </div>

      <div class="tab-content" id="tab-espirituales">
        <label for="ministerio">Ministerio</label>
        <input type="text" id="ministerio" />

        <label for="estado">Estado</label>
        <select id="estado">
          <option value="activo" selected>Activo</option>
          <option value="baja">De Baja</option>
        </select>
      </div>

      <div style="margin-top: 20px; text-align: right;">
        <button type="submit">Guardar Miembro</button>
      </div>
    </form>

  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

<script>
  // Configuraciones
  const firebaseConfig = {
    apiKey: "AIzaSyAyfPQzO7evryWcQ5d1lGV3z8aB-gFOh_k",
    authDomain: "iglesia-adoracion-viva.firebaseapp.com",
    databaseURL: "https://iglesia-adoracion-viva-default-rtdb.firebaseio.com",
    projectId: "iglesia-adoracion-viva",
    storageBucket: "iglesia-adoracion-viva.firebasestorage.app",
    messagingSenderId: "815332010058",
    appId: "1:815332010058:web:d2afff616469349d88deb3",
    measurementId: "G-43MZP6V55D"
  };
  const supabaseUrl = 'https://xyptydnouyddzvrffaby.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5cHR5ZG5vdXlkZHp2cmZmYWJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjY1ODUsImV4cCI6MjA2MzU0MjU4NX0.KGoyFjKsdI6N53QzNFJBPHfUGCGssHBSqfkPb4Q39-o';

  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Inicializar Supabase
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // Modal
  const modal = document.getElementById('modalForm');
  const btnOpenModal = document.getElementById('btnOpenModal');
  const btnCloseModal = document.getElementById('closeModal');
  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');

  btnOpenModal.onclick = () => modal.style.display = 'block';
  btnCloseModal.onclick = () => modal.style.display = 'none';

  window.onclick = function(event) {
    if (event.target == modal) modal.style.display = 'none';
  };

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      tabContents.forEach(tc => tc.classList.remove('active'));
      document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    });
  });

  // Función para subir foto a Supabase
  async function subirFotoSupabase(file, codigo) {
    if (!file) return null;
    // Crear un nombre único para la foto, por ejemplo usando el código + timestamp
    const fileExt = file.name.split('.').pop();
    const fileName = `${codigo}_${Date.now()}.${fileExt}`;
    const filePath = `ftmember/${fileName}`;

    const { data, error } = await supabase.storage.from('ftmember').upload(filePath, file, {
      cacheControl: '3600',
      upsert: false
    });

    if (error) {
      console.error('Error al subir foto:', error.message);
      return null;
    }

    // Obtener URL pública
    const { data: publicUrlData } = supabase.storage.from('ftmember').getPublicUrl(filePath);
    return publicUrlData.publicUrl;
  }

  // Guardar miembro en Firestore
  async function guardarMiembro(dataMiembro) {
    try {
      await db.collection('miembros').add(dataMiembro);
      alert('Miembro guardado correctamente.');
      modal.style.display = 'none';
      cargarMiembros(); // Refrescar lista
      document.getElementById('formMiembro').reset();
    } catch (error) {
      alert('Error guardando miembro: ' + error.message);
    }
  }

  // Al enviar el formulario
  document.getElementById('formMiembro').addEventListener('submit', async (e) => {
    e.preventDefault();

    const nombre = document.getElementById('nombre').value.trim();
    const codigo = document.getElementById('codigo').value.trim();
    const fotoInput = document.getElementById('foto');
    const conyuge = document.getElementById('conyuge').value.trim();
    const hijos = Number(document.getElementById('hijos').value) || 0;
    const ministerio = document.getElementById('ministerio').value.trim();
    const estado = document.getElementById('estado').value;

    if (!nombre || !codigo || fotoInput.files.length === 0) {
      alert('Por favor, complete los campos obligatorios y seleccione una foto.');
      return;
    }

    const archivoFoto = fotoInput.files[0];
    const urlFoto = await subirFotoSupabase(archivoFoto, codigo);
    if (!urlFoto) {
      alert('No se pudo subir la foto, intente de nuevo.');
      return;
    }

    const nuevoMiembro = {
      nombre,
      codigo,
      fotoUrl: urlFoto,
      conyuge,
      hijos,
      ministerio,
      estado,
      creado: firebase.firestore.FieldValue.serverTimestamp()
    };

    await guardarMiembro(nuevoMiembro);
  });

  // Cargar miembros desde Firestore
  async function cargarMiembros() {
    const tbody = document.querySelector('#tablaMiembros tbody');
    tbody.innerHTML = '<tr><td colspan="3">Cargando...</td></tr>';

    try {
      const snapshot = await db.collection('miembros').orderBy('nombre').get();
      tbody.innerHTML = '';
      if (snapshot.empty) {
        tbody.innerHTML = '<tr><td colspan="3">No hay miembros registrados.</td></tr>';
        return;
      }
      snapshot.forEach(doc => {
        const data = doc.data();
        const tr = document.createElement('tr');

        const tdFoto = document.createElement('td');
        const img = document.createElement('img');
        img.src = data.fotoUrl || '';
        img.alt = data.nombre;
        img.classList.add('member-photo');
        tdFoto.appendChild(img);

        const tdNombre = document.createElement('td');
        tdNombre.textContent = data.nombre || '';

        const tdCodigo = document.createElement('td');
        tdCodigo.textContent = data.codigo || '';

        tr.appendChild(tdFoto);
        tr.appendChild(tdNombre);
        tr.appendChild(tdCodigo);

        tbody.appendChild(tr);
      });
    } catch (error) {
      tbody.innerHTML = `<tr><td colspan="3">Error cargando miembros: ${error.message}</td></tr>`;
    }
  }

  // Cargar al inicio
  cargarMiembros();

</script>

</body>
</html>
