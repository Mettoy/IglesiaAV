  <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestión de Miembros</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script type="module">
    // FIREBASE
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs,
      updateDoc, doc
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhFOi7rQhuVauaNMTKqyLPFqwWPqkxb3U",
      authDomain: "iglesia-adoracion-viva-182e6.firebaseapp.com",
      projectId: "iglesia-adoracion-viva-182e6",
      storageBucket: "iglesia-adoracion-viva-182e6.appspot.com",
      messagingSenderId: "152824399391",
      appId: "1:152824399391:web:a4fc0937f35935b9b5f72a",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // SUPABASE
    const supabase = createClient(
      'https://azywyqozwwbfctxeokug.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6eXd5cW96d3diZmN0eGVva3VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNzM1NjAsImV4cCI6MjA2MjY0OTU2MH0.tzJiz2LKQcVTb94uncIrGMfi4NV9XwR7xR6lzP3EELk'
    );

    document.addEventListener('DOMContentLoaded', async () => {
      const form = document.getElementById("miembro-form");
      const tabla = document.getElementById("miembros-tabla");
      const btnAdd = document.getElementById("btn-add");
      const search = document.getElementById("buscar");
      const contenedor = document.getElementById("form-container");

      let editId = null;

      btnAdd.addEventListener("click", () => {
        form.reset();
        form["foto"].value = "";
        contenedor.style.display = "block";
        editId = null;
      });

      search.addEventListener("input", () => {
        const filtro = search.value.toLowerCase();
        for (let row of tabla.rows) {
          const nombre = row.cells[1]?.innerText?.toLowerCase() || "";
          row.style.display = nombre.includes(filtro) ? "" : "none";
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(form));
        const file = form.foto.files[0];

        let fotoURL = data.fotoURL;

        if (file) {
          const { data: upload, error } = await supabase.storage
            .from("fotos")
            .upload(`miembros/${Date.now()}_${file.name}`, file, { upsert: true });
          if (error) return alert("Error subiendo la imagen");
          const { data: url } = supabase.storage.from("fotos").getPublicUrl(upload.path);
          fotoURL = url.publicUrl;
        }

        const miembroData = {
          nombre: data.nombre,
          edad: data.edad,
          codigo: data.codigo,
          telefono: data.telefono,
          direccion: data.direccion,
          nacimiento: data.nacimiento,
          conversion: data.conversion,
          lugar_conversion: data.lugar_conversion,
          bautismo: data.bautismo,
          lugar_bautismo: data.lugar_bautismo,
          bautismo_espiritu: data.bautismo_espiritu,
          lugar_bautismo_espiritu: data.lugar_bautismo_espiritu,
          familiar_tipo: data.familiar_tipo,
          familiar_nombre: data.familiar_nombre,
          fotoURL
        };

        if (editId) {
          await updateDoc(doc(db, "miembros", editId), miembroData);
        } else {
          await addDoc(collection(db, "miembros"), miembroData);
        }

        contenedor.style.display = "none";
        cargarMiembros();
      });

      async function cargarMiembros() {
        tabla.innerHTML = "";
        const querySnapshot = await getDocs(collection(db, "miembros"));
        querySnapshot.forEach((docSnap) => {
          const d = docSnap.data();
          const row = tabla.insertRow();
          row.insertCell(0).innerHTML = `<img src="${d.fotoURL}" width="50" />`;
          row.insertCell(1).innerText = d.nombre;
          row.insertCell(2).innerText = d.codigo;
          row.insertCell(3).innerText = d.telefono;
          row.insertCell(4).innerHTML = `<button onclick="editarMiembro('${docSnap.id}', ${JSON.stringify(d).replace(/"/g, '&quot;')})">Editar</button>`;
        });
      }

      window.editarMiembro = (id, d) => {
        form["nombre"].value = d.nombre;
        form["edad"].value = d.edad;
        form["codigo"].value = d.codigo;
        form["telefono"].value = d.telefono;
        form["direccion"].value = d.direccion;
        form["nacimiento"].value = d.nacimiento;
        form["conversion"].value = d.conversion;
        form["lugar_conversion"].value = d.lugar_conversion;
        form["bautismo"].value = d.bautismo;
        form["lugar_bautismo"].value = d.lugar_bautismo;
        form["bautismo_espiritu"].value = d.bautismo_espiritu;
        form["lugar_bautismo_espiritu"].value = d.lugar_bautismo_espiritu;
        form["familiar_tipo"].value = d.familiar_tipo;
        form["familiar_nombre"].value = d.familiar_nombre;
        form["fotoURL"].value = d.fotoURL;
        contenedor.style.display = "block";
        editId = id;
      };

      cargarMiembros();
    });
  </script>
  <style>
    body { font-family: Arial; margin: 20px; }
    #form-container { display: none; background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    fieldset { margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
    legend { font-weight: bold; }
    label { display: block; margin-top: 8px; }
    input, select { width: 100%; padding: 6px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    img { border-radius: 50%; }
    #acciones { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>Gestión de Miembros</h2>

  <div id="acciones">
    <button id="btn-add">Añadir miembro</button>
    <input type="text" id="buscar" placeholder="Buscar miembro...">
  </div>

  <div id="form-container">
    <form id="miembro-form">
      <input type="hidden" name="fotoURL">
      
      <fieldset>
        <legend>Datos Personales</legend>
        <label>Nombre completo: <input name="nombre" required></label>
        <label>Edad: <input name="edad" type="number"></label>
        <label>Código: <input name="codigo"></label>
        <label>Teléfono: <input name="telefono"></label>
        <label>Dirección: <input name="direccion"></label>
        <label>Fecha de nacimiento: <input type="date" name="nacimiento"></label>
        <label>Foto: <input type="file" name="foto" accept="image/*"></label>
      </fieldset>

      <fieldset>
        <legend>Datos Familiares</legend>
        <label>Tipo de familiar:
          <select name="familiar_tipo">
            <option value="Padre">Padre</option>
            <option value="Madre">Madre</option>
            <option value="Hermano/a">Hermano/a</option>
          </select>
        </label>
        <label>Nombre del familiar: <input name="familiar_nombre"></label>
      </fieldset>

      <fieldset>
        <legend>Datos Espirituales</legend>
        <label>Fecha de conversión: <input type="date" name="conversion"></label>
        <label>Lugar de conversión: <input name="lugar_conversion"></label>
        <label>Fecha de bautismo: <input type="date" name="bautismo"></label>
        <label>Lugar de bautismo: <input name="lugar_bautismo"></label>
        <label>Fecha de bautismo en el Espíritu: <input type="date" name="bautismo_espiritu"></label>
        <label>Lugar de bautismo en el Espíritu: <input name="lugar_bautismo_espiritu"></label>
      </fieldset>

      <button type="submit">Guardar</button>
    </form>
  </div>

  <table>
    <thead>
      <tr><th>Foto</th><th>Nombre</th><th>Código</th><th>Teléfono</th><th>Acciones</th></tr>
    </thead>
    <tbody id="miembros-tabla"></tbody>
  </table>
</body>
</html>
