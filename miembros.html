<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestión de Miembros</title>
<!-- Favicon -->
<link rel="icon" type="image/png" href="https://azywyqozwwbfctxeokug.supabase.co/storage/v1/object/public/logos//download-removebg-preview%20(1).png" />

<!-- Estilos básicos -->
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    display: flex;
  }
  /* Menú lateral */
  nav {
    width: 220px;
    background-color: #0d1b2a;
    color: white;
    min-height: 100vh;
    padding: 20px;
    box-sizing: border-box;
  }
  nav img.logo {
    width: 150px;
    margin-bottom: 20px;
  }
  nav h2 {
    font-weight: normal;
    margin-top: 0;
  }
  main {
    flex-grow: 1;
    padding: 20px;
    background: #f0f4f8;
  }
  /* Botón Añadir */
  button#addMemberBtn {
    background-color: #0077cc;
    border: none;
    padding: 10px 20px;
    color: white;
    cursor: pointer;
    border-radius: 4px;
    margin-bottom: 15px;
  }
  /* Tabla */
  table {
    border-collapse: collapse;
    width: 100%;
    background: white;
    border-radius: 5px;
    overflow: hidden;
  }
  th, td {
    text-align: left;
    padding: 12px 15px;
    border-bottom: 1px solid #ddd;
  }
  th {
    background-color: #005599;
    color: white;
  }
  tr:hover {
    background-color: #e0e8f0;
  }
  /* Imagen en tabla */
  td.photo img {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 50%;
  }
  /* Formulario modal */
  #memberFormModal {
    position: fixed;
    top: 0;
    left: 0;
    right:0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
  }
  #memberFormModal.active {
    display: flex;
  }
  form#memberForm {
    background: white;
    padding: 20px;
    border-radius: 6px;
    width: 400px;
    max-width: 95vw;
  }
  form#memberForm label {
    display: block;
    margin-top: 10px;
  }
  form#memberForm input[type="text"],
  form#memberForm input[type="number"],
  form#memberForm input[type="file"] {
    width: 100%;
    padding: 7px;
    margin-top: 4px;
    box-sizing: border-box;
  }
  form#memberForm button {
    margin-top: 15px;
    padding: 10px;
    width: 100%;
    background-color: #0077cc;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 4px;
  }
  /* Paginación */
  #pagination {
    margin-top: 15px;
    text-align: center;
  }
  #pagination button {
    margin: 0 5px;
    padding: 7px 12px;
    border: 1px solid #0077cc;
    background: white;
    color: #0077cc;
    cursor: pointer;
    border-radius: 4px;
  }
  #pagination button.active {
    background: #0077cc;
    color: white;
  }
</style>
</head>
<body>

<!-- Menú lateral -->
<nav>
  <img class="logo" src="https://tulogo.com/logo.png" alt="Logo" />
  <h2>Miembros</h2>
</nav>

<!-- Contenido principal -->
<main>
  <button id="addMemberBtn">Añadir Miembro</button>

  <table id="membersTable">
    <thead>
      <tr>
        <th>Foto</th>
        <th>Código</th>
        <th>Nombre</th>
        <th>Edad</th>
        <th>Teléfono</th>
        <th>Dirección</th>
      </tr>
    </thead>
    <tbody>
      <!-- Miembros aquí -->
    </tbody>
  </table>

  <div id="pagination"></div>
</main>

<!-- Modal formulario -->
<div id="memberFormModal">
  <form id="memberForm">
    <h3>Agregar/Editar Miembro</h3>
    <input type="hidden" id="memberId" />

    <label for="codigo">Código</label>
    <input type="text" id="codigo" required />

    <label for="nombre">Nombre completo</label>
    <input type="text" id="nombre" required />

    <label for="edad">Edad</label>
    <input type="number" id="edad" required min="0" />

    <label for="telefono">Teléfono</label>
    <input type="text" id="telefono" />

    <label for="direccion">Dirección</label>
    <input type="text" id="direccion" />

    <label for="foto">Foto</label>
    <input type="file" id="foto" accept="image/*" />

    <button type="submit">Guardar</button>
    <button type="button" id="cancelBtn" style="background:#aaa; margin-top:5px;">Cancelar</button>
  </form>
</div>

<!-- Scripts Firestore y Supabase -->
<script type="module">
// Importamos Firebase y Supabase
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc, updateDoc, doc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// Configuraciones
const firebaseConfig = {
  apiKey: "AIzaSyAhFOi7rQhuVauaNMTKqyLPFqwWPqkxb3U",
  authDomain: "iglesia-adoracion-viva-182e6.firebaseapp.com",
  projectId: "iglesia-adoracion-viva-182e6",
  storageBucket: "iglesia-adoracion-viva-182e6.appspot.com",
  messagingSenderId: "152824399391",
  appId: "1:152824399391:web:a4fc0937f35935b9b5f72a",
};

const supabaseUrl = 'https://azywyqozwwbfctxeokug.supabase.co';
const supabaseAnonKey = 'eneyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6eXd5cW96d3diZmN0eGVva3VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNzM1NjAsImV4cCI6MjA2MjY0OTU2MH0.tzJiz2LKQcVTb94uncIrGMfi4NV9XwR7xR6lzP3EELk';

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const supabase = createClient(supabaseUrl, supabaseAnonKey);

const membersCollection = collection(db, 'miembros');

// Variables para paginación y orden
let membersData = [];
let currentPage = 1;
const rowsPerPage = 20;

// Elementos DOM
const membersTableBody = document.querySelector('#membersTable tbody');
const addMemberBtn = document.getElementById('addMemberBtn');
const memberFormModal = document.getElementById('memberFormModal');
const memberForm = document.getElementById('memberForm');
const cancelBtn = document.getElementById('cancelBtn');
const paginationDiv = document.getElementById('pagination');

// Función para limpiar el formulario
function resetForm() {
  memberForm.reset();
  document.getElementById('memberId').value = '';
}

// Abrir modal formulario
addMemberBtn.onclick = () => {
  resetForm();
  memberFormModal.classList.add('active');
};

// Cancelar formulario
cancelBtn.onclick = () => {
  memberFormModal.classList.remove('active');
};

// Cargar todos los miembros de Firestore y ordenar alfabéticamente por 'codigo'
async function loadMembers() {
  const snapshot = await getDocs(membersCollection);
  membersData = [];
  snapshot.forEach(docSnap => {
    membersData.push({ id: docSnap.id, ...docSnap.data() });
  });
  // Orden alfabético por código
  membersData.sort((a,b) => (a.codigo || '').localeCompare(b.codigo || ''));

  renderTable();
  renderPagination();
}

// Función para renderizar la tabla con paginación
function renderTable() {
  membersTableBody.innerHTML = '';
  const start = (currentPage -1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pageMembers = membersData.slice(start, end);

  for(const member of pageMembers){
    const tr = document.createElement('tr');

    // Célula foto (a cargar desde Supabase con ruta: "fotos/{member.id}.jpg" o la que corresponda)
    const tdPhoto = document.createElement('td');
    tdPhoto.classList.add('photo');
    // Intentamos obtener URL pública con supabase
    // El archivo en supabase debe tener el nombre {member.id} + extensión

    // Suponemos que la foto se subió con nombre: `${member.id}.jpg` (puedes cambiar lógica si quieres)
    // Aquí intentamos obtener URL pública para mostrar foto

    let photoUrl = null;
    // Método getPublicUrl no da error aunque no exista el archivo
    const { data } = supabase.storage.from('fotos').getPublicUrl(`${member.id}.jpg`);
    photoUrl = data.publicUrl;

    // Si quieres agregar una imagen placeholder en caso que no exista, puedes hacerlo así:
    const img = document.createElement('img');
    img.src = photoUrl || 'https://via.placeholder.com/50?text=Sin+foto';
    img.alt = member.nombre || 'Foto';
    tdPhoto.appendChild(img);
    tr.appendChild(tdPhoto);

    // Código
    const tdCodigo = document.createElement('td');
    tdCodigo.textContent = member.codigo || '';
    tr.appendChild(tdCodigo);

    // Nombre
    const tdNombre = document.createElement('td');
    tdNombre.textContent = member.nombre || '';
    tr.appendChild(tdNombre);

    // Edad
    const tdEdad = document.createElement('td');
    tdEdad.textContent = member.edad || '';
    tr.appendChild(tdEdad);

    // Teléfono
    const tdTelefono = document.createElement('td');
    tdTelefono.textContent = member.telefono || '';
    tr.appendChild(tdTelefono);

    // Dirección
    const tdDireccion = document.createElement('td');
    tdDireccion.textContent = member.direccion || '';
    tr.appendChild(tdDireccion);

    membersTableBody.appendChild(tr);
  }
}

// Renderizar paginación
function renderPagination() {
  paginationDiv.innerHTML = '';
  const pageCount = Math.ceil(membersData.length / rowsPerPage);
  for(let i=1; i<=pageCount; i++){
    const btn = document.createElement('button');
    btn.textContent = i;
    if(i === currentPage) btn.classList.add('active');
    btn.onclick = () => {
      currentPage = i;
      renderTable();
      renderPagination();
    }
    paginationDiv.appendChild(btn);
  }
}

// Guardar o actualizar miembro en Firestore + subir foto a Supabase
memberForm.onsubmit = async (e) => {
  e.preventDefault();

  const id = document.getElementById('memberId').value.trim();
  const codigo = document.getElementById('codigo').value.trim();
  const nombre = document.getElementById('nombre').value.trim();
  const edad = Number(document.getElementById('edad').value);
  const telefono = document.getElementById('telefono').value.trim();
  const direccion = document.getElementById('direccion').value.trim();

  // Archivo foto (puede ser undefined)
  const fotoFile = document.getElementById('foto').files[0];

  try {
    let docId = id;

    if(!docId) {
      // Agregar nuevo
      const docRef = await addDoc(membersCollection, {
        codigo, nombre, edad, telefono, direccion
      });
      docId = docRef.id;
    } else {
      // Actualizar existente
      await updateDoc(doc(db, 'miembros', docId), {
        codigo, nombre, edad, telefono, direccion
      });
    }

    // Subir foto a Supabase con el nombre: docId.jpg (podrías adaptar extensión)
    if(fotoFile){
      // Eliminar el input para que no guarde url en firestore.
      const ext = fotoFile.name.split('.').pop();
      const filePath = `${docId}.jpg`; // fija jpg aunque el archivo original tenga otra extensión
      const { error: uploadError } = await supabase.storage
        .from('fotos')
        .upload(filePath, fotoFile, { upsert: true });

      if(uploadError){
        alert('Error al subir la foto: ' + uploadError.message);
      }
    }

    alert('Miembro guardado con éxito');
    memberFormModal.classList.remove('active');
    loadMembers();

  } catch(err){
    alert('Error guardando el miembro: ' + err.message);
  }
};

// Cargar miembros al iniciar
loadMembers();

</script>

</body>
</html>
