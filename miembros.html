<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestión de Miembros</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script type="module">
    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, updateDoc, doc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhFOi7rQhuVauaNMTKqyLPFqwWPqkxb3U",
      authDomain: "iglesia-adoracion-viva-182e6.firebaseapp.com",
      projectId: "iglesia-adoracion-viva-182e6",
      storageBucket: "iglesia-adoracion-viva-182e6.appspot.com",
      messagingSenderId: "152824399391",
      appId: "1:152824399391:web:a4fc0937f35935b9b5f72a",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Supabase
    const supabase = createClient(
      "https://azywyqozwwbfctxeokug.supabase.co",
      "tu_clave_anon_publica"
    );

    document.addEventListener("DOMContentLoaded", async () => {
      const formContainer = document.getElementById("formulario-miembro");
      const btnAgregar = document.getElementById("btn-agregar-miembro");
      const btnGuardar = document.getElementById("btn-guardar-miembro");
      const tablaMiembros = document.getElementById("tabla-miembros");

      btnAgregar.addEventListener("click", () => {
        formContainer.style.display = "block";
        document.getElementById("formulario").reset();
        familiaresList.innerHTML = "";
      });

      btnGuardar.addEventListener("click", async () => {
        const nombre = document.getElementById("nombre").value;
        const edad = document.getElementById("edad").value;
        const codigo = document.getElementById("codigo").value;
        const telefono = document.getElementById("telefono").value;
        const direccion = document.getElementById("direccion").value;
        const fechaNacimiento = document.getElementById("fecha-nacimiento").value;

        const fechaConversion = document.getElementById("fecha-conversion").value;
        const lugarConversion = document.getElementById("lugar-conversion").value;
        const fechaBautismo = document.getElementById("fecha-bautismo").value;
        const lugarBautismo = document.getElementById("lugar-bautismo").value;
        const fechaBE = document.getElementById("fecha-be").value;
        const lugarBE = document.getElementById("lugar-be").value;

        const fotoFile = document.getElementById("foto").files[0];
        let fotoURL = "";
        if (fotoFile) {
          const { data, error } = await supabase.storage
            .from("fotos")
            .upload(`fotos/${Date.now()}_${fotoFile.name}`, fotoFile);
          if (!error) {
            const { data: urlData } = supabase.storage.from("fotos").getPublicUrl(data.path);
            fotoURL = urlData.publicUrl;
          }
        }

        const familiares = Array.from(document.querySelectorAll(".familiar-item")).map(item => {
          return {
            tipo: item.dataset.tipo,
            nombre: item.dataset.nombre
          };
        });

        const nuevoMiembro = {
          nombre, edad, codigo, telefono, direccion, fechaNacimiento,
          fechaConversion, lugarConversion, fechaBautismo, lugarBautismo,
          fechaBE, lugarBE, fotoURL, familiares
        };

        await addDoc(collection(db, "miembros"), nuevoMiembro);
        alert("Miembro guardado exitosamente.");
        formContainer.style.display = "none";
        cargarMiembros();
      });

      document.getElementById("agregar-familiar").addEventListener("click", () => {
        const tipo = document.getElementById("tipo-familiar").value;
        const nombre = document.getElementById("nombre-familiar").value;
        if (tipo && nombre) {
          const item = document.createElement("div");
          item.textContent = `${tipo}: ${nombre}`;
          item.className = "familiar-item";
          item.dataset.tipo = tipo;
          item.dataset.nombre = nombre;
          familiaresList.appendChild(item);
          document.getElementById("nombre-familiar").value = "";
        }
      });

      async function cargarMiembros() {
        tablaMiembros.innerHTML = "";
        const querySnapshot = await getDocs(collection(db, "miembros"));
        querySnapshot.forEach(doc => {
          const m = doc.data();
          const fila = document.createElement("tr");
          fila.innerHTML = `
            <td><img src="${m.fotoURL || ""}" width="60"/></td>
            <td>${m.nombre}</td>
            <td>${m.codigo}</td>
            <td>${m.telefono}</td>
            <td>${m.edad}</td>
            <td>${m.direccion}</td>
          `;
          tablaMiembros.appendChild(fila);
        });
      }

      cargarMiembros();
    });
  </script>
</head>
<body>
  <button id="btn-agregar-miembro">Agregar miembro</button>

  <div id="formulario-miembro" style="display:none;">
    <form id="formulario">
      <h2>Datos Personales</h2>
      <input type="file" id="foto" />
      <input type="text" id="nombre" placeholder="Nombre completo" required />
      <input type="number" id="edad" placeholder="Edad" required />
      <input type="text" id="codigo" placeholder="Código" required />
      <input type="text" id="telefono" placeholder="Teléfono" required />
      <input type="text" id="direccion" placeholder="Dirección" required />
      <input type="date" id="fecha-nacimiento" placeholder="Fecha de nacimiento" required />

      <h2>Datos Familiares</h2>
      <select id="tipo-familiar">
        <option value="">Seleccionar tipo</option>
        <option value="Padre">Padre</option>
        <option value="Madre">Madre</option>
        <option value="Hermano">Hermano</option>
        <option value="Hermana">Hermana</option>
        <option value="Esposo(a)">Esposo(a)</option>
        <option value="Hijo(a)">Hijo(a)</option>
      </select>
      <input type="text" id="nombre-familiar" placeholder="Nombre del familiar" />
      <button type="button" id="agregar-familiar">Añadir familiar</button>
      <div id="familiaresList"></div>

      <h2>Datos Espirituales</h2>
      <input type="date" id="fecha-conversion" placeholder="Fecha de conversión" />
      <input type="text" id="lugar-conversion" placeholder="Lugar de conversión" />
      <input type="date" id="fecha-bautismo" placeholder="Fecha de bautismo" />
      <input type="text" id="lugar-bautismo" placeholder="Lugar de bautismo" />
      <input type="date" id="fecha-be" placeholder="Fecha bautismo Espíritu" />
      <input type="text" id="lugar-be" placeholder="Lugar bautismo Espíritu" />

      <button type="button" id="btn-guardar-miembro">Guardar</button>
    </form>
  </div>

  <h2>Miembros Registrados</h2>
  <table border="1">
    <thead>
      <tr>
        <th>Foto</th>
        <th>Nombre</th>
        <th>Código</th>
        <th>Teléfono</th>
        <th>Edad</th>
        <th>Dirección</th>
      </tr>
    </thead>
    <tbody id="tabla-miembros"></tbody>
  </table>
</body>
</html>
