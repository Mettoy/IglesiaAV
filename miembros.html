<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Miembros</title>
  <link rel="icon" href="https://azywyqozwwbfctxeokug.supabase.co/storage/v1/object/public/logos//download-removebg-preview%20(1).png" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #0c1a2c;
      color: white;
    }

    header {
      background-color: #08121f;
      padding: 1rem;
      display: flex;
      align-items: center;
    }

    header img {
      height: 50px;
      margin-right: 1rem;
    }

    h1 {
      font-size: 1.5rem;
      color: gold;
    }

    .contenedor {
      padding: 1rem;
    }

    .boton {
      background-color: gold;
      color: #0c1a2c;
      border: none;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-weight: bold;
      border-radius: 5px;
      margin-right: 1rem;
    }

    .formulario {
      margin-top: 1rem;
      background-color: #11243d;
      padding: 1rem;
      border-radius: 10px;
      display: none;
    }

    .formulario input,
    .formulario select {
      display: block;
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      width: 100%;
      border: none;
      border-radius: 5px;
    }

    .miembro {
      background-color: #1a2f4d;
      padding: 0.5rem;
      margin: 0.5rem 0;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .miembro button {
      background-color: gold;
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 3px;
      cursor: pointer;
      color: #0c1a2c;
    }

    .barra-superior {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://azywyqozwwbfctxeokug.supabase.co/storage/v1/object/public/logos//image.png" alt="Logo" />
    <h1>Gestión de Miembros</h1>
  </header>

  <div class="contenedor">
    <div class="barra-superior">
      <button id="btn-agregar" class="boton">Añadir Miembro</button>
      <input type="text" id="busqueda" placeholder="Buscar por nombre..." />
    </div>

    <form id="form-miembro" class="formulario">
      <!-- Datos personales -->
      <h3>Datos Personales</h3>
      <input type="text" name="nombre" placeholder="Nombre completo" required />
      <input type="number" name="edad" placeholder="Edad" required />
      <input type="text" name="codigo" placeholder="Código" required />
      <input type="text" name="telefono" placeholder="Teléfono" />
      <input type="text" name="direccion" placeholder="Dirección" />
      <input type="date" name="nacimiento" placeholder="Fecha de nacimiento" />

      <!-- Foto -->
      <input type="file" name="foto" accept="image/*" />

      <!-- Datos espirituales -->
      <h3>Datos Espirituales</h3>
      <input type="date" name="conversion" placeholder="Fecha de conversión" />
      <input type="text" name="lugarConversion" placeholder="Lugar de conversión" />
      <input type="date" name="bautismo" placeholder="Fecha de bautismo en agua" />
      <input type="text" name="lugarBautismo" placeholder="Lugar de bautismo en agua" />
      <input type="date" name="espiritu" placeholder="Fecha de bautismo en el Espíritu" />
      <input type="text" name="lugarEspiritu" placeholder="Lugar de bautismo en el Espíritu" />

      <button type="submit" class="boton">Guardar</button>
    </form>

    <div id="lista-miembros"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      updateDoc,
      doc,
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhFOi7rQhuVauaNMTKqyLPFqwWPqkxb3U",
      authDomain: "iglesia-adoracion-viva-182e6.firebaseapp.com",
      projectId: "iglesia-adoracion-viva-182e6",
      storageBucket: "iglesia-adoracion-viva-182e6.appspot.com",
      messagingSenderId: "152824399391",
      appId: "1:152824399391:web:a4fc0937f35935b9b5f72a",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const supabaseUrl = "https://azywyqozwwbfctxeokug.supabase.co";
    const supabaseKey = "eneyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
    const bucket = "fotos";

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("form-miembro");
      const btnAgregar = document.getElementById("btn-agregar");
      const miembrosLista = document.getElementById("lista-miembros");
      const busqueda = document.getElementById("busqueda");
      let editandoId = null;

      btnAgregar.addEventListener("click", () => {
        form.reset();
        editandoId = null;
        form.style.display = "block";
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const datos = {
          nombre: form.nombre.value,
          codigo: form.codigo.value,
          edad: form.edad.value,
          telefono: form.telefono.value,
          direccion: form.direccion.value,
          nacimiento: form.nacimiento.value,
          fechaConversion: form.conversion.value,
          lugarConversion: form.lugarConversion.value,
          fechaBautismo: form.bautismo.value,
          lugarBautismo: form.lugarBautismo.value,
          fechaEspiritu: form.espiritu.value,
          lugarEspiritu: form.lugarEspiritu.value,
        };

        const archivo = form.foto.files[0];
        if (archivo) {
          const nombreArchivo = `${Date.now()}_${archivo.name}`;
          const { error } = await fetch(`${supabaseUrl}/storage/v1/object/${bucket}/${nombreArchivo}`, {
            method: "POST",
            headers: {
              "apikey": supabaseKey,
              "Authorization": `Bearer ${supabaseKey}`,
              "Content-Type": archivo.type,
              "x-upsert": "true",
            },
            body: archivo,
          });
          if (error) console.error("Error al subir imagen:", error.message);
        }

        try {
          if (editandoId) {
            await updateDoc(doc(db, "miembros", editandoId), datos);
          } else {
            await addDoc(collection(db, "miembros"), datos);
          }
          form.reset();
          form.style.display = "none";
          editandoId = null;
          cargarMiembros();
        } catch (err) {
          console.error("Error guardando miembro:", err);
        }
      });

      async function cargarMiembros() {
        miembrosLista.innerHTML = "";
        const snapshot = await getDocs(collection(db, "miembros"));
        snapshot.forEach((docu) => {
          const data = docu.data();
          const div = document.createElement("div");
          div.className = "miembro";
          div.innerHTML = `
            <span>${data.nombre} - Código: ${data.codigo}</span>
            <button class="editar" data-id="${docu.id}">Editar</button>
          `;
          miembrosLista.appendChild(div);
        });

        document.querySelectorAll(".editar").forEach((btn) => {
          btn.addEventListener("click", async () => {
            editandoId = btn.dataset.id;
            const docs = await getDocs(collection(db, "miembros"));
            const datos = docs.docs.find(d => d.id === editandoId).data();
            form.nombre.value = datos.nombre || "";
            form.codigo.value = datos.codigo || "";
            form.edad.value = datos.edad || "";
            form.telefono.value = datos.telefono || "";
            form.direccion.value = datos.direccion || "";
            form.nacimiento.value = datos.nacimiento || "";
            form.conversion.value = datos.fechaConversion || "";
            form.lugarConversion.value = datos.lugarConversion || "";
            form.bautismo.value = datos.fechaBautismo || "";
            form.lugarBautismo.value = datos.lugarBautismo || "";
            form.espiritu.value = datos.fechaEspiritu || "";
            form.lugarEspiritu.value = datos.lugarEspiritu || "";
            form.style.display = "block";
          });
        });
      }

      busqueda.addEventListener("input", () => {
        const texto = busqueda.value.toLowerCase();
        document.querySelectorAll(".miembro").forEach((div) => {
          const nombre = div.textContent.toLowerCase();
          div.style.display = nombre.includes(texto) ? "flex" : "none";
        });
      });

      cargarMiembros();
    });
  </script>
</body>
</html>
