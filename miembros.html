<!-- acceso.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestión de Accesos</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    :root {
      --azul-oscuro: #0d1b2a;
      --dorado: #f0c808;
      --blanco: #ffffff;
      --gris: #f5f5f5;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--gris);
    }
    header {
      background-color: var(--azul-oscuro);
      color: var(--dorado);
      padding: 1rem;
      text-align: center;
    }
    .container {
      display: flex;
    }
    .sidebar {
      width: 200px;
      background-color: var(--azul-oscuro);
      color: var(--blanco);
      height: 100vh;
      padding: 1rem;
    }
    .sidebar img {
      width: 100%;
      margin-bottom: 2rem;
    }
    .content {
      flex: 1;
      padding: 2rem;
    }
    .tabs {
      margin-bottom: 1rem;
    }
    .tabs button {
      background: var(--azul-oscuro);
      color: var(--blanco);
      border: none;
      padding: 0.5rem 1rem;
      margin-right: 5px;
      cursor: pointer;
    }
    .tabs button.active {
      background: var(--dorado);
      color: var(--azul-oscuro);
    }
    .search-bar {
      margin-bottom: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--blanco);
    }
    th, td {
      padding: 0.75rem;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: var(--azul-oscuro);
      color: var(--blanco);
    }
    .add-btn {
      background-color: var(--dorado);
      color: var(--azul-oscuro);
      border: none;
      padding: 0.5rem 1rem;
      cursor: pointer;
      margin-bottom: 1rem;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: var(--blanco);
      padding: 2rem;
      border-radius: 10px;
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal h2 {
      margin-top: 0;
    }
    .form-section {
      display: none;
    }
    .form-section.active {
      display: block;
    }
    .form-navigation {
      margin-top: 1rem;
      display: flex;
      justify-content: space-between;
    }
    .form-navigation button {
      padding: 0.5rem 1rem;
      border: none;
      cursor: pointer;
    }
    .form-navigation .next {
      background-color: var(--dorado);
      color: var(--azul-oscuro);
    }
    .form-navigation .prev {
      background-color: var(--azul-oscuro);
      color: var(--blanco);
    }
    .close-btn {
      background: red;
      color: white;
      float: right;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      border: none;
    }
    img.foto-mini {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <header>
    <h1>Gestión de Accesos</h1>
  </header>
  <div class="container">
    <aside class="sidebar">
      <img src="logo.png" alt="Logo">
      <p>Menú</p>
    </aside>
    <main class="content">
      <button class="add-btn" onclick="abrirModal()">Añadir Acceso</button>
      <div class="tabs">
        <button onclick="mostrarAccesos('activo')" class="active">Activos</button>
        <button onclick="mostrarAccesos('baja')">De Baja</button>
      </div>
      <input type="text" class="search-bar" placeholder="Buscar..." oninput="buscarAccesos(this.value)">
      <table>
        <thead>
          <tr>
            <th>Foto</th>
            <th>Nombre</th>
            <th>Código</th>
            <th>Rol</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla-accesos"></tbody>
      </table>
    </main>
  </div>

  <!-- MODAL -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="cerrarModal()">X</button>
      <h2>Nuevo Acceso</h2>
      <form id="formulario">
        <div id="seccion1" class="form-section active">
          <label>Nombre completo:</label><br/>
          <input type="text" name="nombre" required><br/>
          <label>Código:</label><br/>
          <input type="text" name="codigo" required><br/>
        </div>
        <div id="seccion2" class="form-section">
          <label>Rol:</label><br/>
          <select name="rol">
            <option value="administrador">Administrador</option>
            <option value="lector">Lector</option>
          </select><br/>
        </div>
        <div id="seccion3" class="form-section">
          <label>Foto:</label><br/>
          <input type="file" id="foto" accept="image/*"><br/>
        </div>
        <div class="form-navigation">
          <button type="button" class="prev" onclick="cambiarSeccion(-1)">Anterior</button>
          <button type="button" class="next" onclick="cambiarSeccion(1)">Siguiente</button>
          <button type="submit" style="display:none" id="guardar-btn" class="add-btn">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // CONFIGURACIÓN
    const firebaseConfig = {
      apiKey: "AIzaSyAyfPQzO7evryWcQ5d1lGV3z8aB-gFOh_k",
      authDomain: "iglesia-adoracion-viva.firebaseapp.com",
      projectId: "iglesia-adoracion-viva",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const supabase = supabase.createClient(
      "https://dcvidzvupqimptslzvmt.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ..."
    );

    let accesos = [];
    let estadoActual = 'activo';
    let seccionActual = 1;

    const abrirModal = () => {
      document.getElementById('modal').style.display = 'flex';
      document.getElementById('formulario').reset();
      seccionActual = 1;
      mostrarSeccion();
    };
    const cerrarModal = () => document.getElementById('modal').style.display = 'none';
    const cambiarSeccion = dir => {
      seccionActual += dir;
      if (seccionActual > 3) seccionActual = 3;
      if (seccionActual < 1) seccionActual = 1;
      mostrarSeccion();
    };
    const mostrarSeccion = () => {
      document.querySelectorAll('.form-section').forEach((sec, i) => {
        sec.classList.toggle('active', i === seccionActual - 1);
      });
      document.getElementById('guardar-btn').style.display = (seccionActual === 3) ? 'inline-block' : 'none';
    };

    document.getElementById('formulario').addEventListener('submit', async e => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target));
      data.estado = 'activo';
      data.created = new Date().toISOString();
      const archivo = document.getElementById('foto').files[0];
      let url = '';
      if (archivo) {
        const nombreUnico = `${Date.now()}_${archivo.name}`;
        const { data: fotoSubida, error } = await supabase.storage.from('ftmember').upload(nombreUnico, archivo);
        if (error) return Swal.fire('Error', 'No se pudo subir la foto', 'error');
        const { data: urlFoto } = supabase.storage.from('ftmember').getPublicUrl(nombreUnico);
        url = urlFoto.publicUrl;
      }
      data.foto = url;
      await db.collection('accesos').add(data);
      Swal.fire('Éxito', 'Acceso guardado', 'success');
      cerrarModal();
      cargarAccesos();
    });

    const cargarAccesos = async () => {
      const snapshot = await db.collection('accesos').orderBy('codigo').get();
      accesos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      mostrarAccesos(estadoActual);
    };

    const mostrarAccesos = estado => {
      estadoActual = estado;
      document.querySelectorAll('.tabs button').forEach(btn =>
        btn.classList.toggle('active', btn.textContent.toLowerCase().includes(estado))
      );
      const tbody = document.getElementById('tabla-accesos');
      tbody.innerHTML = '';
      accesos.filter(a => a.estado === estado).forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><img src="${a.foto}" class="foto-mini" /></td>
          <td>${a.nombre}</td>
          <td>${a.codigo}</td>
          <td>${a.rol}</td>
          <td><button onclick="cambiarEstado('${a.id}')">Cambiar estado</button></td>
        `;
        tbody.appendChild(tr);
      });
    };

    const cambiarEstado = async id => {
      const acc = accesos.find(a => a.id === id);
      const nuevoEstado = acc.estado === 'activo' ? 'baja' : 'activo';
      await db.collection('accesos').doc(id).update({ estado: nuevoEstado });
      cargarAccesos();
    };

    const buscarAccesos = texto => {
      const filas = document.querySelectorAll('#tabla-accesos tr');
      filas.forEach(fila => {
        const visible = Array.from(fila.children).some(td =>
          td.textContent.toLowerCase().includes(texto.toLowerCase())
        );
        fila.style.display = visible ? '' : 'none';
      });
    };

    cargarAccesos();
  </script>
</body>
</html>
