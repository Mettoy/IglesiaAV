<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión de Miembros</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #121c2c;
      color: #f0c75e;
    }
    header {
      background-color: #0d1520;
      padding: 10px 20px;
      text-align: center;
      font-size: 24px;
    }
    .container {
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #1a2940;
    }
    th, td {
      border: 1px solid #f0c75e;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #0d1520;
    }
    img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 4px;
    }
    button {
      background-color: #f0c75e;
      color: #121c2c;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
      margin-right: 5px;
    }
    button:hover {
      background-color: #d9ac3c;
    }
    /* Modal */
    .modal-bg {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    .modal-bg.active {
      display: flex;
    }
    .modal {
      background-color: #1a2940;
      padding: 20px;
      border-radius: 8px;
      width: 600px;
      max-width: 95%;
      max-height: 90vh;
      overflow-y: auto;
      color: #f0c75e;
    }
    .modal h2 {
      margin-top: 0;
      margin-bottom: 15px;
      text-align: center;
    }
    .tabs {
      display: flex;
      margin-bottom: 15px;
      border-bottom: 2px solid #f0c75e;
    }
    .tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    .tab.active {
      border-color: #f0c75e;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    label {
      display: block;
      margin: 8px 0 3px;
    }
    input[type="text"],
    input[type="file"],
    select {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #f0c75e;
      background-color: #121c2c;
      color: #f0c75e;
    }
    .modal-buttons {
      text-align: center;
      margin-top: 20px;
    }
    .modal-buttons button {
      margin: 0 10px;
      min-width: 100px;
    }
    /* Paginacion */
    #paginacion {
      margin-top: 15px;
      text-align: center;
    }
    #paginacion button {
      margin: 0 5px;
      background-color: #444;
      color: #f0c75e;
      border-radius: 4px;
    }
    #paginacion button.active {
      background-color: #f0c75e;
      color: #121c2c;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>Gestión de Miembros</header>
  <div class="container">
    <button id="btn-abrir-form">Añadir Miembro</button>
    <table>
      <thead>
        <tr>
          <th>Foto</th>
          <th>Nombre</th>
          <th>Código</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-miembros"></tbody>
    </table>
    <div id="paginacion"></div>
  </div>

  <!-- Modal Formulario -->
  <div class="modal-bg" id="modal-form">
    <div class="modal">
      <h2 id="titulo-modal">Añadir Miembro</h2>
      <div class="tabs">
        <div class="tab active" data-tab="categoria1">Datos Personales</div>
        <div class="tab" data-tab="categoria2">Datos Familiares</div>
        <div class="tab" data-tab="categoria3">Datos Espirituales</div>
      </div>

      <form id="form-miembro" enctype="multipart/form-data">
        <!-- Categoria 1 -->
        <div class="tab-content active" id="categoria1">
          <label for="nombre">Nombre Completo</label>
          <input type="text" id="nombre" name="nombre" required />
          
          <label for="codigo">Código</label>
          <input type="text" id="codigo" name="codigo" required />

          <label for="foto">Foto</label>
          <input type="file" id="foto" name="foto" accept="image/*" />
        </div>

        <!-- Categoria 2 -->
        <div class="tab-content" id="categoria2">
          <label for="conyuge">Cónyuge</label>
          <input type="text" id="conyuge" name="conyuge" />

          <label for="hijos">Hijos</label>
          <input type="text" id="hijos" name="hijos" />
        </div>

        <!-- Categoria 3 -->
        <div class="tab-content" id="categoria3">
          <label for="bautizado">Bautizado</label>
          <select id="bautizado" name="bautizado">
            <option value="">Seleccione</option>
            <option value="sí">Sí</option>
            <option value="no">No</option>
          </select>

          <label for="ministerio">Ministerio</label>
          <input type="text" id="ministerio" name="ministerio" />
        </div>

        <div class="modal-buttons">
          <button type="submit" id="btn-guardar">Guardar</button>
          <button type="button" id="btn-cancelar">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Configuraciones
    const supabase = supabase.createClient('https://XXXX.supabase.co', 'public-anon-key');

    const firebaseConfig = {
      apiKey: "AIzaSyAyfPQzO7evryWcQ5d1lGV3z8aB-gFOh_k",
      authDomain: "iglesia-adoracion-viva.firebaseapp.com",
      databaseURL: "https://iglesia-adoracion-viva-default-rtdb.firebaseio.com",
      projectId: "iglesia-adoracion-viva",
      storageBucket: "iglesia-adoracion-viva.firebasestorage.app",
      messagingSenderId: "815332010058",
      appId: "1:815332010058:web:d2afff616469349d88deb3",
      measurementId: "G-43MZP6V55D"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Variables globales
    const ITEMS_POR_PAGINA = 20;
    let paginaActual = 1;
    let miembrosCache = [];
    let editarId = null; // null para nuevo, o id para editar

    // Cargar miembros con orden y paginación
    async function cargarMiembros() {
      const tabla = document.getElementById('tabla-miembros');
      tabla.innerHTML = '';
      try {
        const snapshot = await db.collection("miembros").orderBy("codigo").get();
        miembrosCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        paginaActual = 1;
        mostrarPagina(paginaActual);
        renderizarPaginacion();
      } catch (error) {
        console.error("Error al cargar miembros:", error);
      }
    }

    // Mostrar miembros de la página indicada
    function mostrarPagina(pagina) {
      const tabla = document.getElementById('tabla-miembros');
      tabla.innerHTML = '';
      const inicio = (pagina - 1) * ITEMS_POR_PAGINA;
      const fin = inicio + ITEMS_POR_PAGINA;
      const miembrosPagina = miembrosCache.slice(inicio, fin);

      miembrosPagina.forEach(data => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><img src="${data.fotoURL || 'https://via.placeholder.com/50'}" alt="foto" onerror="this.src='https://via.placeholder.com/50'"></td>
          <td>${data.nombre || ''}</td>
          <td>${data.codigo || ''}</td>
          <td>${data.estado || 'activo'}</td>
          <td>
            <button class="btn-editar" data-id="${data.id}">Editar</button>
            <button class="btn-cambiar-estado" data-id="${data.id}" data-estado="${data.estado}">
              ${data.estado === 'activo' ? 'Dar de baja' : 'Reactivar'}
            </button>
          </td>
        `;
        tabla.appendChild(tr);
      });

      // Asignar eventos a botones
      document.querySelectorAll('.btn-cambiar-estado').forEach(button => {
        button.onclick = () => {
          const id = button.getAttribute('data-id');
          const estadoActual = button.getAttribute('data-estado');
          cambiarEstado(id, estadoActual);
        };
      });
      document.querySelectorAll('.btn-editar').forEach(button => {
        button.onclick = () => {
          const id = button.getAttribute('data-id');
          cargarDatosEditar(id);
        };
      });
    }

    // Renderizar botones de paginación
    function renderizarPaginacion() {
      let paginacionDiv = document.getElementById('paginacion');
      if (!paginacionDiv) {
        paginacionDiv = document.createElement('div');
        paginacionDiv.id = 'paginacion';
        paginacionDiv.style.marginTop = '15px';
        paginacionDiv.style.textAlign = 'center';
        document.querySelector('.container').appendChild(paginacionDiv);
      }

      paginacionDiv.innerHTML = '';

      const totalPaginas = Math.ceil(miembrosCache.length / ITEMS_POR_PAGINA);

      for (let i = 1; i <= totalPaginas; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = i === paginaActual ? 'active' : '';
        btn.onclick = () => {
          paginaActual = i;
          mostrarPagina(paginaActual);
          renderizarPaginacion();
        };
        paginacionDiv.appendChild(btn);
      }
    }

    // Cambiar estado activo/baja
    async function cambiarEstado(id, estadoActual) {
      const nuevoEstado = estadoActual === 'activo' ? 'baja' : 'activo';
      try {
        await db.collection("miembros").doc(id).update({ estado: nuevoEstado });
        await cargarMiembros();
      } catch (error) {
        console.error("Error al cambiar estado:", error);
      }
    }

    // Modal y formulario
    const modal = document.getElementById('modal-form');
    const btnAbrirForm = document.getElementById('btn-abrir-form');
    const btnCancelar = document.getElementById('btn-cancelar');
    const formMiembro = document.getElementById('form-miembro');
    const tituloModal = document.getElementById('titulo-modal');

    // Tabs
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const target = tab.dataset.tab;
        tabContents.forEach(tc => {
          tc.classList.toggle('active', tc.id === target);
        });
      });
    });

    // Abrir modal para nuevo miembro
    btnAbrirForm.onclick = () => {
      editarId = null;
      tituloModal.textContent = "Añadir Miembro";
      formMiembro.reset();
      modal.classList.add('active');
      // Mostrar primera pestaña
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(tc => tc.classList.remove('active'));
      tabs[0].classList.add('active');
      tabContents[0].classList.add('active');
    };

    // Cerrar modal
    btnCancelar.onclick = () => {
      modal.classList.remove('active');
    };

    // Cargar datos para editar
    async function cargarDatosEditar(id) {
      try {
        const doc = await db.collection("miembros").doc(id).get();
        if (!doc.exists) {
          alert("No se encontró el miembro");
          return;
        }
        const data = doc.data();
        editarId = id;
        tituloModal.textContent = "Editar Miembro";

        formMiembro.nombre.value = data.nombre || '';
        formMiembro.codigo.value = data.codigo || '';
        formMiembro.conyuge.value = data.conyuge || '';
        formMiembro.hijos.value = data.hijos || '';
        formMiembro.bautizado.value = data.bautizado || '';
        formMiembro.ministerio.value = data.ministerio || '';
        // Nota: Foto no se rellena por seguridad. Si quiere cambiar debe subir archivo nuevo.

        modal.classList.add('active');
        // Mostrar primera pestaña al abrir modal
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(tc => tc.classList.remove('active'));
        tabs[0].classList.add('active');
        tabContents[0].classList.add('active');

      } catch (error) {
        console.error("Error al cargar datos para editar:", error);
      }
    }

    // Subir foto a Supabase Storage y devolver URL pública
    async function subirFoto(file, codigo) {
      if (!file) return null;
      const fileExt = file.name.split('.').pop();
      const fileName = `${codigo}.${fileExt}`;
      const filePath = `ftmember/${fileName}`;

      try {
        // Borrar foto previa si existe (opcional)
        await supabase.storage.from('ftmember').remove([filePath]);

        const { data, error } = await supabase.storage
          .from('ftmember')
          .upload(filePath, file, { upsert: true });

        if (error) {
          console.error('Error al subir foto:', error);
          return null;
        }

        // Obtener URL pública
        const { data: urlData } = supabase.storage.from('ftmember').getPublicUrl(filePath);
        return urlData.publicUrl;

      } catch (err) {
        console.error('Error en subirFoto:', err);
        return null;
      }
    }

    // Guardar o actualizar miembro
    formMiembro.onsubmit = async (e) => {
      e.preventDefault();

      const nombre = formMiembro.nombre.value.trim();
      const codigo = formMiembro.codigo.value.trim();
      const conyuge = formMiembro.conyuge.value.trim();
      const hijos = formMiembro.hijos.value.trim();
      const bautizado = formMiembro.bautizado.value;
      const ministerio = formMiembro.ministerio.value.trim();
      const estado = 'activo'; // al crear siempre activo

      // Validar campos obligatorios
      if (!nombre || !codigo) {
        alert("Debe completar nombre y código");
        return;
      }

      let fotoURL = null;
      const archivoFoto = formMiembro.foto.files[0];

      if (archivoFoto) {
        fotoURL = await subirFoto(archivoFoto, codigo);
        if (!fotoURL) {
          alert("Error al subir la foto");
          return;
        }
      } else if (editarId) {
        // Si es edición y no cambia la foto, conservar URL anterior
        const miembroEdit = miembrosCache.find(m => m.id === editarId);
        fotoURL = miembroEdit ? miembroEdit.fotoURL || null : null;
      }

      const datosMiembro = {
        nombre,
        codigo,
        conyuge,
        hijos,
        bautizado,
        ministerio,
        estado,
        fotoURL
      };

      try {
        if (editarId) {
          // Actualizar
          await db.collection("miembros").doc(editarId).update(datosMiembro);
        } else {
          // Nuevo
          // Verificar que no exista código duplicado
          const q = await db.collection("miembros").where("codigo", "==", codigo).get();
          if (!q.empty) {
            alert("Ya existe un miembro con ese código.");
            return;
          }
          await db.collection("miembros").add(datosMiembro);
        }
        modal.classList.remove('active');
        formMiembro.reset();
        await cargarMiembros();
      } catch (error) {
        console.error("Error al guardar miembro:", error);
        alert("Error al guardar. Revisa consola.");
      }
    };

    // Inicializar
    cargarMiembros();
  </script>
</body>
</html>