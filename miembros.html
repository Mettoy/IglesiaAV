<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Miembros</title>
  <link rel="icon" href="logo.png" type="image/png">
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background-color: #0b1f3a;
      color: white;
    }
    header {
      background-color: #0b1f3a;
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    header img {
      height: 40px;
    }
    .container {
      padding: 2rem;
    }
    .botones {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    button {
      background-color: #ffd700;
      border: none;
      padding: 0.5rem 1rem;
      color: #0b1f3a;
      font-weight: bold;
      cursor: pointer;
      border-radius: 5px;
      transition: 0.3s;
    }
    button:hover {
      background-color: #e6c200;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #122b4e;
    }
    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #1c3b67;
    }
    th {
      background-color: #0b1f3a;
    }
    img.preview {
      height: 50px;
      border-radius: 5px;
    }
    .formulario {
      background-color: #122b4e;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
    }
    input, select {
      width: 100%;
      padding: 0.5rem;
      margin: 0.5rem 0;
      border: none;
      border-radius: 5px;
    }
    .form-seccion {
      margin-bottom: 1.5rem;
    }
    .paginacion {
      text-align: center;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo">
    <h1>Gestión de Miembros</h1>
  </header>
  <div id="app" class="container">
    <div class="botones">
      <button @click="mostrarFormulario = !mostrarFormulario">Añadir miembro</button>
      <input type="text" v-model="busqueda" placeholder="Buscar miembro por nombre o código...">
    </div>

    <div v-if="mostrarFormulario" class="formulario">
      <div class="form-seccion">
        <h3>Datos personales</h3>
        <input v-model="nuevo.nombre" placeholder="Nombre completo">
        <input v-model="nuevo.codigo" placeholder="Código">
        <input v-model="nuevo.edad" placeholder="Edad" type="number">
        <input v-model="nuevo.telefono" placeholder="Teléfono">
        <input v-model="nuevo.direccion" placeholder="Dirección">
        <input v-model="nuevo.fechaNacimiento" type="date" placeholder="Fecha de nacimiento">
        <input type="file" @change="handleImagen" />
      </div>
      <div class="form-seccion">
        <h3>Datos familiares</h3>
        <input v-model="nuevo.familiarTipo" placeholder="Tipo de familiar">
        <input v-model="nuevo.familiarNombre" placeholder="Nombre del familiar">
      </div>
      <div class="form-seccion">
        <h3>Datos espirituales</h3>
        <input v-model="nuevo.fechaConversion" type="date" placeholder="Fecha de conversión">
        <input v-model="nuevo.lugarConversion" placeholder="Lugar de conversión">
        <input v-model="nuevo.fechaBautismo" type="date" placeholder="Fecha de bautismo">
        <input v-model="nuevo.lugarBautismo" placeholder="Lugar de bautismo">
      </div>
      <button @click="guardarMiembro">Guardar</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Foto</th>
          <th>Código</th>
          <th>Nombre</th>
          <th>Teléfono</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(m, i) in miembrosFiltrados" :key="i">
          <td><img class="preview" :src="m.fotoURL" alt="Foto" /></td>
          <td>{{ m.codigo }}</td>
          <td>{{ m.nombre }}</td>
          <td>{{ m.telefono }}</td>
          <td>
            <button @click="editarMiembro(m)">Editar</button>
            <button @click="darDeBaja(m)">Dar de baja</button>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="paginacion">
      <button @click="pagina--" :disabled="pagina === 1">Anterior</button>
      Página {{ pagina }}
      <button @click="pagina++" :disabled="finPaginacion">Siguiente</button>
    </div>
  </div>

  <script>
    const app = Vue.createApp({
      data() {
        return {
          supabase: null,
          db: null,
          miembros: [],
          nuevo: {},
          mostrarFormulario: false,
          imagenSeleccionada: null,
          busqueda: '',
          pagina: 1,
          porPagina: 20,
        }
      },
      computed: {
        miembrosFiltrados() {
          let resultado = this.miembros.filter(m => 
            m.nombre.toLowerCase().includes(this.busqueda.toLowerCase()) ||
            m.codigo.toLowerCase().includes(this.busqueda.toLowerCase())
          )
          resultado = resultado.sort((a, b) => a.codigo.localeCompare(b.codigo))
          return resultado.slice((this.pagina - 1) * this.porPagina, this.pagina * this.porPagina)
        },
        finPaginacion() {
          return this.pagina * this.porPagina >= this.miembros.length
        }
      },
      methods: {
        async initSupabase() {
          this.supabase = supabase.createClient(
            'https://xyptydnouyddzvrffaby.supabase.co',
            'seyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5cHR5ZG5vdXlkZHp2cmZmYWJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjY1ODUsImV4cCI6MjA2MzU0MjU4NX0.KGoyFjKsdI6N53QzNFJBPHfUGCGssHBSqfkPb4Q39-o'
          );
        },
        async initFirestore() {
          const firebaseConfig = {
            apiKey: "AIzaSyAhFOi7rQhuVauaNMTKqyLPFqwWPqkxb3U",
            authDomain: "iglesia-adoracion-viva-182e6.firebaseapp.com",
            projectId: "iglesia-adoracion-viva-182e6",
            storageBucket: "iglesia-adoracion-viva-182e6.appspot.com",
            messagingSenderId: "152824399391",
            appId: "1:152824399391:web:a4fc0937f35935b9b5f72a"
          };
          firebase.initializeApp(firebaseConfig);
          this.db = firebase.firestore();
          this.cargarMiembros();
        },
        handleImagen(e) {
          this.imagenSeleccionada = e.target.files[0];
        },
        async subirImagenYObtenerURL() {
          const file = this.imagenSeleccionada;
          const { data, error } = await this.supabase.storage.from('fotos').upload(`${Date.now()}_${file.name}`, file);
          if (error) throw error;
          const { publicURL } = this.supabase.storage.from('fotos').getPublicUrl(data.path);
          return publicURL;
        },
        async guardarMiembro() {
          const fotoURL = this.imagenSeleccionada ? await this.subirImagenYObtenerURL() : '';
          const datos = { ...this.nuevo, fotoURL };
          await this.db.collection('miembros').add(datos);
          this.nuevo = {};
          this.imagenSeleccionada = null;
          this.mostrarFormulario = false;
          this.cargarMiembros();
        },
        async cargarMiembros() {
          const snap = await this.db.collection('miembros').get();
          this.miembros = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        },
        editarMiembro(miembro) {
          this.nuevo = { ...miembro };
          this.mostrarFormulario = true;
        },
        async darDeBaja(miembro) {
          await this.db.collection('miembros_baja').add(miembro);
          await this.db.collection('miembros').doc(miembro.id).delete();
          this.cargarMiembros();
        }
      },
      mounted() {
        this.initSupabase();
        this.initFirestore();
      }
    });
    app.mount('#app');
  </script>
</body>
</html>
