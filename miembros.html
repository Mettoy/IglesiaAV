// ** Archivo: script.js (o el nombre de tu archivo JavaScript) **

// 1. Configuración de Firebase
// ¡IMPORTANTE! Reemplaza esto con tu propia configuración de Firebase.
// Puedes encontrar esto en tu consola de Firebase > Configuración del proyecto > Tus apps.
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// Inicializa Firebase
firebase.initializeApp(firebaseConfig);

// Obtén referencias a los servicios de Firebase
const db = firebase.firestore();
const firebaseStorage = firebase.storage(); // Referencia al servicio de Storage

// Variables globales para el manejo de miembros y paginación
let members = []; // Almacena todos los miembros obtenidos de Firestore
let filteredMembers = []; // Miembros después de aplicar filtros de búsqueda/estado
let currentPage = 1;
const pageSize = 10; // Número de miembros por página
let currentMemberStatusFilter = 'activo'; // Filtro inicial por defecto
let editingMemberId = null; // Para saber si estamos editando o añadiendo un nuevo miembro


// Variables para elementos DOM (se inicializarán en DOMContentLoaded)
let modalOverlay, modal, memberForm, fotoInput, fotoPreview, nombreInput, fechaNacimientoInput, edadInput,
    codigoInput, telefonoInput, direccionInput, emailInput, asociacionSelect, fechaMembresiaInput, statusSelect,
    nombreFamiliarInput, addFamiliarBtn, famList, estadoCivilSelect, nombreConyugeInput,
    fechaConversionInput, lugarConversionInput, fechaBautizoInput, lugarBautizoInput,
    fechaBautizoEspInput, lugarBautizoEspInput, cursosBiblicosInput, lugarCursosBiblicosInput,
    donesTalentosInput, areasServirInput, membersTableBody, searchInput, addMemberBtn,
    tabActivos, tabDeBaja, prevPageBtn, nextPageBtn, pageInfo; // Añadidos para paginación


document.addEventListener('DOMContentLoaded', () => {
    // 2. Obtener referencias a los elementos del DOM
    // Contenedores del Modal
    modalOverlay = document.getElementById('modalOverlay');
    modal = document.getElementById('modal');
    memberForm = document.getElementById('memberForm');
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('cancelBtn').addEventListener('click', closeModal);

    // Campos del formulario
    fotoInput = document.getElementById('fotoInput');
    fotoPreview = document.getElementById('fotoPreview');
    nombreInput = document.getElementById('nombreInput');
    fechaNacimientoInput = document.getElementById('fechaNacimientoInput');
    edadInput = document.getElementById('edadInput');
    codigoInput = document.getElementById('codigoInput');
    telefonoInput = document.getElementById('telefonoInput');
    direccionInput = document.getElementById('direccionInput');
    emailInput = document.getElementById('emailInput');
    asociacionSelect = document.getElementById('asociacionSelect');
    fechaMembresiaInput = document.getElementById('fechaMembresiaInput');
    statusSelect = document.getElementById('statusSelect');

    // Sección familiar
    nombreFamiliarInput = document.getElementById('nombreFamiliarInput');
    addFamiliarBtn = document.getElementById('addFamiliarBtn');
    famList = document.getElementById('fam-list');
    estadoCivilSelect = document.getElementById('estadoCivilSelect');
    nombreConyugeInput = document.getElementById('nombreConyugeInput');

    // Sección espiritual
    fechaConversionInput = document.getElementById('fechaConversionInput');
    lugarConversionInput = document.getElementById('lugarConversionInput');
    fechaBautizoInput = document.getElementById('fechaBautizoInput');
    lugarBautizoInput = document.getElementById('lugarBautizoInput');
    fechaBautizoEspInput = document.getElementById('fechaBautizoEspInput');
    lugarBautizoEspInput = document.getElementById('lugarBautizoEspInput');
    cursosBiblicosInput = document.getElementById('cursosBiblicosInput');
    lugarCursosBiblicosInput = document.getElementById('lugarCursosBiblicosInput');
    donesTalentosInput = document.getElementById('donesTalentosInput');
    areasServirInput = document.getElementById('areasServirInput');

    // Elementos de la tabla y controles principales
    membersTableBody = document.querySelector('#membersTable tbody');
    searchInput = document.getElementById('search');
    addMemberBtn = document.getElementById('addMemberBtnMain'); // Botón principal "Añadir Miembro"

    // Pestañas de estado de miembros
    tabActivos = document.getElementById('tabActivos');
    tabDeBaja = document.getElementById('tabDeBaja');

    // Elementos de paginación
    prevPageBtn = document.getElementById('prevPage');
    nextPageBtn = document.getElementById('nextPage');
    pageInfo = document.getElementById('pageInfo');

    // --- Event Listeners ---

    // Listener para previsualización de la foto
    fotoInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                fotoPreview.src = e.target.result;
                fotoPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            fotoPreview.src = '';
            fotoPreview.style.display = 'none';
        }
    });

    // Listener para cálculo de edad automático
    fechaNacimientoInput.addEventListener('change', () => {
        if (fechaNacimientoInput.value) {
            edadInput.value = calculateAge(fechaNacimientoInput.value);
        } else {
            edadInput.value = '';
        }
    });

    // Listener para añadir familiar
    addFamiliarBtn.addEventListener('click', () => {
        const familiarName = nombreFamiliarInput.value.trim();
        if (familiarName) {
            const div = document.createElement('div');
            div.innerHTML = `<span>${familiarName}</span><button type="button" class="remove-fam-btn">&times;</button>`;
            famList.appendChild(div);
            nombreFamiliarInput.value = ''; // Limpiar input

            div.querySelector('.remove-fam-btn').addEventListener('click', function() {
                this.parentElement.remove();
            });
        }
    });

    // Listener para el envío del formulario de miembro
    memberForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Validar campos obligatorios
        if (!nombreInput.value || !fechaNacimientoInput.value || !codigoInput.value || !asociacionSelect.value) {
            alert('Por favor, complete todos los campos obligatorios (Nombre, Fecha de Nacimiento, Código, Asociación).');
            return;
        }

        const memberData = {
            nombre: nombreInput.value,
            fechaNacimiento: fechaNacimientoInput.value,
            edad: edadInput.value,
            codigo: codigoInput.value,
            telefono: telefonoInput.value,
            direccion: direccionInput.value,
            email: emailInput.value,
            asociacion: asociacionSelect.value,
            fechaMembresia: fechaMembresiaInput.value,
            status: statusSelect.value,

            estadoCivil: estadoCivilSelect.value,
            nombreConyuge: nombreConyugeInput.value,
            familiares: Array.from(famList.children).map(li => li.querySelector('span').textContent),

            fechaConversion: fechaConversionInput.value,
            lugarConversion: lugarConversionInput.value,
            fechaBautizo: fechaBautizoInput.value,
            lugarBautizo: lugarBautizoInput.value,
            fechaBautizoEsp: fechaBautizoEspInput.value,
            lugarBautizoEsp: lugarBautizoEspInput.value,
            cursosBiblicos: cursosBiblicosInput.value,
            lugarCursosBiblicos: lugarCursosBiblicosInput.value,
            donesTalentos: donesTalentosInput.value,
            areasServir: areasServirInput.value,
            fotoUrl: '', // Se actualizará si se sube una foto
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        const fotoFile = fotoInput.files[0];
        let photoUrl = '';

        if (fotoFile) {
            try {
                const storageRef = firebaseStorage.ref();
                // Crea un nombre único para la foto
                const photoName = `${codigoInput.value}_${Date.now()}_${fotoFile.name}`;
                const photoRef = storageRef.child(`member_photos/${photoName}`);

                const uploadTask = photoRef.put(fotoFile);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload is ' + progress + '% done');
                        // Puedes mostrar el progreso al usuario aquí
                    },
                    (error) => {
                        console.error('Error al subir la foto:', error);
                        alert('Error al subir la foto. Inténtalo de nuevo.');
                        // Manejo de errores más robusto aquí
                    },
                    async () => {
                        photoUrl = await photoRef.getDownloadURL();
                        memberData.fotoUrl = photoUrl;
                        console.log('Foto subida, URL:', photoUrl);
                        // Guarda/actualiza el miembro solo DESPUÉS de obtener la URL de la foto
                        saveOrUpdateMember(memberData);
                    }
                );
            } catch (error) {
                console.error("Error en el proceso de carga de la foto:", error);
                alert("Hubo un error al procesar la foto.");
            }
        } else {
            // Si no se selecciona una nueva foto:
            // Si estamos editando, intenta mantener la foto existente
            if (editingMemberId) {
                const existingMember = members.find(m => m.id === editingMemberId);
                if (existingMember) {
                    memberData.fotoUrl = existingMember.fotoUrl || '';
                }
            }
            // Procede a guardar/actualizar sin cargar una nueva foto
            saveOrUpdateMember(memberData);
        }
    });

    // Listener para el botón principal de "Añadir Miembro"
    addMemberBtn.addEventListener('click', openAddMemberModal);

    // Listener para la barra de búsqueda
    searchInput.addEventListener('input', () => {
        currentPage = 1; // Reiniciar a la primera página en la búsqueda
        fetchMembers(currentMemberStatusFilter, searchInput.value);
    });

    // Listeners para las pestañas de estado
    tabActivos.addEventListener('click', () => {
        currentMemberStatusFilter = 'activo';
        tabActivos.classList.add('active');
        tabDeBaja.classList.remove('active');
        currentPage = 1;
        fetchMembers(currentMemberStatusFilter, searchInput.value);
    });

    tabDeBaja.addEventListener('click', () => {
        currentMemberStatusFilter = 'baja';
        tabDeBaja.classList.add('active');
        tabActivos.classList.remove('active');
        currentPage = 1;
        fetchMembers(currentMemberStatusFilter, searchInput.value);
    });

    // Listeners para botones de paginación (asegúrate de que existan en tu HTML)
    if (prevPageBtn) {
        prevPageBtn.addEventListener('click', () => {
            currentPage--;
            renderMembers();
            renderPagination();
        });
    }
    if (nextPageBtn) {
        nextPageBtn.addEventListener('click', () => {
            currentPage++;
            renderMembers();
            renderPagination();
        });
    }


    // --- Funciones Principales ---

    // Abre el modal para añadir un nuevo miembro
    function openAddMemberModal() {
        memberForm.reset();
        editingMemberId = null;
        document.getElementById('modalTitle').textContent = 'Añadir Miembro';
        fotoPreview.src = '';
        fotoPreview.style.display = 'none';
        famList.innerHTML = '';
        statusSelect.value = 'activo'; // Default status for new member

        showSection('personales'); // Mostrar la sección personal por defecto
        // Asegúrate de que solo la pestaña activa tenga la clase 'active'
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('.tab-btn[data-section="personales"]').classList.add('active');

        modalOverlay.style.display = 'flex';
    }

    // Cierra el modal
    function closeModal() {
        modalOverlay.style.display = 'none';
    }

    // Cambia la sección visible dentro del modal
    function showSection(sectionName) {
        document.querySelectorAll('.form-section').forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById(`${sectionName}-section`).style.display = 'block';

        document.querySelectorAll('.tab-btn').forEach(button => {
            button.classList.remove('active');
            button.setAttribute('aria-selected', 'false');
        });
        const activeTab = document.querySelector(`.tab-btn[data-section="${sectionName}"]`);
        if (activeTab) {
            activeTab.classList.add('active');
            activeTab.setAttribute('aria-selected', 'true');
        }
    }

    // Calcula la edad a partir de la fecha de nacimiento
    function calculateAge(dob) {
        const birthDate = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        return age;
    }

    // Guarda o actualiza un miembro en Firestore
    async function saveOrUpdateMember(memberData) {
        try {
            if (editingMemberId) {
                await db.collection('members').doc(editingMemberId).update(memberData);
                alert('Miembro actualizado correctamente.');
            } else {
                await db.collection('members').add(memberData);
                alert('Miembro añadido correctamente.');
            }
            closeModal();
            fetchMembers(); // Actualiza la tabla después de guardar
        } catch (error) {
            console.error("Error al guardar/actualizar miembro:", error);
            alert("Error al guardar el miembro. Revisa la consola.");
        }
    }

    // Obtiene los miembros de Firestore y los filtra/muestra
    async function fetchMembers(statusFilter = currentMemberStatusFilter, search = '') {
        membersTableBody.innerHTML = '<tr><td colspan="7">Cargando miembros...</td></tr>';
        try {
            let query = db.collection('members').where('status', '==', statusFilter);
            const snapshot = await query.orderBy('nombre').get();
            members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Filtro de búsqueda en el lado del cliente (Firestore no tiene buena búsqueda de texto completo)
            if (search) {
                const searchTerm = search.toLowerCase();
                filteredMembers = members.filter(member =>
                    (member.nombre && member.nombre.toLowerCase().includes(searchTerm)) ||
                    (member.codigo && member.codigo.toLowerCase().includes(searchTerm)) ||
                    (member.direccion && member.direccion.toLowerCase().includes(searchTerm)) ||
                    (member.asociacion && member.asociacion.toLowerCase().includes(searchTerm)) ||
                    (member.telefono && member.telefono.toLowerCase().includes(searchTerm)) ||
                    (member.email && member.email.toLowerCase().includes(searchTerm))
                );
            } else {
                filteredMembers = [...members];
            }

            renderMembers();
            renderPagination();

        } catch (error) {
            console.error("Error al obtener miembros:", error);
            membersTableBody.innerHTML = '<tr><td colspan="7">Error al cargar miembros.</td></tr>';
        }
    }

    // Renderiza los miembros en la tabla
    function renderMembers() {
        membersTableBody.innerHTML = '';
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const membersToDisplay = filteredMembers.slice(start, end);

        if (membersToDisplay.length === 0) {
            membersTableBody.innerHTML = '<tr><td colspan="7">No hay miembros para mostrar con el filtro actual.</td></tr>';
            return;
        }

        membersToDisplay.forEach(member => {
            const row = membersTableBody.insertRow();
            row.innerHTML = `
                <td><img src="${member.fotoUrl || 'https://via.placeholder.com/50'}" alt="Foto" class="photo-cell"></td>
                <td>${member.nombre}</td>
                <td>${member.codigo}</td>
                <td>${member.edad || calculateAge(member.fechaNacimiento) || 'N/A'}</td>
                <td>${member.direccion || 'N/A'}</td>
                <td>${member.asociacion || 'N/A'}</td>
                <td>
                    <button class="action-btn view-btn" data-id="${member.id}">Ver</button>
                    <button class="action-btn edit-btn" data-id="${member.id}">Editar</button>
                    <button class="action-btn delete-btn" data-id="${member.id}">Eliminar</button>
                    <button class="action-btn print-btn" data-id="${member.id}">Imprimir</button>
                </td>
            `;
        });

        // Adjuntar event listeners a los botones de acción de cada fila
        membersTableBody.querySelectorAll('.view-btn').forEach(button => {
            button.addEventListener('click', (e) => viewMember(e.target.dataset.id));
        });
        membersTableBody.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', (e) => editMember(e.target.dataset.id));
        });
        membersTableBody.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', (e) => deleteMember(e.target.dataset.id));
        });
        membersTableBody.querySelectorAll('.print-btn').forEach(button => {
            button.addEventListener('click', (e) => printMemberSheet(e.target.dataset.id));
        });
    }

    // Renderiza los controles de paginación
    function renderPagination() {
        const totalPages = Math.ceil(filteredMembers.length / pageSize);
        // Clear existing pagination elements
        if (prevPageBtn) prevPageBtn.remove();
        if (nextPageBtn) nextPageBtn.remove();
        if (pageInfo) pageInfo.remove();

        const paginationDiv = document.getElementById('pagination');
        if (!paginationDiv) return; // Exit if pagination div doesn't exist

        if (totalPages > 1) {
            prevPageBtn = document.createElement('button');
            prevPageBtn.id = 'prevPage';
            prevPageBtn.textContent = 'Anterior';
            prevPageBtn.disabled = currentPage === 1;
            prevPageBtn.addEventListener('click', () => {
                currentPage--;
                renderMembers();
                renderPagination();
            });
            paginationDiv.appendChild(prevPageBtn);

            pageInfo = document.createElement('span');
            pageInfo.id = 'pageInfo';
            pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
            paginationDiv.appendChild(pageInfo);

            nextPageBtn = document.createElement('button');
            nextPageBtn.id = 'nextPage';
            nextPageBtn.textContent = 'Siguiente';
            nextPageBtn.disabled = currentPage === totalPages;
            nextPageBtn.addEventListener('click', () => {
                currentPage++;
                renderMembers();
                renderPagination();
            });
            paginationDiv.appendChild(nextPageBtn);
        }
    }


    // Edita un miembro: abre el modal y precarga los datos
    async function editMember(id) {
        editingMemberId = id;
        document.getElementById('modalTitle').textContent = 'Editar Miembro';
        const doc = await db.collection('members').doc(id).get();
        if (doc.exists) {
            const data = doc.data();
            nombreInput.value = data.nombre || '';
            fechaNacimientoInput.value = data.fechaNacimiento || '';
            edadInput.value = data.edad || calculateAge(data.fechaNacimiento) || '';
            codigoInput.value = data.codigo || '';
            telefonoInput.value = data.telefono || '';
            direccionInput.value = data.direccion || '';
            emailInput.value = data.email || '';
            asociacionSelect.value = data.asociacion || '';
            fechaMembresiaInput.value = data.fechaMembresia || '';
            statusSelect.value = data.status || 'activo';

            if (data.fotoUrl) {
                fotoPreview.src = data.fotoUrl;
                fotoPreview.style.display = 'block';
            } else {
                fotoPreview.src = '';
                fotoPreview.style.display = 'none';
            }

            estadoCivilSelect.value = data.estadoCivil || '';
            nombreConyugeInput.value = data.nombreConyuge || '';
            famList.innerHTML = '';
            (data.familiares || []).forEach(fam => {
                const div = document.createElement('div');
                div.innerHTML = `<span>${fam}</span><button type="button" class="remove-fam-btn">&times;</button>`;
                famList.appendChild(div);
                div.querySelector('.remove-fam-btn').addEventListener('click', function() {
                    this.parentElement.remove();
                });
            });

            fechaConversionInput.value = data.fechaConversion || '';
            lugarConversionInput.value = data.lugarConversion || '';
            fechaBautizoInput.value = data.fechaBautizo || '';
            lugarBautizoInput.value = data.lugarBautizo || '';
            fechaBautizoEspInput.value = data.fechaBautizoEsp || '';
            lugarBautizoEspInput.value = data.lugarBautizoEsp || '';
            cursosBiblicosInput.value = data.cursosBiblicos || '';
            lugarCursosBiblicosInput.value = data.lugarCursosBiblicos || '';
            donesTalentosInput.value = data.donesTalentos || '';
            areasServirInput.value = data.areasServir || '';

            showSection('personales');
            modalOverlay.style.display = 'flex';
        } else {
            alert('Miembro no encontrado.');
        }
    }

    // Elimina un miembro (y opcionalmente su foto de Storage)
    async function deleteMember(id) {
        if (confirm('¿Estás seguro de que quieres eliminar a este miembro? Esta acción es irreversible.')) {
            try {
                const memberDoc = await db.collection('members').doc(id).get();
                if (memberDoc.exists && memberDoc.data().fotoUrl) {
                    const photoUrl = memberDoc.data().fotoUrl;
                    try {
                        const photoRef = firebaseStorage.refFromURL(photoUrl);
                        await photoRef.delete();
                        console.log("Foto eliminada de Storage.");
                    } catch (storageError) {
                        // Puede que la foto ya no exista o no se tenga permiso para eliminarla
                        console.warn("No se pudo eliminar la foto de Storage:", storageError);
                    }
                }

                await db.collection('members').doc(id).delete();
                alert('Miembro eliminado correctamente.');
                fetchMembers(); // Re-fetch para actualizar la tabla
            } catch (error) {
                console.error("Error al eliminar miembro:", error);
                alert("Error al eliminar el miembro. Revisa la consola.");
            }
        }
    }

    // Previsualiza los datos de un miembro para impresión (no lo imprime directamente)
    async function viewMember(id) {
        const doc = await db.collection('members').doc(id).get();
        if (doc.exists) {
            const data = doc.data();
            populatePrintArea(data); // Llena el área de impresión con los datos
            // Aquí puedes decidir si quieres mostrar un modal de "vista detallada"
            // Por ahora, solo lo prepara para la impresión.
            alert("Miembro listo para previsualización de impresión. Usa el botón 'Imprimir' para ver el diseño.");
        } else {
            alert('Miembro no encontrado para visualizar.');
        }
    }

    // Llena el área oculta de impresión con los datos del miembro
    function populatePrintArea(memberData) {
        document.getElementById('print-nombreCompleto').textContent = memberData.nombre || 'N/A';
        document.getElementById('print-fechaNacimiento').textContent = memberData.fechaNacimiento || 'N/A';
        document.getElementById('print-edad').textContent = memberData.edad || calculateAge(memberData.fechaNacimiento) || 'N/A';
        document.getElementById('print-codigo').textContent = memberData.codigo || 'N/A';
        document.getElementById('print-telefono').textContent = memberData.telefono || 'N/A';
        document.getElementById('print-email').textContent = memberData.email || 'N/A';
        document.getElementById('print-direccion').textContent = memberData.direccion || 'N/A';
        document.getElementById('print-asociacion').textContent = memberData.asociacion || 'N/A';
        document.getElementById('print-fechaMembresia').textContent = memberData.fechaMembresia || 'N/A';
        document.getElementById('print-status').textContent = (memberData.status === 'activo' ? 'Activo' : 'De Baja') || 'N/A';

        const printFotoMiembro = document.getElementById('print-fotoMiembro');
        if (memberData.fotoUrl) {
            printFotoMiembro.src = memberData.fotoUrl;
            printFotoMiembro.style.display = 'block';
        } else {
            printFotoMiembro.src = 'https://via.placeholder.com/130';
            printFotoMiembro.style.display = 'block';
        }

        document.getElementById('print-estadoCivil').textContent = memberData.estadoCivil || 'N/A';
        document.getElementById('print-nombreConyuge').textContent = memberData.nombreConyuge || 'N/A';

        const printFamiliaresList = document.getElementById('print-familiaresList');
        printFamiliaresList.innerHTML = '';
        if (memberData.familiares && memberData.familiares.length > 0) {
            memberData.familiares.forEach(fam => {
                const span = document.createElement('span');
                span.textContent = fam;
                printFamiliaresList.appendChild(span);
            });
        } else {
            printFamiliaresList.textContent = 'No hay familiares registrados.';
        }

        document.getElementById('print-fechaConversion').textContent = memberData.fechaConversion || 'N/A';
        document.getElementById('print-lugarConversion').textContent = memberData.lugarConversion || 'N/A';
        document.getElementById('print-fechaBautizo').textContent = memberData.fechaBautizo || 'N/A';
        document.getElementById('print-lugarBautizo').textContent = memberData.lugarBautizo || 'N/A';
        document.getElementById('print-fechaBautizoEsp').textContent = memberData.fechaBautizoEsp || 'N/A';
        document.getElementById('print-lugarBautizoEsp').textContent = memberData.lugarBautizoEsp || 'N/A';
        document.getElementById('print-cursosBiblicos').textContent = memberData.cursosBiblicos || 'N/A';
        document.getElementById('print-lugarCursosBiblicos').textContent = memberData.lugarCursosBiblicos || 'N/A';
        document.getElementById('print-donesTalentos').textContent = memberData.donesTalentos || 'N/A';
        document.getElementById('print-areasServir').textContent = memberData.areasServir || 'N/A';
    }

    // Imprime la ficha del miembro
    async function printMemberSheet(id) {
        const doc = await db.collection('members').doc(id).get();
        if (doc.exists) {
            const data = doc.data();
            populatePrintArea(data); // Llena el área oculta de impresión
            window.print(); // Activa el diálogo de impresión del navegador
        } else {
            alert('Miembro no encontrado para imprimir.');
        }
    }


    // --- Funcionalidades adicionales (placeholders) ---

    // Función para cerrar sesión (necesita Firebase Authentication)
    window.cerrarSesion = function() {
        // Aquí iría la lógica de firebase.auth().signOut()
        alert('Sesión cerrada. (Funcionalidad de autenticación real no implementada en este ejemplo)');
        // window.location.href = 'login.html'; // Redirigir a tu página de login
    };

    // Función para ir a la página de inicio/dashboard (si la tienes)
    document.getElementById('btnInicio').addEventListener('click', () => {
        alert('Redirigiendo a Inicio. (Funcionalidad no implementada en este ejemplo)');
        // window.location.href = 'dashboard.html'; // Redirigir a tu dashboard
    });

    // --- Carga Inicial ---
    fetchMembers(); // Carga los miembros al iniciar la página
});
