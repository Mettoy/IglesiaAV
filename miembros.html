<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión de Miembros</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      background-color: #f5f6fa;
      font-family: "Segoe UI", sans-serif;
    }
    .sidebar {
      background-color: #001f3f;
      color: white;
      width: 250px;
      min-height: 100vh;
      position: fixed;
      transition: all 0.3s ease;
    }
    .sidebar img {
      width: 80%;
      margin: 20px auto;
      display: block;
      border-radius: 10px;
    }
    .sidebar a {
      display: block;
      color: white;
      padding: 15px 20px;
      text-decoration: none;
    }
    .sidebar a:hover {
      background-color: #ffcc00;
      color: black;
    }
    .logout {
      padding: 15px 20px;
      cursor: pointer;
      color: white;
    }
    .content {
      margin-left: 250px;
      padding: 20px;
    }
    .btn-add {
      background-color: #ffcc00;
      color: black;
      font-weight: bold;
      border: none;
    }
    .form-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }
    th {
      background-color: #001f3f;
      color: white;
    }
    td img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }
    .btn-action {
      background-color: #ffcc00;
      border: none;
      color: black;
      padding: 5px 10px;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <img
      id="logo"
      src="https://azywyqozwwbfctxeokug.supabase.co/storage/v1/object/public/logos//images%20(1).png"
      alt="Logo"
      onclick="cambiarLogo()"
    />
    <div class="user-info" id="userInfo"></div>
    <div id="menuLinks"></div>
    <a href="miembros.html" class="sidebar-link">Miembros</a>
    <a href="registrar.html" class="sidebar-link">Dar acceso</a>
    <a href="diezmó.html" class="sidebar-link">Diezmos</a>
    <a href="ofrendas.html" class="sidebar-link">Ofrendas</a>
    <a href="reportes.html" class="sidebar-link">Reportess</a>
    <a href="discipulado.html" class="sidebar-link">Discipulado</a>
    <div class="logout" onclick="cerrarSesion()">Cerrar sesión</div>
  </div>

  <!-- Content -->
  <div class="content">
    <h2>Gestión de Miembros</h2>
    <div class="text-center">
      <button class="btn btn-add" onclick="toggleForm()">+ Agregar miembro</button>
    </div>

    <!-- Formulario -->
    <div class="form-card" id="formulario" style="display: none">
      <ul class="nav nav-tabs" id="tabForm" role="tablist">
        <li class="nav-item">
          <button
            class="nav-link active"
            data-bs-toggle="tab"
            data-bs-target="#personales"
            type="button"
          >
            Personales
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            data-bs-toggle="tab"
            data-bs-target="#familiares"
            type="button"
          >
            Familiares
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            data-bs-toggle="tab"
            data-bs-target="#espirituales"
            type="button"
          >
            Espirituales
          </button>
        </li>
      </ul>
      <div class="tab-content pt-3">
        <!-- PERSONALES -->
        <div class="tab-pane fade show active" id="personales">
          <input
            class="form-control mb-2"
            id="nombre"
            placeholder="Nombre completo"
          />
          <input class="form-control mb-2" id="codigo" placeholder="Código" />
          <input
            class="form-control mb-2"
            id="telefono"
            placeholder="Teléfono"
          />
          <input
            class="form-control mb-2"
            id="edad"
            type="number"
            placeholder="Edad"
          />
          <input
            class="form-control mb-2"
            id="cumple"
            type="date"
            placeholder="Cumpleaños"
          />
          <input
            class="form-control mb-2"
            id="direccion"
            placeholder="Dirección"
          />
          <label class="form-label mt-2">Foto del miembro:</label>
          <input
            class="form-control mb-2"
            type="file"
            id="foto"
            accept="image/*"
          />
        </div>

        <!-- FAMILIARES -->
        <div class="tab-pane fade" id="familiares">
          <select class="form-select mb-2" id="relacion">
            <option>Conyugue</option>
            <option>Papá</option>
            <option>Mamá</option>
            <option>Hermano/a</option>
          </select>
          <input
            class="form-control mb-2"
            id="nombreFamiliar"
            placeholder="Nombre del familiar"
          />
        </div>

        <!-- ESPIRITUALES -->
        <div class="tab-pane fade" id="espirituales">
          <input
            class="form-control mb-2"
            id="conversion"
            placeholder="Conversión"
          />
          <input
            class="form-control mb-2"
            id="bautismo"
            placeholder="Bautismo en Agua"
          />
          <input
            class="form-control mb-2"
            id="bautismoEsp"
            placeholder="Bautismo Espíritu Santo"
          />
          <input
            class="form-control mb-2"
            id="fechaBautismoEsp"
            type="date"
            placeholder="Fecha BA. Esp."
          />
          <input
            class="form-control mb-2"
            id="ubicacionBautismo"
            placeholder="Ubicación BA. Esp."
          />
        </div>
      </div>
      <div class="text-center mt-3">
        <button class="btn btn-add" onclick="guardarMiembro()">Guardar miembro</button>
      </div>
    </div>

    <!-- Tabla -->
    <table class="table table-bordered table-striped mt-4">
      <thead>
        <tr>
          <th>Foto</th>
          <th>Nombre</th>
          <th>Código</th>
          <th>Edad</th>
          <th>Teléfono</th>
          <th>Dirección</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaMiembros"></tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAhFOi7rQhuVauaNMTKqyLPFqwWPqkxb3U",
      authDomain: "iglesia-adoracion-viva-182e6.firebaseapp.com",
      projectId: "iglesia-adoracion-viva-182e6",
      storageBucket: "iglesia-adoracion-viva-182e6.appspot.com",
      messagingSenderId: "152824399391",
      appId: "1:152824399391:web:a4fc0937f35935b9b5f72a",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Supabase client
    const supabase = supabase.createClient(
      "https://azywyqozwwbfctxeokug.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwczovL3N1cGFiYXNlLmNvbS9hdXRoL3VzZXJJZCI6IjYxMGY4ZjZjLTYxYzctNDQ1Zi05MTg0LTg3Y2EyOTMxZmQxNiIsImlhdCI6MTY4Nzk1NjYxMywiZXhwIjoxOTAzNTEyNjEzfQ.sCSeHMDv8T7N6W_C-A1tx0hYFvJltqH_gNWgaxExoGM"
);
    let editId = null;

function toggleForm() {
  const form = document.getElementById("formulario");
  if (form.style.display === "none") {
    form.style.display = "block";
  } else {
    form.style.display = "none";
    limpiarFormulario();
  }
}

async function subirFoto(file) {
  const nombreArchivo = `${Date.now()}_${file.name}`;
  try {
    const { error } = await supabase.storage
      .from("fotos")
      .upload(nombreArchivo, file, { upsert: true });
    if (error) throw error;
  } catch (error) {
    alert("Error al subir la foto: " + error.message);
    throw error;
  }
  const { data: urlData } = supabase.storage
    .from("fotos")
    .getPublicUrl(nombreArchivo);
  return urlData.publicUrl;
}

async function guardarMiembro() {
  try {
    const nombre = document.getElementById("nombre").value;
    const codigo = document.getElementById("codigo").value;
    const telefono = document.getElementById("telefono").value;
    const edad = Number(document.getElementById("edad").value);
    const cumple = document.getElementById("cumple").value;
    const direccion = document.getElementById("direccion").value;
    const relacion = document.getElementById("relacion").value;
    const nombreFamiliar = document.getElementById("nombreFamiliar").value;
    const conversion = document.getElementById("conversion").value;
    const bautismo = document.getElementById("bautismo").value;
    const bautismoEsp = document.getElementById("bautismoEsp").value;
    const fechaBautismoEsp = document.getElementById("fechaBautismoEsp").value;
    const ubicacionBautismo = document.getElementById("ubicacionBautismo").value;

    let fotoUrl = "";
    const inputFoto = document.getElementById("foto");
    if (inputFoto.files.length > 0) {
      fotoUrl = await subirFoto(inputFoto.files[0]);
    } else if (editId) {
      fotoUrl = miembros.find((m) => m.id === editId)?.foto || "";
    }

    const miembroData = {
      nombre,
      codigo,
      telefono,
      edad,
      cumple,
      direccion,
      relacion,
      nombreFamiliar,
      conversion,
      bautismo,
      bautismoEsp,
      fechaBautismoEsp,
      ubicacionBautismo,
      foto: fotoUrl,
    };

    if (editId) {
      await db.collection("miembros").doc(editId).set(miembroData);
      editId = null;
    } else {
      await db.collection("miembros").add(miembroData);
    }

    limpiarFormulario();
    document.getElementById("formulario").style.display = "none";
    cargarMiembros();
  } catch (error) {
    alert("Error al guardar: " + error.message);
  }
}

function limpiarFormulario() {
  const campos = [
    "nombre",
    "codigo",
    "telefono",
    "edad",
    "cumple",
    "direccion",
    "nombreFamiliar",
    "conversion",
    "bautismo",
    "bautismoEsp",
    "fechaBautismoEsp",
    "ubicacionBautismo",
  ];
  campos.forEach((c) => (document.getElementById(c).value = ""));
  document.getElementById("relacion").selectedIndex = 0;
  document.getElementById("foto").value = "";
  editId = null;
}

let miembros = [];

async function cargarMiembros() {
  const snapshot = await db.collection("miembros").get();
  miembros = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
  mostrarMiembros();
}

function mostrarMiembros() {
  const tbody = document.getElementById("tablaMiembros");
  tbody.innerHTML = "";
  miembros.forEach((miembro) => {
    const tr = document.createElement("tr");

    // Foto
    const tdFoto = document.createElement("td");
    const img = document.createElement("img");
    img.src = miembro.foto || "https://via.placeholder.com/60";
    img.alt = "Foto miembro";
    tdFoto.appendChild(img);
    tr.appendChild(tdFoto);

    // Otros campos
    tr.innerHTML += `
      <td>${miembro.nombre}</td>
      <td>${miembro.codigo}</td>
      <td>${miembro.edad}</td>
      <td>${miembro.telefono}</td>
      <td>${miembro.direccion}</td>
    `;

    // Acciones
    const tdAcciones = document.createElement("td");
    const btnEditar = document.createElement("button");
    btnEditar.classList.add("btn-action");
    btnEditar.textContent = "Editar";
    btnEditar.onclick = () => editarMiembro(miembro.id);
    tdAcciones.appendChild(btnEditar);
    tr.appendChild(tdAcciones);

    tbody.appendChild(tr);
  });
}

function editarMiembro(id) {
  const miembro = miembros.find((m) => m.id === id);
  if (!miembro) return alert("Miembro no encontrado");

  toggleForm();

  document.getElementById("nombre").value = miembro.nombre || "";
  document.getElementById("codigo").value = miembro.codigo || "";
  document.getElementById("telefono").value = miembro.telefono || "";
  document.getElementById("edad").value = miembro.edad || "";
  document.getElementById("cumple").value = miembro.cumple || "";
  document.getElementById("direccion").value = miembro.direccion || "";
  document.getElementById("relacion").value = miembro.relacion || "Conyugue";
  document.getElementById("nombreFamiliar").value = miembro.nombreFamiliar || "";
  document.getElementById("conversion").value = miembro.conversion || "";
  document.getElementById("bautismo").value = miembro.bautismo || "";
  document.getElementById("bautismoEsp").value = miembro.bautismoEsp || "";
  document.getElementById("fechaBautismoEsp").value = miembro.fechaBautismoEsp || "";
  document.getElementById("ubicacionBautismo").value = miembro.ubicacionBautismo || "";

  // No se puede precargar el input file por seguridad, si quieres cambiar la foto hay que subir otra

  editId = id;
}

// Inicializar
cargarMiembros();

// Funciones sidebar placeholder
function cambiarLogo() {
  alert("Función cambiar logo no implementada.");
}
function cerrarSesion() {
  alert("Función cerrar sesión no implementada.");
}

