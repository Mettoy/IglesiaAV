<!-- CONTINÚA DESDE "Datos Familiares" -->
        <select id="familyType">
          <option value="">Seleccionar</option>
          <option value="Padre">Padre</option>
          <option value="Madre">Madre</option>
          <option value="Hermano(a)">Hermano(a)</option>
          <option value="Esposo(a)">Esposo(a)</option>
          <option value="Hijo(a)">Hijo(a)</option>
          <option value="Otro">Otro</option>
        </select>
        </label>
        <label>Nombre del Familiar
          <input type="text" id="familyName" />
        </label>
        <button type="button" id="btnAddFamily">Agregar Familiar</button>
        <div id="familyList"></div>
      </div>

      <!-- Datos Espirituales -->
      <div class="form-category">
        <h2>Datos Espirituales</h2>
        <label>Fecha de Conversión
          <input type="date" id="conversionDate" />
        </label>
        <label>Lugar de Conversión
          <input type="text" id="conversionPlace" />
        </label>
        <label>Fecha de Bautismo
          <input type="date" id="baptismDate" />
        </label>
        <label>Lugar de Bautismo
          <input type="text" id="baptismPlace" />
        </label>
        <label>Fecha de Bautismo en el Espíritu
          <input type="date" id="spiritBaptismDate" />
        </label>
        <label>Lugar de Bautismo en el Espíritu
          <input type="text" id="spiritBaptismPlace" />
        </label>
      </div>

      <div id="modalButtons">
        <button type="button" id="btnCancel">Cancelar</button>
        <button type="submit" id="btnSave">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
// Import Firebase y Supabase (usar CDN)
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// --- CONFIGURACIÓN FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyAhFOi7rQhuVauaNMTKqyLPFqwWPqkxb3U",
  authDomain: "iglesia-adoracion-viva-182e6.firebaseapp.com",
  projectId: "iglesia-adoracion-viva-182e6",
  storageBucket: "iglesia-adoracion-viva-182e6.appspot.com",
  messagingSenderId: "152824399391",
  appId: "1:152824399391:web:a4fc0937f35935b9b5f72a",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const membersCol = collection(db, "miembros");

// --- CONFIGURACIÓN SUPABASE ---
const SUPABASE_URL = "https://azywyqozwwbfctxeokug.supabase.co";
const SUPABASE_ANON_KEY = "eneyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6eXd5cW96d3diZmN0eGVva3VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNzM1NjAsImV4cCI6MjA2MjY0OTU2MH0.tzJiz2LKQcVTb94uncIrGMfi4NV9XwR7xR6lzP3EELk";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- VARIABLES GLOBALES ---
let members = [];       // Lista completa de miembros desde Firestore
let filteredMembers = []; // Lista filtrada por búsqueda
let currentPage = 1;
const pageSize = 20;
let editingMemberId = null;
let familyArray = [];

// --- ELEMENTOS DOM ---
const btnAddMember = document.getElementById("btnAddMember");
const modalBg = document.getElementById("modalFormBg");
const modalTitle = document.getElementById("modalTitle");
const memberForm = document.getElementById("memberForm");
const btnCancel = document.getElementById("btnCancel");
const btnSave = document.getElementById("btnSave");
const membersTableBody = document.getElementById("membersTableBody");
const searchInput = document.getElementById("searchInput");
const pageNumberInput = document.getElementById("pageNumber");
const btnPrev = document.getElementById("btnPrev");
const btnNext = document.getElementById("btnNext");
const familyTypeSelect = document.getElementById("familyType");
const familyNameInput = document.getElementById("familyName");
const btnAddFamily = document.getElementById("btnAddFamily");
const familyListDiv = document.getElementById("familyList");
const photoInput = document.getElementById("photo");
const previewPhoto = document.getElementById("previewPhoto");

// --- FUNCIONES ---

// Mostrar modal (nuevo o editar)
function openModal(edit = false) {
  modalBg.style.display = "flex";
  familyArray = [];
  familyListDiv.innerHTML = "";
  previewPhoto.style.display = "none";
  photoInput.value = "";
  if (edit) {
    modalTitle.textContent = "Editar Miembro";
  } else {
    modalTitle.textContent = "Añadir Miembro";
    memberForm.reset();
    editingMemberId = null;
  }
}

// Cerrar modal
function closeModal() {
  modalBg.style.display = "none";
  editingMemberId = null;
  familyArray = [];
}

// Agregar familiar a la lista
btnAddFamily.addEventListener("click", () => {
  const tipo = familyTypeSelect.value.trim();
  const nombre = familyNameInput.value.trim();
  if (!tipo) return alert("Selecciona el tipo de familiar");
  if (!nombre) return alert("Ingresa el nombre del familiar");
  familyArray.push({ tipo, nombre });
  renderFamilyList();
  familyNameInput.value = "";
  familyTypeSelect.value = "";
});

function renderFamilyList() {
  familyListDiv.innerHTML = "";
  familyArray.forEach(({ tipo, nombre }, i) => {
    const span = document.createElement("span");
    span.textContent = `${tipo}: ${nombre} ×`;
    span.style.cursor = "pointer";
    span.title = "Eliminar familiar";
    span.onclick = () => {
      familyArray.splice(i, 1);
      renderFamilyList();
    };
    familyListDiv.appendChild(span);
  });
}

// Preview foto seleccionada
photoInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) {
    previewPhoto.style.display = "none";
    previewPhoto.src = "";
    return;
  }
  const url = URL.createObjectURL(file);
  previewPhoto.src = url;
  previewPhoto.style.display = "block";
});

// Cargar miembros desde Firestore (ordenado por código)
async function loadMembers() {
  members = [];
  const q = query(membersCol, orderBy("code"));
  const querySnapshot = await getDocs(q);
  querySnapshot.forEach(docSnap => {
    members.push({ id: docSnap.id, ...docSnap.data() });
  });
  filteredMembers = [...members];
  currentPage = 1;
  renderTable();
  updatePaginationControls();
}

// Renderizar tabla según página y filtro
function renderTable() {
  membersTableBody.innerHTML = "";
  if (filteredMembers.length === 0) {
    membersTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px;">No hay miembros para mostrar</td></tr>`;
    return;
  }
  const start = (currentPage -1) * pageSize;
  const end = start + pageSize;
  const pageMembers = filteredMembers.slice(start, end);

  pageMembers.forEach(member => {
    const tr = document.createElement("tr");

    // Foto
    const tdPhoto = document.createElement("td");
    const img = document.createElement("img");
    img.className = "member-photo";
    img.src = member.photoURL || "https://via.placeholder.com/40?text=Foto";
    img.alt = "Foto";
    tdPhoto.appendChild(img);
    tr.appendChild(tdPhoto);

    // Nombre con foto alineado
    const tdName = document.createElement("td");
    tdName.textContent = member.fullName || "";
    tr.appendChild(tdName);

    // Código
    const tdCode = document.createElement("td");
    tdCode.textContent = member.code || "";
    tr.appendChild(tdCode);

    // Edad
    const tdAge = document.createElement("td");
    tdAge.textContent = member.age || "";
    tr.appendChild (tdAge);
    // Teléfono
const tdPhone = document.createElement("td");
tdPhone.textContent = member.phone || "";
tr.appendChild(tdPhone);

// Dirección
const tdAddress = document.createElement("td");
tdAddress.textContent = member.address || "";
tr.appendChild(tdAddress);

// Botones Editar y Dar de Baja
const tdActions = document.createElement("td");
tdActions.className = "actions";

const btnEdit = document.createElement("button");
btnEdit.className = "btnEdit";
btnEdit.textContent = "Editar";
btnEdit.onclick = () => editMember(member.id);
tdActions.appendChild(btnEdit);

const btnDelete = document.createElement("button");
btnDelete.className = "btnDelete";
btnDelete.textContent = "Dar de baja";
btnDelete.onclick = () => deleteMember(member.id);
tdActions.appendChild(btnDelete);

tr.appendChild(tdActions);
membersTableBody.appendChild(tr);
});
}

// Actualizar controles paginación
function updatePaginationControls() {
pageNumberInput.value = currentPage;
btnPrev.disabled = currentPage === 1;
btnNext.disabled = currentPage * pageSize >= filteredMembers.length;
}

// Cambiar página
btnPrev.onclick = () => {
if (currentPage > 1) {
currentPage--;
renderTable();
updatePaginationControls();
}
};
btnNext.onclick = () => {
if (currentPage * pageSize < filteredMembers.length) {
currentPage++;
renderTable();
updatePaginationControls();
}
};
pageNumberInput.onchange = () => {
let page = parseInt(pageNumberInput.value);
if (isNaN(page) || page < 1) page = 1;
if (page > Math.ceil(filteredMembers.length / pageSize)) {
page = Math.ceil(filteredMembers.length / pageSize);
}
currentPage = page;
renderTable();
updatePaginationControls();
};

// Buscar miembros (filtrado)
searchInput.addEventListener("input", () => {
const term = searchInput.value.trim().toLowerCase();
if (!term) {
filteredMembers = [...members];
} else {
filteredMembers = members.filter(m =>
(m.fullName && m.fullName.toLowerCase().includes(term)) ||
(m.code && m.code.toLowerCase().includes(term)) ||
(m.phone && m.phone.toLowerCase().includes(term))
);
}
currentPage = 1;
renderTable();
updatePaginationControls();
});

// Editar miembro: cargar datos al formulario
async function editMember(id) {
const docRef = doc(db, "miembros", id);
const docSnap = await getDocs(collection(db, "miembros"));
// Buscar en members array para no hacer doble petición
const member = members.find(m => m.id === id);
if (!member) return alert("Miembro no encontrado");
editingMemberId = id;
openModal(true);

// Llenar formulario con datos
document.getElementById("fullName").value = member.fullName || "";
document.getElementById("code").value = member.code || "";
document.getElementById("age").value = member.age || "";
document.getElementById("phone").value = member.phone || "";
document.getElementById("address").value = member.address || "";
document.getElementById("birthDate").value = member.birthDate || "";

familyArray = member.family || [];
renderFamilyList();

document.getElementById("conversionDate").value = member.conversionDate || "";
document.getElementById("conversionPlace").value = member.conversionPlace || "";
document.getElementById("baptismDate").value = member.baptismDate || "";
document.getElementById("baptismPlace").value = member.baptismPlace || "";
document.getElementById("spiritBaptismDate").value = member.spiritBaptismDate || "";
document.getElementById("spiritBaptismPlace").value = member.spiritBaptismPlace || "";

if (member.photoURL) {
previewPhoto.src = member.photoURL;
previewPhoto.style.display = "block";
} else {
previewPhoto.style.display = "none";
previewPhoto.src = "";
}
}

// Eliminar miembro (dar de baja)
async function deleteMember(id) {
if (!confirm("¿Seguro que desea dar de baja a este miembro? Esta acción no se puede deshacer.")) return;
try {
await deleteDoc(doc(db, "miembros", id));
alert("Miembro eliminado correctamente");
await loadMembers();
} catch (error) {
console.error("Error eliminando miembro: ", error);
alert("Error al eliminar el miembro");
}
}

// Guardar o actualizar miembro
memberForm.addEventListener("submit", async (e) => {
e.preventDefault();

btnSave.disabled = true;
btnSave.textContent = "Guardando...";

try {
const fullName = document.getElementById("fullName").value.trim();
const code = document.getElementById("code").value.trim();
const age = document.getElementById("age").value.trim();
const phone = document.getElementById("phone").value.trim();
const address = document.getElementById("address").value.trim();
const birthDate = document.getElementById("birthDate").value;
const conversionDate = document.getElementById("conversionDate").value;
const conversionPlace = document.getElementById("conversionPlace").value.trim();
const baptismDate = document.getElementById("baptismDate").value;
const baptismPlace = document.getElementById("baptismPlace").value.trim();
const spiritBaptismDate = document.getElementById("spiritBaptismDate").value;
const spiritBaptismPlace = document.getElementById("spiritBaptismPlace").value.trim();

// Validar datos básicos
if (!fullName || !code) {
  alert("Por favor, complete los campos Nombre completo y Código.");
  btnSave.disabled = false;
  btnSave.textContent = "Guardar";
  return;
}

// Subir foto a Supabase si hay archivo nuevo seleccionado
let photoURL = "";
if (photoInput.files.length > 0) {
  const file = photoInput.files[0];
  const fileExt = file.name.split('.').pop();
  const fileName = `${code}_${Date.now()}.${fileExt}`;
  const { data, error } = await supabase.storage
    .from("fotos")
    .upload(fileName, file, { upsert: true });
  if (error) {
    console.error("Error al subir la foto:", error);
    alert("Error al subir la foto.");
    btnSave.disabled = false;
    btnSave.textContent = "Guardar";
    return;
  }
  // Obtener URL pública
  const { data: publicURL } = supabase.storage
    .from("fotos")
    .getPublicUrl(fileName);
  photoURL = publicURL.publicUrl;
} else if (editingMemberId) {
  // Mantener la URL anterior si no cambió la foto
  const member = members.find(m => m.id === editingMemberId);
  if (member) photoURL = member.photoURL || "";
}

const memberData = {
  fullName,
  code,
  age,
  phone,
  address,
  birthDate,
  family: familyArray,
  conversionDate,
  conversionPlace,
  baptismDate,
  baptismPlace,
  spiritBaptismDate,
  spiritBaptismPlace,
  photoURL,
  updatedAt: new Date().toISOString(),
};

if (editingMemberId) {
  // Actualizar documento Firestore
  const docRef = doc(db, "miembros", editingMemberId);
  await updateDoc(docRef, memberData);
  alert("Miembro actualizado correctamente");
} else {
  // Nuevo documento Firestore
  memberData.createdAt = new Date().toISOString();
  await addDoc(membersCol, memberData);
  alert("Miembro agregado correctamente");
}

closeModal();
await loadMembers();
} catch (error) {
console.error("Error guardando miembro:", error);
alert("Error al guardar el miembro.");
} finally {
btnSave.disabled = false;
btnSave.textContent = "Guardar";
}
});

// Botones abrir/cerrar modal
btnAddMember.onclick = () => openModal(false);
btnCancel.onclick = closeModal;

// Cargar miembros al iniciar
loadMembers();

</script>
</body>
</html>
