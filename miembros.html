<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestión de Miembros</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    form { margin-bottom: 30px; }
    input, select { display: block; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: left; }
    img { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; }
    .btn { cursor: pointer; padding: 5px 10px; border: none; border-radius: 4px; }
    .btn-editar { background-color: #007bff; color: white; }
    .btn-eliminar { background-color: #dc3545; color: white; }
    .btn-subir-foto { background-color: #28a745; color: white; }
  </style>
</head>
<body>
  <h2>Gestión de miembros</h2>

  <button id="btnAgregar">Agregar miembro</button>

  <form id="formularioMiembro" style="display:none;">
    <h3>Datos personales</h3>
    <input type="text" id="nombre" placeholder="Nombre completo" required />
    <input type="text" id="codigo" placeholder="Código" required />
    <input type="number" id="edad" placeholder="Edad" required />
    <input type="tel" id="telefono" placeholder="Teléfono" />
    <input type="text" id="direccion" placeholder="Dirección" />
    <input type="date" id="fechaNacimiento" placeholder="Fecha de nacimiento" />

    <h3>Datos familiares</h3>
    <select id="tipoFamiliar">
      <option value="Padre">Padre</option>
      <option value="Madre">Madre</option>
      <option value="Hijo">Hijo</option>
      <option value="Esposo">Esposo</option>
    </select>
    <input type="text" id="nombreFamiliar" placeholder="Nombre del familiar" />
    <button type="button" id="agregarFamiliar">Agregar familiar</button>

    <h3>Datos espirituales</h3>
    <input type="date" id="fechaConversion" placeholder="Fecha de conversión" />
    <input type="text" id="lugarConversion" placeholder="Lugar de conversión" />
    <input type="date" id="fechaBautismo" placeholder="Fecha de bautismo" />
    <input type="text" id="lugarBautismo" placeholder="Lugar de bautismo" />
    <input type="date" id="fechaEspiritu" placeholder="Fecha bautismo Espíritu" />
    <input type="text" id="lugarEspiritu" placeholder="Lugar bautismo Espíritu" />

    <button type="submit">Guardar</button>
  </form>

  <h3>Lista de miembros</h3>
  <table id="tablaMiembros">
    <thead>
      <tr>
        <th>Foto</th>
        <th>Nombre</th>
        <th>Código</th>
        <th>Edad</th>
        <th>Teléfono</th>
        <th>Dirección</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs,
      updateDoc, doc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhFOi7rQhuVauaNMTKqyLPFqwWPqkxb3U",
      authDomain: "iglesia-adoracion-viva-182e6.firebaseapp.com",
      projectId: "iglesia-adoracion-viva-182e6",
      storageBucket: "iglesia-adoracion-viva-182e6.appspot.com",
      messagingSenderId: "152824399391",
      appId: "1:152824399391:web:a4fc0937f35935b9b5f72a",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const btnAgregar = document.getElementById('btnAgregar');
    const formulario = document.getElementById('formularioMiembro');
    const tabla = document.querySelector('#tablaMiembros tbody');

    let editandoId = null;

    btnAgregar.addEventListener('click', () => {
      formulario.reset();
      formulario.style.display = 'block';
      editandoId = null;
    });

    formulario.addEventListener('submit', async (e) => {
      e.preventDefault();

      const datos = {
        nombre: nombre.value,
        codigo: codigo.value,
        edad: edad.value,
        telefono: telefono.value,
        direccion: direccion.value,
        fechaNacimiento: fechaNacimiento.value,
        tipoFamiliar: tipoFamiliar.value,
        nombreFamiliar: nombreFamiliar.value,
        fechaConversion: fechaConversion.value,
        lugarConversion: lugarConversion.value,
        fechaBautismo: fechaBautismo.value,
        lugarBautismo: lugarBautismo.value,
        fechaEspiritu: fechaEspiritu.value,
        lugarEspiritu: lugarEspiritu.value,
        fotoURL: "" // se actualizará después si se sube
      };

      if (editandoId) {
        await updateDoc(doc(db, "miembros", editandoId), datos);
      } else {
        await addDoc(collection(db, "miembros"), datos);
      }

      formulario.style.display = 'none';
      cargarMiembros();
    });

    async function cargarMiembros() {
      tabla.innerHTML = "";
      const snapshot = await getDocs(collection(db, "miembros"));
      snapshot.forEach(docSnap => {
        const datos = docSnap.data();
        const tr = document.createElement('tr');

        const tdFoto = document.createElement('td');
        const img = document.createElement('img');
        img.src = datos.fotoURL || 'https://via.placeholder.com/50';
        img.alt = "Foto";
        tdFoto.appendChild(img);

        const tdNombre = document.createElement('td');
        tdNombre.textContent = datos.nombre;

        const tdCodigo = document.createElement('td');
        tdCodigo.textContent = datos.codigo;

        const tdEdad = document.createElement('td');
        tdEdad.textContent = datos.edad;

        const tdTelefono = document.createElement('td');
        tdTelefono.textContent = datos.telefono;

        const tdDireccion = document.createElement('td');
        tdDireccion.textContent = datos.direccion;

        const tdAcciones = document.createElement('td');

        const btnSubir = document.createElement('button');
        btnSubir.textContent = "Subir Foto";
        btnSubir.className = "btn btn-subir-foto";
        btnSubir.onclick = async () => {
          const input = document.createElement('input');
          input.type = "file";
          input.accept = "image/*";
          input.onchange = async () => {
            const file = input.files[0];
            if (!file) return;
            const { createClient } = await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm");
            const supabase = createClient("https://azywyqozwwbfctxeokug.supabase.co", "public-anon-key");
            const nombreArchivo = `${docSnap.id}_${file.name}`;
            const { data, error } = await supabase.storage.from('fotos').upload(nombreArchivo, file, { upsert: true });
            if (!error) {
              const { data: urlData } = await supabase.storage.from('fotos').getPublicUrl(nombreArchivo);
              await updateDoc(doc(db, "miembros", docSnap.id), { fotoURL: urlData.publicUrl });
              cargarMiembros();
            }
          };
          input.click();
        };

        const btnEditar = document.createElement('button');
        btnEditar.textContent = "Editar";
        btnEditar.className = "btn btn-editar";
        btnEditar.onclick = () => {
          editandoId = docSnap.id;
          formulario.style.display = 'block';
          nombre.value = datos.nombre;
          codigo.value = datos.codigo;
          edad.value = datos.edad;
          telefono.value = datos.telefono;
          direccion.value = datos.direccion;
          fechaNacimiento.value = datos.fechaNacimiento || "";
          tipoFamiliar.value = datos.tipoFamiliar || "Padre";
          nombreFamiliar.value = datos.nombreFamiliar || "";
          fechaConversion.value = datos.fechaConversion || "";
          lugarConversion.value = datos.lugarConversion || "";
          fechaBautismo.value = datos.fechaBautismo || "";
          lugarBautismo.value = datos.lugarBautismo || "";
          fechaEspiritu.value = datos.fechaEspiritu || "";
          lugarEspiritu.value = datos.lugarEspiritu || "";
        };

        const btnEliminar = document.createElement('button');
        btnEliminar.textContent = "Eliminar";
        btnEliminar.className = "btn btn-eliminar";
        btnEliminar.onclick = async () => {
          if (confirm("¿Estás seguro de eliminar este miembro?")) {
            await deleteDoc(doc(db, "miembros", docSnap.id));
            cargarMiembros();
          }
        };

        tdAcciones.append(btnSubir, btnEditar, btnEliminar);
        tr.append(tdFoto, tdNombre, tdCodigo, tdEdad, tdTelefono, tdDireccion, tdAcciones);
        tabla.appendChild(tr);
      });
    }

    document.addEventListener('DOMContentLoaded', cargarMiembros);
  </script>
</body>
</html>
