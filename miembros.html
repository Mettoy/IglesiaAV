
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestión de Miembros</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_AUTH_DOMAIN",
      projectId: "TU_PROJECT_ID",
      storageBucket: "TU_STORAGE_BUCKET",
      messagingSenderId: "TU_SENDER_ID",
      appId: "TU_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const firestore = firebase.firestore();

    const supabase = window.supabase.createClient('https://TU_SUPABASE_URL.supabase.co', 'TU_SUPABASE_PUBLIC_KEY');
  </script>
  <style>
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.7);
    }
    .modal-overlay.active {
      display: flex;
    }
  </style>
</head>
<body class="bg-gray-900 text-white flex">

  <!-- Sidebar -->
  <aside class="w-64 bg-blue-900 min-h-screen p-4">
    <div class="text-center text-yellow-400 font-bold text-xl mb-6">Mi Iglesia</div>
    <nav>
      <ul>
        <li class="mb-4"><a href="#" class="text-white hover:text-yellow-400">Inicio</a></li>
        <li class="mb-4"><a href="#" class="text-white hover:text-yellow-400">Miembros</a></li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-6">

    <!-- Tabs -->
    <div class="flex space-x-4 mb-4">
      <button id="tab-activos" class="px-4 py-2 bg-yellow-500 rounded text-black font-semibold active">Activos</button>
      <button id="tab-baja" class="px-4 py-2 bg-gray-700 rounded text-white font-semibold">De Baja</button>
      <button id="btn-add-member" class="ml-auto px-4 py-2 bg-green-500 rounded text-white">Añadir miembro</button>
    </div>

    <!-- Activos -->
    <div id="panel-activos">
      <table class="w-full bg-white text-black rounded shadow overflow-hidden">
        <thead class="bg-blue-800 text-white">
          <tr>
            <th class="p-2">Foto</th>
            <th class="p-2">Nombre</th>
            <th class="p-2">Código</th>
            <th class="p-2">Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla-activos"></tbody>
      </table>
    </div>

    <!-- De baja -->
    <div id="panel-baja" hidden>
      <table class="w-full bg-white text-black rounded shadow overflow-hidden">
        <thead class="bg-gray-800 text-white">
          <tr>
            <th class="p-2">Foto</th>
            <th class="p-2">Nombre</th>
            <th class="p-2">Código</th>
            <th class="p-2">Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla-baja"></tbody>
      </table>
    </div>
  </main>

  <!-- Modal -->
  <div id="modal-overlay" class="modal-overlay hidden fixed inset-0 justify-center items-center z-50">
    <div class="bg-white text-black rounded-lg w-full max-w-3xl p-6 relative overflow-y-auto max-h-[90vh]">
      <button id="modal-close-btn" class="absolute top-2 right-4 text-xl font-bold text-red-600">&times;</button>
      <h2 class="text-2xl font-bold mb-4 text-center">Añadir Miembro</h2>
      <form id="form-miembro" class="space-y-4">
        <!-- Datos personales -->
        <fieldset class="border p-4 rounded">
          <legend class="font-semibold text-lg">Datos personales</legend>
          <div class="grid grid-cols-2 gap-4">
            <input id="nombre" type="text" placeholder="Nombre" class="border p-2 rounded" required />
            <input id="codigo" type="text" placeholder="Código" class="border p-2 rounded" required />
            <input id="foto" type="file" accept="image/*" class="border p-2 rounded col-span-2" />
          </div>
        </fieldset>
        <!-- Datos familiares -->
        <fieldset class="border p-4 rounded">
          <legend class="font-semibold text-lg">Datos familiares</legend>
          <div class="grid grid-cols-2 gap-4">
            <input id="conyuge" type="text" placeholder="Cónyuge" class="border p-2 rounded" />
            <input id="hijos" type="text" placeholder="Hijos" class="border p-2 rounded" />
          </div>
        </fieldset>
        <!-- Datos espirituales -->
        <fieldset class="border p-4 rounded">
          <legend class="font-semibold text-lg">Datos espirituales</legend>
          <div class="grid grid-cols-2 gap-4">
            <input id="bautizo" type="text" placeholder="Bautizo" class="border p-2 rounded" />
            <input id="ministerio" type="text" placeholder="Ministerio" class="border p-2 rounded" />
            <select id="estado" class="border p-2 rounded col-span-2">
              <option value="activo">Activo</option>
              <option value="baja">De Baja</option>
            </select>
          </div>
        </fieldset>
        <button type="submit" class="mt-4 w-full bg-blue-600 text-white py-2 rounded">Guardar</button>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    const tabActivos = document.getElementById('tab-activos');
    const tabBaja = document.getElementById('tab-baja');
    const panelActivos = document.getElementById('panel-activos');
    const panelBaja = document.getElementById('panel-baja');

    tabActivos.addEventListener('click', () => {
      tabActivos.classList.add('bg-yellow-500');
      tabBaja.classList.remove('bg-yellow-500');
      panelActivos.hidden = false;
      panelBaja.hidden = true;
    });

    tabBaja.addEventListener('click', () => {
      tabBaja.classList.add('bg-yellow-500');
      tabActivos.classList.remove('bg-yellow-500');
      panelActivos.hidden = true;
      panelBaja.hidden = false;
    });

    document.getElementById('btn-add-member').addEventListener('click', () => {
      document.getElementById('modal-overlay').classList.add('active');
    });

    document.getElementById('modal-close-btn').addEventListener('click', () => {
      document.getElementById('modal-overlay').classList.remove('active');
    });

    function renderMiembroRow(miembro) {
      return `
        <tr>
          <td class="p-2"><img src="${miembro.foto}" alt="foto" class="w-12 h-12 rounded-full object-cover" /></td>
          <td class="p-2">${miembro.nombre}</td>
          <td class="p-2">${miembro.codigo}</td>
          <td class="p-2">
            <button class="px-2 py-1 bg-yellow-500 text-black rounded">Editar</button>
            <button class="px-2 py-1 bg-red-600 text-white rounded">${miembro.estado === 'activo' ? 'Dar de baja' : 'Reactivar'}</button>
          </td>
        </tr>
      `;
    }

    function cargarMiembros() {
      firestore.collection('miembros').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
        const activos = document.getElementById('tabla-activos');
        const baja = document.getElementById('tabla-baja');
        activos.innerHTML = '';
        baja.innerHTML = '';

        snapshot.forEach(doc => {
          const miembro = doc.data();
          const row = renderMiembroRow(miembro);
          if (miembro.estado === 'activo') {
            activos.innerHTML += row;
          } else {
            baja.innerHTML += row;
          }
        });
      });
    }

    document.getElementById('form-miembro').addEventListener('submit', async (e) => {
      e.preventDefault();

      const nombre = document.getElementById('nombre').value.trim();
      const codigo = document.getElementById('codigo').value.trim();
      const conyuge = document.getElementById('conyuge').value.trim();
      const hijos = document.getElementById('hijos').value.trim();
      const bautizo = document.getElementById('bautizo').value.trim();
      const ministerio = document.getElementById('ministerio').value.trim();
      const estado = document.getElementById('estado').value;
      const fotoFile = document.getElementById('foto').files[0];

      // Validar código único
      const existe = await firestore.collection('miembros').where('codigo', '==', codigo).get();
      if (!existe.empty) {
        alert('El código ya está en uso. Por favor, elige otro.');
        return;
      }

      let fotoURL = '';
      if (fotoFile) {
        const filePath = `${Date.now()}_${fotoFile.name}`;
        const { error } = await supabase.storage.from('ftmember').upload(filePath, fotoFile);

        if (error) {
          alert('Error al subir la foto: ' + error.message);
          return;
        }

        const { data: publicUrl } = supabase.storage.from('ftmember').getPublicUrl(filePath);
        fotoURL = publicUrl.publicUrl;
      }

      await firestore.collection('miembros').add({
        nombre, codigo, conyuge, hijos, bautizo, ministerio, estado, foto: fotoURL,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      alert('Miembro guardado correctamente.');
      document.getElementById('form-miembro').reset();
      document.getElementById('modal-overlay').classList.remove('active');
    });

    // Cargar miembros al iniciar
    cargarMiembros();
  </script>
</body>
</html>