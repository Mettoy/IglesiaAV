<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestión de Miembros</title>

<style>
  /* Estilos generales */
  body {
    background-color: #0d1a33; /* azul oscuro */
    color: #d4af37; /* dorado */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0;
  }

  header {
    background-color: #09214d;
    padding: 1rem;
    text-align: center;
    font-size: 1.8rem;
    font-weight: bold;
    color: #d4af37;
  }

  main {
    max-width: 1100px;
    margin: 2rem auto;
    padding: 1rem;
  }

  form {
    background-color: #14325c;
    padding: 1rem 2rem;
    border-radius: 8px;
    margin-bottom: 2rem;
  }

  form h2 {
    border-bottom: 1px solid #d4af37;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
  }

  form section {
    margin-bottom: 1.5rem;
  }

  label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: 600;
  }

  input[type="text"],
  input[type="number"],
  input[type="tel"],
  input[type="date"],
  select {
    width: 100%;
    padding: 0.5rem;
    border-radius: 4px;
    border: none;
    margin-bottom: 0.8rem;
    font-size: 1rem;
  }

  input[type="file"] {
    margin-top: 0.4rem;
    margin-bottom: 1rem;
  }

  button {
    background-color: #d4af37;
    color: #0d1a33;
    font-weight: 700;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  button:disabled {
    background-color: #999;
    cursor: not-allowed;
  }

  button:hover:not(:disabled) {
    background-color: #b79023;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background-color: #14325c;
    border-radius: 8px;
    overflow: hidden;
  }

  thead {
    background-color: #0a1b3a;
  }

  th, td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid #d4af37;
    vertical-align: middle;
  }

  img.foto-miembro {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 50%;
    border: 2px solid #d4af37;
  }

  .busqueda-container {
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #busqueda-miembros {
    padding: 0.5rem 1rem;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    width: 300px;
  }
</style>
</head>
<body>
  <header>Gestión de Miembros</header>
  <main>
    <div class="busqueda-container">
      <button id="btn-agregar-miembro">Añadir Miembro</button>
      <input type="text" id="busqueda-miembros" placeholder="Buscar por nombre o código..." />
    </div>

    <form id="form-miembro" style="display:none;">
      <!-- Datos Personales -->
      <section>
        <h2>Datos Personales</h2>
        <label for="nombre">Nombre Completo</label>
        <input type="text" id="nombre" name="nombre" required />

        <label for="codigo">Código</label>
        <input type="text" id="codigo" name="codigo" required />

        <label for="edad">Edad</label>
        <input type="number" id="edad" name="edad" required min="0" />

        <label for="telefono">Teléfono</label>
        <input type="tel" id="telefono" name="telefono" required />

        <label for="direccion">Dirección</label>
        <input type="text" id="direccion" name="direccion" required />

        <label for="fechaNacimiento">Fecha de Nacimiento</label>
        <input type="date" id="fechaNacimiento" name="fechaNacimiento" required />
      </section>

      <!-- Datos Familiares -->
      <section>
        <h2>Datos Familiares</h2>
        <label for="tipoFamiliar">Tipo de Familiar</label>
        <select id="tipoFamiliar" name="tipoFamiliar">
          <option value="">Seleccione...</option>
          <option value="Padre">Padre</option>
          <option value="Madre">Madre</option>
          <option value="Hermano">Hermano</option>
          <option value="Hermana">Hermana</option>
          <option value="Hijo">Hijo</option>
          <option value="Hija">Hija</option>
          <option value="Otro">Otro</option>
        </select>

        <label for="nombreFamiliar">Nombre del Familiar</label>
        <input type="text" id="nombreFamiliar" name="nombreFamiliar" />

        <button type="button" id="btn-agregar-familiar">Agregar Familiar</button>

        <ul id="lista-familiares" style="margin-top: 1rem; color: #fff;"></ul>
      </section>

      <!-- Datos Espirituales -->
      <section>
        <h2>Datos Espirituales</h2>

        <label for="fechaConversion">Fecha de Conversión</label>
        <input type="date" id="fechaConversion" name="fechaConversion" />

        <label for="lugarConversion">Lugar de Conversión</label>
        <input type="text" id="lugarConversion" name="lugarConversion" />

        <label for="fechaBautismo">Fecha de Bautismo</label>
        <input type="date" id="fechaBautismo" name="fechaBautismo" />

        <label for="lugarBautismo">Lugar de Bautismo</label>
        <input type="text" id="lugarBautismo" name="lugarBautismo" />

        <label for="fechaBautismoEspiritu">Fecha de Bautismo en el Espíritu</label>
        <input type="date" id="fechaBautismoEspiritu" name="fechaBautismoEspiritu" />

        <label for="lugarBautismoEspiritu">Lugar de Bautismo en el Espíritu</label>
        <input type="text" id="lugarBautismoEspiritu" name="lugarBautismoEspiritu" />
      </section>

      <!-- Foto -->
      <section>
        <h2>Foto</h2>
        <input type="file" id="foto" name="foto" accept="image/*" />
      </section>

      <button id="btn-guardar" type="submit">Guardar</button>
    </form>

    <table>
      <thead>
        <tr>
          <th>Foto</th>
          <th>Nombre</th>
          <th>Código</th>
          <th>Edad</th>
          <th>Teléfono</th>
          <th>Dirección</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-miembros"></tbody>
    </table>
  </main>
  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  // Configura tu Supabase aquí
  const supabaseUrl = 'https://azywyqozwwbfctxeokug.supabase.co'
  const supabaseAnonKey = 'TU_ANON_KEY_AQUI'  // Cambia por tu anon key real
  const supabase = createClient(supabaseUrl, supabaseAnonKey)

  // Elementos
  const form = document.getElementById('form-miembro')
  const inputFoto = document.getElementById('foto')
  const tabla = document.getElementById('tabla-miembros')
  const btnGuardar = document.getElementById('btn-guardar')
  const inputBusqueda = document.getElementById('busqueda-miembros')
  const btnAgregarMiembro = document.getElementById('btn-agregar-miembro')

  // Para manejar familiares en lista temporal
  const listaFamiliares = document.getElementById('lista-familiares')
  const btnAgregarFamiliar = document.getElementById('btn-agregar-familiar')
  const inputTipoFamiliar = document.getElementById('tipoFamiliar')
  const inputNombreFamiliar = document.getElementById('nombreFamiliar')
  let familiares = []

  let miembros = []
  let editandoId = null

  // Mostrar formulario al hacer click en Añadir Miembro
  btnAgregarMiembro.addEventListener('click', () => {
    form.style.display = 'block'
    form.reset()
    familiares = []
    actualizarListaFamiliares()
    editandoId = null
  })

  // Agregar familiar a la lista temporal
  btnAgregarFamiliar.addEventListener('click', () => {
    const tipo = inputTipoFamiliar.value.trim()
    const nombre = inputNombreFamiliar.value.trim()
    if (!tipo || !nombre) {
      alert('Por favor selecciona tipo y nombre del familiar')
      return
    }
    familiares.push({ tipo, nombre })
    actualizarListaFamiliares()
    inputTipoFamiliar.value = ''
    inputNombreFamiliar.value = ''
  })

  // Actualizar la lista visible de familiares en el formulario
  function actualizarListaFamiliares() {
    listaFamiliares.innerHTML = ''
    familiares.forEach((fam, i) => {
      const li = document.createElement('li')
      li.textContent = `${fam.tipo}: ${fam.nombre}`
      listaFamiliares.appendChild(li)
    })
  }

  // Cargar miembros desde Supabase
  async function cargarMiembros() {
    const { data, error } = await supabase
      .from('miembros')
      .select('*')
      .order('codigo', { ascending: true })

    if (error) {
      console.error('Error cargando miembros:', error)
      return
    }
    miembros = data
    mostrarMiembros(miembros)
  }

  // Mostrar miembros en la tabla
  async function mostrarMiembros(datos) {
    tabla.innerHTML = ''

    for (const miembro of datos) {
      let fotoUrl = ''

      if (miembro.foto) {
        const { data: urlData, error } = await supabase.storage
          .from('fotos')
          .createSignedUrl(miembro.foto, 60) // url válida 60 seg

        if (!error && urlData?.signedUrl) {
          fotoUrl = urlData.signedUrl
        }
      }

      tabla.innerHTML += `
        <tr>
          <td><img src="${fotoUrl}" alt="Foto" class="foto-miembro"></td>
          <td>${miembro.nombre}</td>
          <td>${miembro.codigo}</td>
          <td>${miembro.edad}</td>
          <td>${miembro.telefono}</td>
          <td>${miembro.direccion}</td>
          <td><button data-id="${miembro.id}" class="btn-editar">Editar</button></td>
        </tr>
      `
    }

    // Agregar evento a botones editar
    document.querySelectorAll('.btn-editar').forEach(boton => {
      boton.addEventListener('click', () => {
        const id = boton.getAttribute('data-id')
        cargarFormulario(id)
      })
    })
  }

  // Cargar datos en formulario para editar
  async function cargarFormulario(id) {
    const miembro = miembros.find(m => m.id === id)
    if (!miembro) return

    editandoId = id
    form.style.display = 'block'

    document.getElementById('nombre').value = miembro.nombre || ''
    document.getElementById('codigo').value = miembro.codigo || ''
    document.getElementById('edad').value = miembro.edad || ''
    document.getElementById('telefono').value = miembro.telefono || ''
    document.getElementById('direccion').value = miembro.direccion || ''
    document.getElementById('fechaNacimiento').value = miembro.fechaNacimiento || ''

    // Datos espirituales
    document.getElementById('fechaConversion').value = miembro.fechaConversion || ''
    document.getElementById('lugarConversion').value = miembro.lugarConversion || ''
    document.getElementById('fechaBautismo').value = miembro.fechaBautismo || ''
    document.getElementById('lugarBautismo').value = miembro.lugarBautismo || ''
    document.getElementById('fechaBautismoEspiritu').value = miembro.fechaBautismoEspiritu || ''
    document.getElementById('lugarBautismoEspiritu').value = miembro.lugarBautismoEspiritu || ''

    // Datos familiares (cargar lista)
    familiares = miembro.familiares || []
    actualizarListaFamiliares()
  }

  // Guardar nuevo miembro o actualizar existente
  form.addEventListener('submit', async (e) => {
    e.preventDefault()
    btnGuardar.disabled = true

    // Leer datos del formulario
    const nombre = document.getElementById('nombre').value.trim()
    const codigo = document.getElementById('codigo').value.trim()
    const edad = Number(document.getElementById('edad').value)
    const telefono = document.getElementById('telefono').value.trim()
    const direccion = document.getElementById('direccion').value.trim()
    const fechaNacimiento = document.getElementById('fechaNacimiento').value

    const fechaConversion = document.getElementById('fechaConversion').value
    const lugarConversion = document.getElementById('lugarConversion').value.trim()
    const fechaBautismo = document.getElementById('fechaBautismo').value
    const lugarBautismo = document.getElementById('lugarBautismo').value.trim()
    const fechaBautismoEspiritu = document.getElementById('fechaBautismoEspiritu').value
    const lugarBautismoEspiritu = document.getElementById('lugarBautismoEspiritu').value.trim()

    // Subir foto si hay
    let fotoPath = null
    if (inputFoto.files.length > 0) {
      const archivo = inputFoto.files[0]
      const nombreArchivo = `${Date.now()}_${archivo.name}`
      const { data, error } = await supabase.storage
        .from('fotos')
        .upload(nombreArchivo, archivo, { upsert: true })

      if (error) {
        alert('Error subiendo la foto: ' + error.message)
        btnGuardar.disabled = false
        return
      }
      fotoPath = data.path
    }

    const miembroData = {
      nombre,
      codigo,
      edad,
      telefono,
      direccion,
      fechaNacimiento,
      fechaConversion,
      lugarConversion,
      fechaBautismo,
      lugarBautismo,
      fechaBautismoEspiritu,
      lugarBautismoEspiritu,
      familiares,
    }
    if (fotoPath) miembroData.foto = fotoPath

    try {
      if (editandoId) {
        // Actualizar
        const { error } = await supabase
          .from('miembros')
          .update(miembroData)
          .eq('id', editandoId)
        if (error) throw error
      } else {
        // Insertar nuevo
        const { error } = await supabase
          .from('miembros')
          .insert(miembroData)
        if (error) throw error
      }
      await cargarMiembros()
      form.style.display = 'none'
      form.reset()
      familiares = []
      actualizarListaFamiliares()
      editandoId = null
    } catch (err) {
      alert('Error guardando datos: ' + err.message)
    }

    btnGuardar.disabled = false
  })

  // Filtro de búsqueda
  inputBusqueda.addEventListener('input', () => {
    const texto = inputBusqueda.value.toLowerCase()
    const filtrados = miembros.filter(m =>
      m.nombre.toLowerCase().includes(texto) ||
      m.codigo.toLowerCase().includes(texto)
    )
    mostrarMiembros(filtrados)
  })

  // Carga inicial
  cargarMiembros()
</script>
</body>
</html>
