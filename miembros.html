<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestión de Miembros</title>
<style>
  /* Estilo azul oscuro + dorado */
  body {
    background: #121823;
    color: #d4af37;
    font-family: Arial, sans-serif;
    margin: 0;
  }
  .container {
    max-width: 1200px;
    margin: 30px auto;
    padding: 10px 20px;
  }
  h1 {
    text-align: center;
    margin-bottom: 20px;
  }
  button {
    background-color: #d4af37;
    border: none;
    color: #121823;
    padding: 8px 16px;
    cursor: pointer;
    border-radius: 5px;
    font-weight: bold;
    margin-right: 10px;
  }
  button:hover {
    background-color: #b78a1e;
  }
  /* Tabla */
  table {
    width: 100%;
    border-collapse: collapse;
    background: #1e2633;
    margin-top: 10px;
    color: #d4af37;
  }
  th, td {
    padding: 12px;
    border-bottom: 1px solid #444;
    text-align: left;
  }
  th {
    background-color: #2c3444;
  }
  img.foto {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
  }
  /* Modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 999;
    left: 0; top: 0; right: 0; bottom: 0;
    background-color: rgba(0,0,0,0.7);
    justify-content: center;
    align-items: center;
  }
  .modal.active {
    display: flex;
  }
  .modal-content {
    background-color: #1e2633;
    border-radius: 12px;
    width: 95%;
    max-width: 650px;
    padding: 25px;
    color: #d4af37;
    position: relative;
  }
  .close-btn {
    position: absolute;
    right: 18px;
    top: 18px;
    font-size: 28px;
    cursor: pointer;
    font-weight: bold;
  }
  /* Tabs */
  .tabs {
    display: flex;
    margin-bottom: 18px;
    border-bottom: 2px solid #d4af37;
  }
  .tab {
    padding: 10px 20px;
    cursor: pointer;
    border: 1px solid transparent;
    border-bottom: none;
    color: #d4af37;
    font-weight: bold;
  }
  .tab.active {
    background-color: #d4af37;
    color: #121823;
    border-radius: 12px 12px 0 0;
    border: 1px solid #d4af37;
    border-bottom: none;
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  /* Form Inputs */
  label {
    display: block;
    margin: 12px 0 5px 0;
  }
  input, select {
    width: 100%;
    padding: 8px 12px;
    border-radius: 6px;
    border: none;
    font-size: 1em;
  }
  /* Acciones tabla */
  .actions-btns button {
    margin-right: 6px;
    background-color: #b78a1e;
    color: #121823;
    padding: 6px 10px;
    font-size: 0.9em;
  }
  .actions-btns button:hover {
    background-color: #d4af37;
  }
  /* Paginación */
  .pagination {
    margin-top: 20px;
    text-align: center;
  }
  .pagination button {
    margin: 0 3px;
  }
  /* Tabs activos / baja */
  .status-tabs {
    margin-bottom: 15px;
  }
  .status-tab {
    padding: 10px 22px;
    cursor: pointer;
    border: 1px solid transparent;
    border-bottom: none;
    color: #d4af37;
    font-weight: bold;
    margin-right: 8px;
    display: inline-block;
  }
  .status-tab.active {
    background-color: #d4af37;
    color: #121823;
    border-radius: 12px 12px 0 0;
    border: 1px solid #d4af37;
    border-bottom: none;
  }
</style>
</head>
<body>

<div class="container">
  <h1>Gestión de Miembros</h1>

  <div class="status-tabs">
    <span class="status-tab active" data-status="activo">Activos</span>
    <span class="status-tab" data-status="baja">De Baja</span>
  </div>

  <button id="btnAddMember">Añadir Miembro</button>

  <table>
    <thead>
      <tr>
        <th>Foto</th>
        <th>Nombre</th>
        <th>Código</th>
        <th>Edad</th>
        <th>Dirección</th>
        <th>Sociedad</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="membersTableBody">
      <!-- Miembros aquí -->
    </tbody>
  </table>

  <div class="pagination" id="pagination"></div>
</div>

<!-- Modal Formulario -->
<div class="modal" id="modalMemberForm" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <span class="close-btn" id="closeModal" aria-label="Cerrar formulario">&times;</span>
    <h2 id="modalTitle">Agregar / Editar Miembro</h2>
    
    <div class="tabs">
      <div class="tab active" data-tab="personal">Datos Personales</div>
      <div class="tab" data-tab="familiares">Datos Familiares</div>
      <div class="tab" data-tab="espirituales">Datos Espirituales</div>
    </div>
    
    <form id="memberForm" autocomplete="off">
      <!-- PERSONAL -->
      <div class="tab-content active" id="personal">
        <label for="fotoInput">Foto (jpg/png):</label>
        <input type="file" id="fotoInput" name="foto" accept="image/png, image/jpeg" />

        <label for="nombreInput">Nombre completo:</label>
        <input type="text" id="nombreInput" name="nombre" required />

        <label for="codigoInput">Código:</label>
        <input type="text" id="codigoInput" name="codigo" required />

        <label for="edadInput">Edad:</label>
        <input type="number" id="edadInput" name="edad" min="0" />
      </div>
      <!-- FAMILIARES -->
      <div class="tab-content" id="familiares">
        <label for="direccionInput">Dirección:</label>
        <input type="text" id="direccionInput" name="direccion" />

        <label for="sociedadInput">Sociedad:</label>
        <input type="text" id="sociedadInput" name="sociedad" />
      </div>
      <!-- ESPIRITUALES -->
      <div class="tab-content" id="espirituales">
        <label for="ministerioInput">Ministerio:</label>
        <input type="text" id="ministerioInput" name="ministerio" />

        <label for="estatusInput">Estatus espiritual:</label>
        <select id="estatusInput" name="estatus">
          <option value="">Seleccionar</option>
          <option value="activo">Activo</option>
          <option value="inactivo">Inactivo</option>
        </select>
      </div>
      <br />
      <button type="submit" id="submitBtn">Guardar Miembro</button>
    </form>
  </div>
</div>

<!-- Firebase y Supabase SDK -->
<script type="module">
// IMPORTA Y CONFIGURA FIREBASE Y SUPABASE

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, query, where, orderBy, limit, startAfter, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const firebaseConfig = {
  apiKey: "AIzaSyAyfPQzO7evryWcQ5d1lGV3z8aB-gFOh_k",
  authDomain: "iglesia-adoracion-viva.firebaseapp.com",
  projectId: "iglesia-adoracion-viva",
  storageBucket: "iglesia-adoracion-viva.appspot.com",
  messagingSenderId: "815332010058",
  appId: "1:815332010058:web:d2afff616469349d88deb3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const supabaseUrl = "https://xxxxxxxx.supabase.co"; // REEMPLAZAR con URL Supabase real
const supabaseAnonKey = "YOUR_SUPABASE_ANON_KEY"; // REEMPLAZAR con clave anónima Supabase
const supabase = createClient(supabaseUrl, supabaseAnonKey);

const bucketName = "ftmember";

const membersPerPage = 30;
let currentPage = 1;
let lastVisibleDoc = null;
let currentStatus = "activo"; // "activo" o "baja"
let membersCache = []; // para paginación local

// ELEMENTOS DOM
const btnAddMember = document.getElementById("btnAddMember");
const modal = document.getElementById("modalMemberForm");
const closeModalBtn = document.getElementById("closeModal");
const tabs = document.querySelectorAll(".tabs .tab");
const tabContents = document.querySelectorAll(".tab-content");
const memberForm = document.getElementById("memberForm");
const membersTableBody = document.getElementById("membersTableBody");
const paginationDiv = document.getElementById("pagination");
const statusTabs = document.querySelectorAll(".status-tab");

// Estado edición
let editingMemberId = null;
let editingMemberPhotoPath = null;

// FUNCIONES AUXILIARES

function openModal() {
  modal.classList.add("active");
  modal.setAttribute("aria-hidden", "false");
}

function closeModal() {
  modal.classList.remove("active");
  modal.setAttribute("aria-hidden", "true");
  memberForm.reset();
  editingMemberId = null;
  editingMemberPhotoPath = null;
  // volver a primera pestaña
  setActiveTab("personal");
}

function setActiveTab(tabName) {
  tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === tabName));
  tabContents.forEach(tc => tc.classList.toggle("active", tc.id === tabName));
}

// Calcular edad a partir de fecha de nacimiento (opcional)
// Ahora solo usa la edad numérica, si quieres, podemos mejorar

function renderMembersTable(members) {
  membersTableBody.innerHTML = "";
  if (members.length === 0) {
    membersTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:#aaa;">No hay miembros</td></tr>`;
    return;
  }
  for (const member of members) {
    const tr = document.createElement("tr");

    const tdFoto = document.createElement("td");
    const img = document.createElement("img");
    img.classList.add("foto");
    img.alt = `Foto de ${member.nombre}`;
    img.src = member.fotoURL || "https://via.placeholder.com/50?text=No+Foto";
    tdFoto.appendChild(img);

    const tdNombre = document.createElement("td");
    tdNombre.textContent = member.nombre || "";

    const tdCodigo = document.createElement("td");
    tdCodigo.textContent = member.codigo || "";

    const tdEdad = document.createElement("td");
    tdEdad.textContent = member.edad !== undefined ? member.edad : "";

    const tdDireccion = document.createElement("td");
    tdDireccion.textContent = member.direccion || "";

    const tdSociedad = document.createElement("td");
    tdSociedad.textContent = member.sociedad || "";

    const tdAcciones = document.createElement("td");
    tdAcciones.classList.add("actions-btns");

    const btnEdit = document.createElement("button");
    btnEdit.textContent = "Editar";
    btnEdit.addEventListener("click", () => editMember(member));
    tdAcciones.appendChild(btnEdit);

    const btnToggleStatus = document.createElement("button");
    if (member.estado === "activo") {
      btnToggleStatus.textContent = "Dar de Baja";
    } else {
      btnToggleStatus.textContent = "Reactivar";
    }
    btnToggleStatus.addEventListener("click", () => toggleMemberStatus(member));
    tdAcciones.appendChild(btnToggleStatus);

    tr.append(tdFoto, tdNombre, tdCodigo, tdEdad, tdDireccion, tdSociedad, tdAcciones);
    membersTableBody.appendChild(tr);
  }
}

async function toggleMemberStatus(member) {
  const newEstado = member.estado === "activo" ? "baja" : "activo";
  const docRef = doc(db, "miembros", member.id);
  try {
    await updateDoc(docRef, { estado: newEstado });
    alert(`Miembro ${newEstado === "activo" ? "reactivado" : "dado de baja"} correctamente`);
    loadMembers();
  } catch (err) {
    alert("Error al cambiar estado: " + err.message);
  }
}

function fillForm(member) {
  document.getElementById("nombreInput").value = member.nombre || "";
  document.getElementById("codigoInput").value = member.codigo || "";
  document.getElementById("edadInput").value = member.edad || "";
  document.getElementById("direccionInput").value = member.direccion || "";
  document.getElementById("sociedadInput").value = member.sociedad || "";
  document.getElementById("ministerioInput").value = member.ministerio || "";
  document.getElementById("estatusInput").value = member.estatus || "";
  editingMemberPhotoPath = member.fotoPath || null;
}

// Subir foto a Supabase y devolver path y URL
async function uploadPhoto(file, oldPath = null) {
  if (!file) return { path: oldPath, url: null };
  // Eliminar foto antigua si existe
  if (oldPath) {
    await supabase.storage.from(bucketName).remove([oldPath]);
  }
  const fileExt = file.name.split(".").pop();
  const fileName = `${Date.now()}.${fileExt}`;
  const filePath = `${fileName}`;
  const { data, error } = await supabase.storage.from(bucketName).upload(filePath, file, {
    cacheControl: "3600",
    upsert: true,
  });
  if (error) throw error;
  // Obtener URL pública
  const { data: urlData } = supabase.storage.from(bucketName).getPublicUrl(filePath);
  return { path: filePath, url: urlData.publicUrl };
}

// Crear miembro en Firestore
async function createMember(data) {
  const docRef = await addDoc(collection(db, "miembros"), data);
  return docRef.id;
}

// Actualizar miembro
async function updateMember(id, data) {
  const docRef = doc(db, "miembros", id);
  await updateDoc(docRef, data);
}

// Cargar miembros filtrando por estado y paginando
async function loadMembers() {
  // Consulta ordenada por codigo y estado
  const q = query(
    collection(db, "miembros"),
    where("estado", "==", currentStatus),
    orderBy("codigo"),
    limit(membersPerPage)
  );
  const querySnapshot = await getDocs(q);
  const members = [];
  querySnapshot.forEach(docSnap => {
    members.push({ id: docSnap.id, ...docSnap.data() });
  });
  membersCache = members;
  renderMembersTable(members);
  renderPagination();
}

// Renderiza paginación (solo simple, se puede mejorar)
function renderPagination() {
  paginationDiv.innerHTML = "";
  // Solo prev y next simples para ejemplo
  const prevBtn = document.createElement("button");
  prevBtn.textContent = "Anterior";
  prevBtn.disabled = currentPage === 1;
  prevBtn.onclick = () => {
    if (currentPage > 1) {
      currentPage--;
      loadMembers();
    }
  };

  const nextBtn = document.createElement("button");
  nextBtn.textContent = "Siguiente";
  // Deshabilitar si menos de membersPerPage
  nextBtn.disabled = membersCache.length < membersPerPage;
  nextBtn.onclick = () => {
    currentPage++;
    loadMembers();
  };

  paginationDiv.appendChild(prevBtn);
  paginationDiv.appendChild(nextBtn);
}

// Edición miembro
async function editMember(member) {
  editingMemberId = member.id;
  fillForm(member);
  openModal();
}

// Form submit
memberForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const nombre = document.getElementById("nombreInput").value.trim();
  const codigo = document.getElementById("codigoInput").value.trim();
  const edad = Number(document.getElementById("edadInput").value) || null;
  const direccion = document.getElementById("direccionInput").value.trim();
  const sociedad = document.getElementById("sociedadInput").value.trim();
  const ministerio = document.getElementById("ministerioInput").value.trim();
  const estatus = document.getElementById("estatusInput").value;

  const fotoFile = document.getElementById("fotoInput").files[0];

  try {
    let fotoPath = editingMemberPhotoPath;
    let fotoURL = null;
    if (fotoFile) {
      // Subir nueva foto y eliminar anterior si hay
      const uploadResult = await uploadPhoto(fotoFile, editingMemberPhotoPath);
      fotoPath = uploadResult.path;
      fotoURL = uploadResult.url;
    }
    // Si no cambio la foto y es edición, mantener la URL previa
    if (!fotoFile && editingMemberId) {
      const memberData = membersCache.find(m => m.id === editingMemberId);
      fotoURL = memberData ? memberData.fotoURL : null;
    } else if (fotoFile && !fotoURL) {
      // En caso que no obtuvimos URL tras subida
      fotoURL = "";
    }

    const memberDataToSave = {
      nombre,
      codigo,
      edad,
      direccion,
      sociedad,
      ministerio,
      estatus,
      estado: "activo",
      fotoPath,
      fotoURL
    };

    if (editingMemberId) {
      await updateMember(editingMemberId, memberDataToSave);
      alert("Miembro actualizado correctamente");
    } else {
      await createMember(memberDataToSave);
      alert("Miembro creado correctamente");
    }

    closeModal();
    loadMembers();
  } catch (error) {
    alert("Error al guardar el miembro: " + error.message);
  }
});

// Eventos UI

btnAddMember.addEventListener("click", () => {
  editingMemberId = null;
  editingMemberPhotoPath = null;
  memberForm.reset();
  setActiveTab("personal");
  openModal();
});

closeModalBtn.addEventListener("click", closeModal);

window.addEventListener("click", (e) => {
  if (e.target === modal) {
    closeModal();
  }
});

// Tabs cambio
tabs.forEach(tab => {
  tab.addEventListener("click", () => {
    setActiveTab(tab.dataset.tab);
  });
});

// Tabs estado miembros
statusTabs.forEach(tab => {
  tab.addEventListener("click", () => {
    statusTabs.forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    currentStatus = tab.dataset.status;
    currentPage = 1;
    loadMembers();
  });
});

// Al cargar la página
window.addEventListener("DOMContentLoaded", () => {
  loadMembers();
});
</script>

</body>
</html>
