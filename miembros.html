<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestión de Miembros</title>

<style>
  /* (mismo CSS que me diste, lo dejo para no repetirlo aquí) */
  body {
    background-color: #0d1a33; /* azul oscuro */
    color: #d4af37; /* dorado */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0;
  }
  header {
    background-color: #09214d;
    padding: 1rem;
    text-align: center;
    font-size: 1.8rem;
    font-weight: bold;
    color: #d4af37;
  }
  main {
    max-width: 1100px;
    margin: 2rem auto;
    padding: 1rem;
  }
  form {
    background-color: #14325c;
    padding: 1rem 2rem;
    border-radius: 8px;
    margin-bottom: 2rem;
  }
  form h2 {
    border-bottom: 1px solid #d4af37;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
  }
  form section {
    margin-bottom: 1.5rem;
  }
  label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: 600;
  }
  input[type="text"],
  input[type="number"],
  input[type="tel"],
  input[type="date"],
  select {
    width: 100%;
    padding: 0.5rem;
    border-radius: 4px;
    border: none;
    margin-bottom: 0.8rem;
    font-size: 1rem;
  }
  input[type="file"] {
    margin-top: 0.4rem;
    margin-bottom: 1rem;
  }
  button {
    background-color: #d4af37;
    color: #0d1a33;
    font-weight: 700;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:disabled {
    background-color: #999;
    cursor: not-allowed;
  }
  button:hover:not(:disabled) {
    background-color: #b79023;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background-color: #14325c;
    border-radius: 8px;
    overflow: hidden;
  }
  thead {
    background-color: #0a1b3a;
  }
  th, td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid #d4af37;
    vertical-align: middle;
  }
  img.foto-miembro {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 50%;
    border: 2px solid #d4af37;
  }
  .busqueda-container {
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #busqueda-miembros {
    padding: 0.5rem 1rem;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    width: 300px;
  }
</style>
</head>
<body>
  <header>Gestión de Miembros</header>
  <main>
    <div class="busqueda-container">
      <button id="btn-agregar-miembro">Añadir Miembro</button>
      <input type="text" id="busqueda-miembros" placeholder="Buscar por nombre o código..." />
    </div>

    <form id="form-miembro" style="display:none;">
      <!-- Datos Personales -->
      <section>
        <h2>Datos Personales</h2>
        <label for="nombre">Nombre Completo</label>
        <input type="text" id="nombre" name="nombre" required />

        <label for="codigo">Código</label>
        <input type="text" id="codigo" name="codigo" required />

        <label for="edad">Edad</label>
        <input type="number" id="edad" name="edad" required min="0" />

        <label for="telefono">Teléfono</label>
        <input type="tel" id="telefono" name="telefono" required />

        <label for="direccion">Dirección</label>
        <input type="text" id="direccion" name="direccion" required />

        <label for="fechaNacimiento">Fecha de Nacimiento</label>
        <input type="date" id="fechaNacimiento" name="fechaNacimiento" required />
      </section>

      <!-- Datos Familiares -->
      <section>
        <h2>Datos Familiares</h2>
        <label for="tipoFamiliar">Tipo de Familiar</label>
        <select id="tipoFamiliar" name="tipoFamiliar">
          <option value="">Seleccione...</option>
          <option value="Padre">Padre</option>
          <option value="Madre">Madre</option>
          <option value="Hermano">Hermano</option>
          <option value="Hermana">Hermana</option>
          <option value="Hijo">Hijo</option>
          <option value="Hija">Hija</option>
          <option value="Otro">Otro</option>
        </select>

        <label for="nombreFamiliar">Nombre del Familiar</label>
        <input type="text" id="nombreFamiliar" name="nombreFamiliar" />

        <button type="button" id="btn-agregar-familiar">Agregar Familiar</button>

        <ul id="lista-familiares" style="margin-top: 1rem; color: #fff;"></ul>
      </section>

      <!-- Datos Espirituales -->
      <section>
        <h2>Datos Espirituales</h2>

        <label for="fechaConversion">Fecha de Conversión</label>
        <input type="date" id="fechaConversion" name="fechaConversion" />

        <label for="lugarConversion">Lugar de Conversión</label>
        <input type="text" id="lugarConversion" name="lugarConversion" />

        <label for="fechaBautismo">Fecha de Bautismo</label>
        <input type="date" id="fechaBautismo" name="fechaBautismo" />

        <label for="lugarBautismo">Lugar de Bautismo</label>
        <input type="text" id="lugarBautismo" name="lugarBautismo" />

        <label for="fechaBautismoEspiritu">Fecha de Bautismo en el Espíritu</label>
        <input type="date" id="fechaBautismoEspiritu" name="fechaBautismoEspiritu" />

        <label for="lugarBautismoEspiritu">Lugar de Bautismo en el Espíritu</label>
        <input type="text" id="lugarBautismoEspiritu" name="lugarBautismoEspiritu" />
      </section>

      <!-- Foto -->
      <section>
        <h2>Foto</h2>
        <input type="file" id="foto" name="foto" accept="image/*" />
      </section>

      <button id="btn-guardar" type="submit">Guardar</button>
    </form>

    <table>
      <thead>
        <tr>
          <th>Foto</th>
          <th>Nombre</th>
          <th>Código</th>
          <th>Edad</th>
          <th>Teléfono</th>
          <th>Dirección</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-miembros"></tbody>
    </table>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
 

  <!-- Supabase -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
  import {
    getFirestore,
    collection,
    getDocs,
    doc,
    updateDoc
  } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAyfPQzO7evryWcQ5d1lGV3z8aB-gFOh_k",
    authDomain: "iglesia-adoracion-viva.firebaseapp.com",
    projectId: "iglesia-adoracion-viva",
    storageBucket: "iglesia-adoracion-viva.appspot.com",
    messagingSenderId: "815332010058",
    appId: "1:815332010058:web:d2afff616469349d88deb3",
    measurementId: "G-43MZP6V55D"
  };

  // Supabase config
  const supabaseUrl = 'https://xomqaflhrtwbqghiwlnj.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5cHR5ZG5vdXlkZHp2cmZmYWJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NjY1ODUsImV4cCI6MjA2MzU0MjU4NX0.KGoyFjKsdI6N53QzNFJBPHfUGCGssHBSqfkPb4Q39-o'; // reemplaza con tu clave real
  const supabase = createClient(supabaseUrl, supabaseKey);

  // Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Función para renderizar miembros en la tabla
  function renderTabla(miembros) {
    const tbody = document.querySelector('#tabla-miembros tbody');
    tbody.innerHTML = ''; // Limpiar contenido anterior

    miembros.forEach((miembro) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><img src="${miembro.fotoURL || 'https://via.placeholder.com/50'}" width="50" height="50" style="border-radius: 5px;"></td>
        <td>${miembro.nombre || ''}</td>
        <td>${miembro.codigo || ''}</td>
        <td>
          <button onclick="editarMiembro('${miembro.id}')">Editar</button>
          <button onclick="darDeBaja('${miembro.id}')">Baja</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Función para cargar miembros desde Firestore
  async function cargarMiembros() {
    try {
      const querySnapshot = await getDocs(collection(db, 'miembros'));
      const miembros = [];

      for (const docSnap of querySnapshot.docs) {
        const data = docSnap.data();
        let fotoURL = data.fotoURL || '';

        // Si es solo nombre de archivo, construir URL pública desde Supabase
        if (fotoURL && !fotoURL.startsWith('http')) {
          const { data: publicUrlData } = supabase
            .storage
            .from('ftmember')
            .getPublicUrl(fotoURL);
          fotoURL = publicUrlData.publicUrl;
        }

        miembros.push({
          id: docSnap.id,
          ...data,
          fotoURL
        });
      }

      renderTabla(miembros);
    } catch (error) {
      console.error('Error al cargar miembros:', error);
    }
  }

  // Funciones básicas para los botones
  window.editarMiembro = (id) => {
    alert(`Editar miembro con ID: ${id}`);
    // Aquí puedes abrir el modal con los datos cargados
  };

  window.darDeBaja = async (id) => {
    try {
      await updateDoc(doc(db, 'miembros', id), {
        estado: 'baja'
      });
      alert('Miembro dado de baja');
      cargarMiembros();
    } catch (error) {
      console.error('Error al dar de baja:', error);
    }
  };

  // Cargar al iniciar
  cargarMiembros();
</script>

</body>
</html>
