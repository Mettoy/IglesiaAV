<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Miembros</title>
    <link rel="icon" href="logo.png" />

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>

    <style>
        /* Custom scrollbar for better aesthetics */
        body::-webkit-scrollbar {
            width: 8px;
        }
        body::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        body::-webkit-scrollbar-thumb {
            background-color: #fcd34d; /* yellow-400 */
            border-radius: 20px;
            border: 2px solid #1f2937;
        }

        /* Specific styles for date inputs to ensure text color */
        input[type="date"] {
            color-scheme: dark; /* For consistent dark mode date picker if supported by browser */
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* Makes the calendar icon white */
        }
        /* Style for the custom scrollbar in the familiares list */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #4b5563; /* gray-600 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #fcd34d; /* yellow-400 */
            border-radius: 10px;
            border: 1px solid #4b5563;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">

    <div class="flex min-h-screen">
        <aside class="w-60 bg-blue-950 p-4 shadow-lg flex flex-col justify-between animate__animated animate__fadeInLeft">
            <div>
                <div class="mb-8 mt-4">
                    <img src="logo.png" alt="Logo" class="w-28 mx-auto animate__animated animate__pulse animate__infinite" style="animation-duration: 3s;" />
                    <h1 class="text-center text-xl font-bold mt-2 text-yellow-400">SAI Admin</h1>
                </div>
                <nav>
                    <ul class="space-y-3 text-white text-lg">
                        <li>
                            <a href="#" class="block px-4 py-2 rounded transition-all duration-300 hover:bg-blue-800 hover:text-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                                <i class="fas fa-users mr-2"></i>Miembros
                            </a>
                        </li>
                        <li>
                            <a href="#" class="block px-4 py-2 rounded transition-all duration-300 hover:bg-blue-800 hover:text-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                                <i class="fas fa-calendar-alt mr-2"></i>Eventos
                            </a>
                        </li>
                        <li>
                            <a href="#" class="block px-4 py-2 rounded transition-all duration-300 hover:bg-blue-800 hover:text-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                                <i class="fas fa-vote-yea mr-2"></i>Votaciones
                            </a>
                        </li>
                        </ul>
                </nav>
            </div>
            <div class="mt-8 text-sm text-gray-400 text-center">
                &copy; 2024 SAI. Todos los derechos reservados.
            </div>
        </aside>

        <main class="flex-1 p-8 animate__animated animate__fadeInRight">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <button id="btnAgregarMiembro" class="bg-yellow-500 text-gray-900 px-6 py-3 rounded-lg shadow-md hover:bg-yellow-400 transition-colors duration-300 text-lg font-semibold w-full md:w-auto mb-4 md:mb-0 animate__animated animate__bounceIn">
                    <i class="fas fa-plus-circle mr-2"></i>Añadir Miembro
                </button>
                <div class="relative w-full md:w-80">
                    <input type="text" id="searchInput" placeholder="Buscar por nombre..." class="pl-10 pr-4 py-2 rounded-lg bg-gray-800 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full animate__animated animate__fadeIn" />
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>

            <div id="formContainer" class="bg-gray-800 rounded-lg shadow-xl p-8 mb-8 hidden">
                <form id="formMiembro" class="space-y-6">
                    <div>
                        <h2 class="text-yellow-400 text-2xl font-bold mb-4 flex items-center">
                            <i class="fas fa-user-circle mr-3"></i>Datos Personales
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div>
                                <label for="nombre" class="block text-gray-300 text-sm font-semibold mb-1">Nombre completo <span class="text-red-500">*</span></label>
                                <input id="nombre" name="nombre" type="text" placeholder="Nombre completo" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" required />
                            </div>
                            <div>
                                <label for="codigo" class="block text-gray-300 text-sm font-semibold mb-1">Código <span class="text-red-500">*</span></label>
                                <input id="codigo" name="codigo" type="text" placeholder="Código único" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" required />
                            </div>
                            <div>
                                <label for="edad" class="block text-gray-300 text-sm font-semibold mb-1">Edad</label>
                                <input id="edad" name="edad" type="number" placeholder="Edad" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" min="0" />
                            </div>
                            <div>
                                <label for="telefono" class="block text-gray-300 text-sm font-semibold mb-1">Teléfono</label>
                                <input id="telefono" name="telefono" type="tel" placeholder="Ej: +505 8888-7777" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <div>
                                <label for="direccion" class="block text-gray-300 text-sm font-semibold mb-1">Dirección</label>
                                <input id="direccion" name="direccion" type="text" placeholder="Dirección completa" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <div>
                                <label for="fechaNacimiento" class="block text-gray-300 text-sm font-semibold mb-1">Fecha de Nacimiento</label>
                                <input id="fechaNacimiento" name="fechaNacimiento" type="date" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <div class="col-span-1 md:col-span-2 lg:col-span-1">
                                <label for="fotoInput" class="block text-gray-300 text-sm font-semibold mb-1">Foto de Perfil</label>
                                <input type="file" id="fotoInput" name="foto" accept="image/*" class="w-full text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-500 file:cursor-pointer" />
                            </div>
                        </div>
                    </div>

                    <div>
                        <h2 class="text-yellow-400 text-2xl font-bold mb-4 flex items-center">
                            <i class="fas fa-family mr-3"></i>Datos Familiares
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-4">
                            <div>
                                <label for="tipoFamiliar" class="block text-gray-300 text-sm font-semibold mb-1">Tipo de Familiar</label>
                                <select id="tipoFamiliar" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full">
                                    <option value="">Seleccione tipo</option>
                                    <option value="Padre">Padre</option>
                                    <option value="Madre">Madre</option>
                                    <option value="Hermano">Hermano</option>
                                    <option value="Esposo/a">Esposo/a</option>
                                    <option value="Hijo/a">Hijo/a</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div>
                                <label for="nombreFamiliar" class="block text-gray-300 text-sm font-semibold mb-1">Nombre del Familiar</label>
                                <input id="nombreFamiliar" type="text" placeholder="Nombre completo del familiar" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <button type="button" id="btnAgregarFamiliar" class="bg-green-600 text-white px-5 py-3 rounded-lg hover:bg-green-500 transition-colors duration-300 self-end text-base">
                                <i class="fas fa-user-plus mr-2"></i>Agregar Familiar
                            </button>
                        </div>
                        <ul id="listaFamiliares" class="mt-2 space-y-2 max-h-40 overflow-y-auto pr-2 custom-scrollbar"></ul>
                    </div>

                    <div>
                        <h2 class="text-yellow-400 text-2xl font-bold mb-4 flex items-center">
                            <i class="fas fa-cross mr-3"></i>Datos Espirituales
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div>
                                <label for="fechaConversion" class="block text-gray-300 text-sm font-semibold mb-1">Fecha de Conversión</label>
                                <input id="fechaConversion" name="fechaConversion" type="date" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <div>
                                <label for="lugarConversion" class="block text-gray-300 text-sm font-semibold mb-1">Lugar de Conversión</label>
                                <input id="lugarConversion" name="lugarConversion" type="text" placeholder="Lugar donde se convirtió" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <div>
                                <label for="fechaBautismo" class="block text-gray-300 text-sm font-semibold mb-1">Fecha de Bautismo</label>
                                <input id="fechaBautismo" name="fechaBautismo" type="date" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <div>
                                <label for="lugarBautismo" class="block text-gray-300 text-sm font-semibold mb-1">Lugar de Bautismo</label>
                                <input id="lugarBautismo" name="lugarBautismo" type="text" placeholder="Lugar donde fue bautizado" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <div>
                                <label for="fechaEspiritu" class="block text-gray-300 text-sm font-semibold mb-1">Fecha Bautismo en el Espíritu</label>
                                <input id="fechaEspiritu" name="fechaEspiritu" type="date" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <div>
                                <label for="lugarEspiritu" class="block text-gray-300 text-sm font-semibold mb-1">Lugar Bautismo en el Espíritu</label>
                                <input id="lugarEspiritu" name="lugarEspiritu" type="text" placeholder="Lugar de bautismo en el Espíritu" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4 pt-4 border-t border-gray-700">
                        <button type="button" id="btnCancelForm" class="bg-gray-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-gray-500 transition-colors duration-300 font-semibold">
                            <i class="fas fa-times-circle mr-2"></i>Cancelar
                        </button>
                        <button type="submit" class="bg-yellow-500 text-gray-900 px-6 py-3 rounded-lg shadow-md hover:bg-yellow-400 transition-colors duration-300 font-semibold">
                            <i class="fas fa-save mr-2"></i>Guardar Miembro
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-gray-800 rounded-lg shadow-xl overflow-hidden animate__animated animate__fadeIn">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700 text-yellow-400 uppercase text-sm">
                            <tr>
                                <th class="px-6 py-3 text-left font-semibold tracking-wider">Foto</th>
                                <th class="px-6 py-3 text-left font-semibold tracking-wider">Nombre</th>
                                <th class="px-6 py-3 text-left font-semibold tracking-wider">Código</th>
                                <th class="px-6 py-3 text-left font-semibold tracking-wider">Edad</th>
                                <th class="px-6 py-3 text-left font-semibold tracking-wider">Teléfono</th>
                                <th class="px-6 py-3 text-left font-semibold tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaMiembros" class="divide-y divide-gray-700 text-white text-base">
                            <tr>
                                <td colspan="6" class="text-center py-6 text-gray-400">
                                    Cargando miembros...
                                    <i class="fas fa-spinner fa-spin text-yellow-500 text-3xl mb-2"></i>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="https://kit.fontawesome.com/your-font-awesome-kit-code.js" crossorigin="anonymous"></script>

    <script type="module">
        // Ensure all DOM interactions happen after the document is loaded
        document.addEventListener('DOMContentLoaded', () => {

            // =========================================================
            // 1. FIREBASE & SUPABASE CONFIGURATION
            // ** IMPORTANT! REPLACE THESE VALUES WITH YOUR PROJECT'S CREDENTIALS **
            // =========================================================
          const firebaseConfig = {
  apiKey: "AIzaSyAyfPQzO7evryWcQ5d1lGV3z8aB-gFOh_k",
  authDomain: "iglesia-adoracion-viva.firebaseapp.com",
  databaseURL: "https://iglesia-adoracion-viva-default-rtdb.firebaseio.com",
  projectId: "iglesia-adoracion-viva",
  storageBucket: "iglesia-adoracion-viva.firebasestorage.app",
  messagingSenderId: "815332010058",
  appId: "1:815332010058:web:d2afff616469349d88deb3",
  measurementId: "G-43MZP6V55D"
};

            const supabaseUrl = 'https://azywyqozwwbfctxeokug.supabase.co';
            const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6eXd5cW96d3diZmN0eGVva3VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNzM1NjAsImV4cCI6MjA2MjY0OTU2MH0.tzJiz2LKQcVTb94uncIrGMfi4NV9XwR7xR6lzP3EELk';

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const miembrosCollection = db.collection('miembros');

            // Initialize Supabase
            const supabase = createClient(supabaseUrl, supabaseAnonKey);
            const fotosBucket = 'fotos_miembros'; // Ensure this bucket exists in Supabase Storage

            // =========================================================
            // 2. DOM ELEMENT REFERENCES
            // =========================================================
            // All DOM element references are safely retrieved inside DOMContentLoaded
            const btnAgregarMiembro = document.getElementById('btnAgregarMiembro');
            const formContainer = document.getElementById('formContainer');
            const formMiembro = document.getElementById('formMiembro');
            const btnCancelForm = document.getElementById('btnCancelForm');
            const btnAgregarFamiliar = document.getElementById('btnAgregarFamiliar');
            const listaFamiliares = document.getElementById('listaFamiliares');
            const tablaMiembros = document.getElementById('tablaMiembros');
            const searchInput = document.getElementById('searchInput');
            const fotoInput = document.getElementById('fotoInput');

            // =========================================================
            // 3. GLOBAL VARIABLES AND STATE
            // =========================================================
            let familiaresData = []; // Temporarily stores family members for the current form
            let editingMemberId = null; // Stores the ID of the member being edited

            // =========================================================
            // 4. UTILITY & UI FUNCTIONS
            // =========================================================

            /**
             * Shows the form with an animation.
             */
            function showForm() {
                formContainer.classList.remove('hidden');
                formContainer.classList.remove('animate__fadeOutUp'); // Remove previous exit animation
                formContainer.classList.add('animate__animated', 'animate__fadeInDown'); // Add entry animation
                formMiembro.reset(); // Clear the form
                familiaresData = []; // Reset family members data
                renderFamiliares(); // Re-render the empty list
                editingMemberId = null; // Ensure we're adding a new member, not editing
            }

            /**
             * Hides the form with an animation.
             */
            function hideForm() {
                formContainer.classList.remove('animate__fadeInDown');
                formContainer.classList.add('animate__fadeOutUp'); // Add exit animation
                // Listen for the end of the animation to truly hide the element
                formContainer.addEventListener('animationend', function handler() {
                    if (formContainer.classList.contains('animate__fadeOutUp')) {
                        formContainer.classList.add('hidden');
                        formMiembro.reset(); // Clear form after animation
                        familiaresData = [];
                        renderFamiliares();
                        editingMemberId = null;
                    }
                    formContainer.removeEventListener('animationend', handler); // Remove the listener after execution
                }, { once: true }); // Ensure the listener runs only once
            }

            /**
             * Displays an alert using SweetAlert2.
             * @param {string} icon - 'success', 'error', 'warning', 'info', 'question'
             * @param {string} title - Title of the alert.
             * @param {string} text - Body text of the alert.
             */
            function showAlert(icon, title, text) {
                Swal.fire({
                    icon: icon,
                    title: title,
                    text: text,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer);
                        toast.addEventListener('mouseleave', Swal.resumeTimer);
                    }
                });
            }

            /**
             * Displays a confirmation dialog using SweetAlert2.
             * @param {string} title - Title of the confirmation.
             * @param {string} text - Body text of the confirmation.
             * @returns {Promise<boolean>} - True if confirmed, false if cancelled.
             */
            async function showConfirm(title, text) {
                const result = await Swal.fire({
                    title: title,
                    text: text,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí, continuar',
                    cancelButtonText: 'No, cancelar'
                });
                return result.isConfirmed;
            }

            /**
             * Renders the list of family members in the form.
             */
            function renderFamiliares() {
                listaFamiliares.innerHTML = ''; // Clear current list
                if (familiaresData.length === 0) {
                    listaFamiliares.innerHTML = '<li class="text-gray-500 italic p-2">No hay familiares agregados.</li>';
                    return;
                }
                familiaresData.forEach((familiar, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-lg mb-2 shadow-sm animate__animated animate__fadeIn';
                    li.innerHTML = `
                        <span><strong>${familiar.tipo}:</strong> ${familiar.nombre}</span>
                        <button type="button" data-index="${index}" class="btn-eliminar-familiar text-red-400 hover:text-red-600 ml-4 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-400">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    listaFamiliares.appendChild(li);
                });

                // Add event listeners to delete buttons
                document.querySelectorAll('.btn-eliminar-familiar').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = e.currentTarget.dataset.index;
                        familiaresData.splice(index, 1);
                        renderFamiliares(); // Re-render the list
                        showAlert('info', 'Familiar Eliminado', 'El familiar ha sido retirado de la lista.');
                    });
                });
            }

            // =========================================================
            // 5. PHOTO MANAGEMENT (SUPABASE STORAGE)
            // =========================================================

            /**
             * Uploads an image file to Supabase Storage.
             * @param {File} file - The image file to upload.
             * @returns {Promise<string|null>} - The public URL of the photo or null if it fails.
             */
            async function uploadPhoto(file) {
                if (!file) return null;

                const uniqueFileName = `${Luxon.DateTime.now().toMillis()}_${file.name}`; // Unique name with timestamp
                const filePath = uniqueFileName;

                try {
                    const { data, error } = await supabase.storage
                        .from(fotosBucket)
                        .upload(filePath, file, {
                            cacheControl: '3600',
                            upsert: false // Do not overwrite if it already exists
                        });

                    if (error) throw error;

                    // Get the public URL
                    const { data: publicURLData } = supabase.storage
                        .from(fotosBucket)
                        .getPublicUrl(filePath);

                    if (publicURLData && publicURLData.publicUrl) {
                        return publicURLData.publicUrl;
                    } else {
                        console.error('Error: Could not get public URL for the photo.');
                        return null;
                    }
                } catch (error) {
                    showAlert('error', 'Error de Subida', `No se pudo subir la foto: ${error.message}`);
                    console.error('Error uploading photo to Supabase:', error);
                    return null;
                }
            }

            /**
             * Deletes a photo from Supabase Storage.
             * @param {string} photoUrl - The public URL of the photo to delete.
             */
            async function deletePhoto(photoUrl) {
                if (!photoUrl) return;

                try {
                    // Extract the file path from the public URL
                    // Example: https://[project_id].supabase.co/storage/v1/object/public/fotos_miembros/timestamp_name.png
                    const parts = photoUrl.split(`/${fotosBucket}/`);
                    if (parts.length < 2) {
                        console.warn('Invalid photo URL for deletion:', photoUrl);
                        return;
                    }
                    const filePath = parts[1];

                    const { error } = await supabase.storage
                        .from(fotosBucket)
                        .remove([filePath]);

                    if (error) throw error;
                    console.log('Photo deleted from Supabase:', filePath);

                } catch (error) {
                    showAlert('error', 'Error al Eliminar Foto', `No se pudo eliminar la foto anterior: ${error.message}`);
                    console.error('Error deleting photo from Supabase:', error);
                }
            }

            // =========================================================
            // 6. CRUD OPERATIONS (FIRESTORE)
            // =========================================================

            /**
             * Saves a new member or updates an existing one in Firestore.
             * Handles photo upload/deletion in Supabase.
             * @param {Event} event - The form submission event.
             */
            async function saveMiembro(event) {
                event.preventDefault(); // Prevents traditional form submission

                const formElements = formMiembro.elements;
                const miembroData = {};

                // Collect form data
                for (let i = 0; i < formElements.length; i++) {
                    const element = formElements[i];
                    if (element.name && element.id !== 'fotoInput') { // Exclude file input
                        miembroData[element.name] = element.value.trim();
                    }
                }

                // Validate required fields
                if (!miembroData.nombre || !miembroData.codigo) {
                    showAlert('error', 'Campos Obligatorios', 'El nombre y el código son obligatorios.');
                    return;
                }

                // Ensure age is a number
                miembroData.edad = parseInt(miembroData.edad) || null; // Convert to number or null

                // Add family members
                miembroData.familiares = familiaresData;

                // Get the photo file
                const file = fotoInput.files[0];
                let photoUrl = null;

                // Start loading animation with SweetAlert2
                Swal.fire({
                    title: 'Guardando Miembro...',
                    text: 'Por favor, espere.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                try {
                    if (file) {
                        photoUrl = await uploadPhoto(file);
                        if (photoUrl) {
                            miembroData.fotoUrl = photoUrl;
                        } else {
                            // If photo upload fails, close the alert and exit.
                            Swal.close();
                            showAlert('error', 'Error de Foto', 'No se pudo subir la foto. Inténtelo de nuevo.');
                            return;
                        }
                    }

                    if (editingMemberId) {
                        // Update existing member
                        const memberRef = miembrosCollection.doc(editingMemberId);
                        const currentMemberSnapshot = await memberRef.get();
                        const currentMemberData = currentMemberSnapshot.data();
                        const oldPhotoUrl = currentMemberData ? currentMemberData.fotoUrl : null;

                        // Logic to handle photo when updating:
                        if (file) { // If a new photo has been selected
                            if (oldPhotoUrl && oldPhotoUrl !== photoUrl) {
                                // If there was an old photo and it's different from the new one, delete the old one
                                await deletePhoto(oldPhotoUrl);
                            }
                            miembroData.fotoUrl = photoUrl; // Use the URL of the newly uploaded photo
                        } else { // No new photo has been selected
                            if (oldPhotoUrl) {
                                // Keep the old photo if it existed
                                miembroData.fotoUrl = oldPhotoUrl;
                            } else {
                                // If there was no photo before and no new one is uploaded, ensure the field doesn't exist or is null
                                delete miembroData.fotoUrl;
                            }
                        }

                        await memberRef.update(miembroData);
                        showAlert('success', '¡Actualizado!', 'Miembro actualizado exitosamente.');

                    } else {
                        // Create new member
                        miembroData.createdAt = firebase.firestore.FieldValue.serverTimestamp(); // Creation date
                        await miembrosCollection.add(miembroData);
                        showAlert('success', '¡Registrado!', 'Miembro agregado exitosamente.');
                    }

                    Swal.close(); // Close the SweetAlert loading animation
                    hideForm(); // Hide the form
                    loadMiembros(); // Reload the table
                } catch (error) {
                    Swal.close(); // Ensure loading alert is closed on error
                    showAlert('error', 'Error al Guardar', `No se pudo guardar el miembro: ${error.message}`);
                    console.error("Error saving member: ", error);
                }
            }

            /**
             * Loads and displays members from Firestore in the table.
             * Allows searching by name.
             * @param {string} searchTerm - Search term (optional).
             */
            async function loadMiembros(searchTerm = '') {
                // Show loading animation in the table
                tablaMiembros.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-6 text-gray-400">
                            <i class="fas fa-spinner fa-spin text-yellow-500 text-3xl mb-2"></i>
                            <p>Cargando miembros...</p>
                        </td>
                    </tr>
                `;

                try {
                    let query = miembrosCollection.orderBy('nombre');

                    if (searchTerm) {
                        // "Starts with" search simulation in Firestore
                        // Firestore does not support "starts with" queries directly, but this pattern
                        // works for basic prefix matching if you ensure the `nombre` field is indexed.
                        const endTerm = searchTerm + '\uf8ff'; // \uf8ff is a special unicode character greater than any possible character
                        query = query.where('nombre', '>=', searchTerm).where('nombre', '<=', endTerm);
                    }

                    const snapshot = await query.get();
                    tablaMiembros.innerHTML = ''; // Clear the table before adding rows

                    if (snapshot.empty) {
                        tablaMiembros.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center py-6 text-gray-400 animate__animated animate__fadeIn">
                                    <i class="fas fa-box-open text-5xl mb-3"></i>
                                    <p>No hay miembros registrados.</p>
                                    <p class="text-sm">¡Añade uno para empezar!</p>
                                </td>
                            </tr>
                        `;
                        return;
                    }

                    snapshot.forEach(doc => {
                        const miembro = doc.data();
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-gray-700 transition-colors duration-200 animate__animated animate__fadeInUp'; // Animation for each row
                        tr.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <img src="${miembro.fotoUrl || 'https://via.placeholder.com/48?text=No+Foto'}" alt="${miembro.nombre}"
                                     class="w-12 h-12 rounded-full object-cover border-2 border-yellow-500 shadow-md">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap font-medium">${miembro.nombre}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-300">${miembro.codigo}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${miembro.edad || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${miembro.telefono || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button data-id="${doc.id}" class="btn-editar bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-500 transition-colors duration-200 mr-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button data-id="${doc.id}" data-foto-url="${miembro.fotoUrl || ''}" class="btn-eliminar bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-500 transition-colors duration-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-red-400">
                                    <i class="fas fa-trash-alt"></i> Eliminar
                                </button>
                            </td>
                        `;
                        tablaMiembros.appendChild(tr);
                    });

                    // Add event listeners to edit and delete buttons
                    document.querySelectorAll('.btn-editar').forEach(button => {
                        button.addEventListener('click', (e) => editMiembro(e.currentTarget.dataset.id));
                    });
                    document.querySelectorAll('.btn-eliminar').forEach(button => {
                        button.addEventListener('click', (e) => deleteMiembro(e.currentTarget.dataset.id, e.currentTarget.dataset.fotoUrl));
                    });

                } catch (error) {
                    showAlert('error', 'Error de Carga', `No se pudieron cargar los miembros: ${error.message}`);
                    console.error("Error loading members: ", error);
                    tablaMiembros.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-6 text-red-500 animate__animated animate__shakeX">
                                <i class="fas fa-exclamation-triangle text-4xl mb-2"></i>
                                <p>¡Ups! Hubo un problema al cargar los datos.</p>
                            </td>
                        </tr>
                    `;
                }
            }

            /**
             * Loads a member's data into the form for editing.
             * @param {string} id - The Firestore document ID of the member.
             */
            async function editMiembro(id) {
                // Start loading SweetAlert
                Swal.fire({
                    title: 'Cargando datos...',
                    text: 'Preparando formulario para edición.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                try {
                    const doc = await miembrosCollection.doc(id).get();
                    if (doc.exists) {
                        const miembro = doc.data();
                        editingMemberId = id; // Set the ID for editing
                        showForm(); // Show the form

                        // Populate form fields
                        document.getElementById('nombre').value = miembro.nombre || '';
                        document.getElementById('codigo').value = miembro.codigo || '';
                        document.getElementById('edad').value = miembro.edad || '';
                        document.getElementById('telefono').value = miembro.telefono || '';
                        document.getElementById('direccion').value = miembro.direccion || '';
                        document.getElementById('fechaNacimiento').value = miembro.fechaNacimiento || '';

                        document.getElementById('fechaConversion').value = miembro.fechaConversion || '';
                        document.getElementById('lugarConversion').value = miembro.lugarConversion || '';
                        document.getElementById('fechaBautismo').value = miembro.fechaBautismo || '';
                        document.getElementById('lugarBautismo').value = miembro.lugarBautismo || '';
                        document.getElementById('fechaEspiritu').value = miembro.fechaEspiritu || '';
                        document.getElementById('lugarEspiritu').value = miembro.lugarEspiritu || '';

                        // Load family members
                        familiaresData = miembro.familiares || [];
                        renderFamiliares();

                        Swal.close(); // Close SweetAlert loading
                        showAlert('info', 'Editando Miembro', `Cargando datos de ${miembro.nombre}.`);
                    } else {
                        Swal.close();
                        showAlert('error', 'No Encontrado', 'Miembro no encontrado.');
                    }
                } catch (error) {
                    Swal.close();
                    showAlert('error', 'Error de Edición', `Error al cargar datos del miembro: ${error.message}`);
                    console.error("Error editing member: ", error);
                }
            }

            /**
             * Deletes a member from Firestore and their photo from Supabase Storage.
             * @param {string} id - The Firestore document ID of the member.
             * @param {string} photoUrl - The URL of the member's photo (can be empty).
             */
            async function deleteMiembro(id, photoUrl) {
                const confirmed = await showConfirm('Confirmar Eliminación', '¿Está seguro de que desea eliminar este miembro? Esta acción es irreversible.');

                if (confirmed) {
                    // Start loading SweetAlert
                    Swal.fire({
                        title: 'Eliminando Miembro...',
                        text: 'Por favor, espere.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    try {
                        await miembrosCollection.doc(id).delete();
                        // Only try to delete the photo if a valid URL exists and it's not the placeholder
                        if (photoUrl && photoUrl !== 'https://via.placeholder.com/48?text=No+Foto') {
                            await deletePhoto(photoUrl); // Delete photo from Supabase
                        }
                        Swal.close();
                        showAlert('success', '¡Eliminado!', 'Miembro eliminado exitosamente.');
                        loadMiembros(); // Reload the table
                    } catch (error) {
                        Swal.close();
                        showAlert('error', 'Error al Eliminar', `No se pudo eliminar el miembro: ${error.message}`);
                        console.error("Error deleting member: ", error);
                    }
                }
            }

            // =========================================================
            // 7. EVENT LISTENERS (REGISTERED INSIDE DOMContentLoaded)
            // =========================================================

            // "Add Member" button
            btnAgregarMiembro.addEventListener('click', showForm);

            // "Cancel" button in the form
            btnCancelForm.addEventListener('click', hideForm);

            // Form submission
            formMiembro.addEventListener('submit', saveMiembro);

            // "Add Family Member" button
            btnAgregarFamiliar.addEventListener('click', () => {
                const tipo = document.getElementById('tipoFamiliar').value;
                const nombre = document.getElementById('nombreFamiliar').value.trim();

                if (tipo && nombre) {
                    familiaresData.push({ tipo, nombre });
                    renderFamiliares();
                    document.getElementById('tipoFamiliar').value = ''; // Clear fields
                    document.getElementById('nombreFamiliar').value = '';
                    showAlert('success', 'Familiar Agregado', 'Familiar añadido a la lista temporal.');
                } else {
                    showAlert('warning', 'Campos Incompletos', 'Por favor, seleccione un tipo y escriba el nombre del familiar.');
                }
            });

            // Real-time search
            searchInput.addEventListener('input', () => {
                loadMiembros(searchInput.value.trim());
            });

            // =========================================================
            // 8. INITIALIZATION (CALLED AFTER DOMContentLoaded)
            // =========================================================
            loadMiembros(); // Load members when the page loads
        }); // End of document.addEventListener('DOMContentLoaded')
    </script>
</body>
</html>
