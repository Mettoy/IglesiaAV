<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestión de Miembros</title>

<style>
  /* (mismo CSS que me diste, lo dejo para no repetirlo aquí) */
  body {
    background-color: #0d1a33; /* azul oscuro */
    color: #d4af37; /* dorado */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0;
  }
  header {
    background-color: #09214d;
    padding: 1rem;
    text-align: center;
    font-size: 1.8rem;
    font-weight: bold;
    color: #d4af37;
  }
  main {
    max-width: 1100px;
    margin: 2rem auto;
    padding: 1rem;
  }
  form {
    background-color: #14325c;
    padding: 1rem 2rem;
    border-radius: 8px;
    margin-bottom: 2rem;
  }
  form h2 {
    border-bottom: 1px solid #d4af37;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
  }
  form section {
    margin-bottom: 1.5rem;
  }
  label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: 600;
  }
  input[type="text"],
  input[type="number"],
  input[type="tel"],
  input[type="date"],
  select {
    width: 100%;
    padding: 0.5rem;
    border-radius: 4px;
    border: none;
    margin-bottom: 0.8rem;
    font-size: 1rem;
  }
  input[type="file"] {
    margin-top: 0.4rem;
    margin-bottom: 1rem;
  }
  button {
    background-color: #d4af37;
    color: #0d1a33;
    font-weight: 700;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:disabled {
    background-color: #999;
    cursor: not-allowed;
  }
  button:hover:not(:disabled) {
    background-color: #b79023;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background-color: #14325c;
    border-radius: 8px;
    overflow: hidden;
  }
  thead {
    background-color: #0a1b3a;
  }
  th, td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid #d4af37;
    vertical-align: middle;
  }
  img.foto-miembro {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 50%;
    border: 2px solid #d4af37;
  }
  .busqueda-container {
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #busqueda-miembros {
    padding: 0.5rem 1rem;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    width: 300px;
  }
</style>
</head>
<body>
  <header>Gestión de Miembros</header>
  <main>
    <div class="busqueda-container">
      <button id="btn-agregar-miembro">Añadir Miembro</button>
      <input type="text" id="busqueda-miembros" placeholder="Buscar por nombre o código..." />
    </div>

    <form id="form-miembro" style="display:none;">
      <!-- Datos Personales -->
      <section>
        <h2>Datos Personales</h2>
        <label for="nombre">Nombre Completo</label>
        <input type="text" id="nombre" name="nombre" required />

        <label for="codigo">Código</label>
        <input type="text" id="codigo" name="codigo" required />

        <label for="edad">Edad</label>
        <input type="number" id="edad" name="edad" required min="0" />

        <label for="telefono">Teléfono</label>
        <input type="tel" id="telefono" name="telefono" required />

        <label for="direccion">Dirección</label>
        <input type="text" id="direccion" name="direccion" required />

        <label for="fechaNacimiento">Fecha de Nacimiento</label>
        <input type="date" id="fechaNacimiento" name="fechaNacimiento" required />
      </section>

      <!-- Datos Familiares -->
      <section>
        <h2>Datos Familiares</h2>
        <label for="tipoFamiliar">Tipo de Familiar</label>
        <select id="tipoFamiliar" name="tipoFamiliar">
          <option value="">Seleccione...</option>
          <option value="Padre">Padre</option>
          <option value="Madre">Madre</option>
          <option value="Hermano">Hermano</option>
          <option value="Hermana">Hermana</option>
          <option value="Hijo">Hijo</option>
          <option value="Hija">Hija</option>
          <option value="Otro">Otro</option>
        </select>

        <label for="nombreFamiliar">Nombre del Familiar</label>
        <input type="text" id="nombreFamiliar" name="nombreFamiliar" />

        <button type="button" id="btn-agregar-familiar">Agregar Familiar</button>

        <ul id="lista-familiares" style="margin-top: 1rem; color: #fff;"></ul>
      </section>

      <!-- Datos Espirituales -->
      <section>
        <h2>Datos Espirituales</h2>

        <label for="fechaConversion">Fecha de Conversión</label>
        <input type="date" id="fechaConversion" name="fechaConversion" />

        <label for="lugarConversion">Lugar de Conversión</label>
        <input type="text" id="lugarConversion" name="lugarConversion" />

        <label for="fechaBautismo">Fecha de Bautismo</label>
        <input type="date" id="fechaBautismo" name="fechaBautismo" />

        <label for="lugarBautismo">Lugar de Bautismo</label>
        <input type="text" id="lugarBautismo" name="lugarBautismo" />

        <label for="fechaBautismoEspiritu">Fecha de Bautismo en el Espíritu</label>
        <input type="date" id="fechaBautismoEspiritu" name="fechaBautismoEspiritu" />

        <label for="lugarBautismoEspiritu">Lugar de Bautismo en el Espíritu</label>
        <input type="text" id="lugarBautismoEspiritu" name="lugarBautismoEspiritu" />
      </section>

      <!-- Foto -->
      <section>
        <h2>Foto</h2>
        <input type="file" id="foto" name="foto" accept="image/*" />
      </section>

      <button id="btn-guardar" type="submit">Guardar</button>
    </form>

    <table>
      <thead>
        <tr>
          <th>Foto</th>
          <th>Nombre</th>
          <th>Código</th>
          <th>Edad</th>
          <th>Teléfono</th>
          <th>Dirección</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-miembros"></tbody>
    </table>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <!-- Supabase -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // Configura tu Supabase aquí
    const supabaseUrl = 'https://azywyqozwwbfctxeokug.supabase.co' // Cambia por tu URL real
    const supabaseAnonKey = 'TU_ANON_KEY_AQUI' // Cambia por tu anon key real
    const supabase = createClient(supabaseUrl, supabaseAnonKey)

    // Configura Firebase
    const firebaseConfig = {
      apiKey: "TU_API_KEY_FIREBASE",
      authDomain: "TU_AUTH_DOMAIN_FIREBASE",
      projectId: "TU_PROJECT_ID_FIREBASE",
      // el resto según tu configuración
    };

    firebase.initializeApp(firebaseConfig)
    const db = firebase.firestore()

    // Elementos
    const form = document.getElementById('form-miembro')
    const inputFoto = document.getElementById('foto')
    const tabla = document.getElementById('tabla-miembros')
    const btnGuardar = document.getElementById('btn-guardar')
    const inputBusqueda = document.getElementById('busqueda-miembros')
    const btnAgregarMiembro = document.getElementById('btn-agregar-miembro')

    const listaFamiliares = document.getElementById('lista-familiares')
    const btnAgregarFamiliar = document.getElementById('btn-agregar-familiar')
    const inputTipoFamiliar = document.getElementById('tipoFamiliar')
    const inputNombreFamiliar = document.getElementById('nombreFamiliar')
    let familiares = []

    let miembros = []
    let editandoId = null

    // Mostrar formulario al hacer click en Añadir Miembro
    btnAgregarMiembro.addEventListener('click', () => {
      form.style.display = 'block'
      form.reset()
      familiares = []
      actualizarListaFamiliares()
      editandoId = null
    })

    // Agregar familiar a la lista temporal
    btnAgregarFamiliar.addEventListener('click', () => {
      const tipo = inputTipoFamiliar.value.trim()
      const nombre = inputNombreFamiliar.value.trim()
      if (!tipo || !nombre) {
        alert('Por favor selecciona tipo y nombre del familiar')
        return
      }
      familiares.push({ tipo, nombre })
      actualizarListaFamiliares()
      inputTipoFamiliar.value = ''
      inputNombreFamiliar.value = ''
    })

    // Actualizar lista visibles de familiares en el formulario
    function actualizarListaFamiliares() {
      listaFamiliares.innerHTML = ''
      familiares.forEach((fam) => {
        const li = document.createElement('li')
        li.textContent = `${fam.tipo}: ${fam.nombre}`
        listaFamiliares.appendChild(li)
      })
    }

    // Cargar miembros desde Firestore
    async function cargarMiembros() {
      const snapshot = await db.collection('miembros').orderBy('codigo').get()
      miembros = snapshot.docs.map(doc => {
        return { id: doc.id, ...doc.data() }
      })
      mostrarMiembros(miembros)
    }

    // Mostrar miembros en la tabla
    function mostrarMiembros(datos) {
      tabla.innerHTML = ''
      for (const miembro of datos) {
        const fotoUrl = miembro.fotoUrl || ''

        tabla.innerHTML += `
          <tr>
            <td>${fotoUrl ? `<img src="${fotoUrl}" alt="Foto" class="foto-miembro">` : ''}</td>
            <td>${miembro.nombre || ''}</td>
            <td>${miembro.codigo || ''}</td>
            <td>${miembro.edad || ''}</td>
            <td>${miembro.telefono || ''}</td>
            <td>${miembro.direccion || ''}</td>
            <td>
              <button class="btn-editar" data-id="${miembro.id}">Editar</button>
              <button class="btn-eliminar" data-id="${miembro.id}">Eliminar</button>
            </td>
          </tr>
        `
      }
      // Asociar eventos de editar y eliminar
      document.querySelectorAll('.btn-editar').forEach(btn => {
        btn.addEventListener('click', e => {
          const id = e.target.dataset.id
          editarMiembro(id)
        })
      })
      document.querySelectorAll('.btn-eliminar').forEach(btn => {
        btn.addEventListener('click', async e => {
          const id = e.target.dataset.id
          if (confirm('¿Seguro que quieres eliminar este miembro?')) {
            await db.collection('miembros').doc(id).delete()
            cargarMiembros()
          }
        })
      })
    }

    // Editar miembro
    function editarMiembro(id) {
      const miembro = miembros.find(m => m.id === id)
      if (!miembro) return

      form.style.display = 'block'
      editandoId = id

      form.nombre.value = miembro.nombre || ''
      form.codigo.value = miembro.codigo || ''
      form.edad.value = miembro.edad || ''
      form.telefono.value = miembro.telefono || ''
      form.direccion.value = miembro.direccion || ''
      form.fechaNacimiento.value = miembro.fechaNacimiento || ''

      // Familiares
      familiares = miembro.familiares || []
      actualizarListaFamiliares()

      // Datos espirituales
      form.fechaConversion.value = miembro.fechaConversion || ''
      form.lugarConversion.value = miembro.lugarConversion || ''
      form.fechaBautismo.value = miembro.fechaBautismo || ''
      form.lugarBautismo.value = miembro.lugarBautismo || ''
      form.fechaBautismoEspiritu.value = miembro.fechaBautismoEspiritu || ''
      form.lugarBautismoEspiritu.value = miembro.lugarBautismoEspiritu || ''
    }

    // Buscar miembros
    inputBusqueda.addEventListener('input', () => {
      const valor = inputBusqueda.value.toLowerCase()
      const filtrados = miembros.filter(m =>
        (m.nombre && m.nombre.toLowerCase().includes(valor)) ||
        (m.codigo && m.codigo.toLowerCase().includes(valor))
      )
      mostrarMiembros(filtrados)
    })

    // Subir foto a Supabase y obtener URL pública
    async function subirFotoYObtenerURL(file, codigo) {
      if (!file) return ''

      // Renombrar archivo para evitar duplicados: ejemplo codigo + timestamp + extension
      const extension = file.name.split('.').pop()
      const nombreArchivo = `${codigo}_${Date.now()}.${extension}`

      const { data, error } = await supabase.storage
        .from('miembros')
        .upload(nombreArchivo, file, { upsert: true })

      if (error) {
        alert('Error subiendo la foto: ' + error.message)
        return ''
      }

      // URL pública directa
      const urlPublica = `${supabaseUrl}/storage/v1/object/public/miembros/${nombreArchivo}`
      return urlPublica
    }

    // Guardar formulario
    form.addEventListener('submit', async (e) => {
      e.preventDefault()
      btnGuardar.disabled = true

      const formData = new FormData(form)
      const codigo = formData.get('codigo').trim()

      if (!codigo) {
        alert('El código es obligatorio.')
        btnGuardar.disabled = false
        return
      }

      // Verificar si ya existe el código y no es edición
      if (!editandoId && miembros.find(m => m.codigo === codigo)) {
        alert('Ya existe un miembro con ese código.')
        btnGuardar.disabled = false
        return
      }

      // Subir foto si hay archivo
      let fotoUrl = ''
      const archivoFoto = inputFoto.files[0]
      if (archivoFoto) {
        fotoUrl = await subirFotoYObtenerURL(archivoFoto, codigo)
      } else if (editandoId) {
        // Si está editando y no cambia foto, mantener la existente
        const miembroActual = miembros.find(m => m.id === editandoId)
        fotoUrl = miembroActual ? miembroActual.fotoUrl : ''
      }

      // Preparar objeto a guardar
      const miembroData = {
        nombre: formData.get('nombre'),
        codigo,
        edad: Number(formData.get('edad')),
        telefono: formData.get('telefono'),
        direccion: formData.get('direccion'),
        fechaNacimiento: formData.get('fechaNacimiento'),
        familiares,
        fechaConversion: formData.get('fechaConversion'),
        lugarConversion: formData.get('lugarConversion'),
        fechaBautismo: formData.get('fechaBautismo'),
        lugarBautismo: formData.get('lugarBautismo'),
        fechaBautismoEspiritu: formData.get('fechaBautismoEspiritu'),
        lugarBautismoEspiritu: formData.get('lugarBautismoEspiritu'),
        fotoUrl,
      }

      try {
        if (editandoId) {
          await db.collection('miembros').doc(editandoId).set(miembroData)
          alert('Miembro actualizado correctamente.')
        } else {
          await db.collection('miembros').add(miembroData)
          alert('Miembro agregado correctamente.')
        }
        form.reset()
        familiares = []
        actualizarListaFamiliares()
        form.style.display = 'none'
        editandoId = null
        cargarMiembros()
      } catch (error) {
        alert('Error guardando el miembro: ' + error.message)
      } finally {
        btnGuardar.disabled = false
      }
    })

    // Carga inicial
    cargarMiembros()
  </script>
</body>
</html>
