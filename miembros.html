<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Miembros - Adoraci√≥n Viva</title>
  <link rel="stylesheet" href="estilos.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <aside id="sidebar">
    <img id="logo" src="logo_predeterminado.png" alt="Logo" />
    <h2>ADORACI√ìN VIVA</h2>
    <nav>
      <ul>
        <li><a href="inicio.html">Inicio</a></li>
        <li><a href="miembros.html">Miembros</a></li>
        <li><a href="disipulado.html">Discipulado</a></li>
        <!-- M√°s opciones -->
      </ul>
    </nav>
    <p id="userRol"></p>
    <button onclick="cerrarSesion()">Cerrar sesi√≥n</button>
  </aside>

  <main>
    <h1>Gesti√≥n de Miembros</h1>
    <button onclick="abrirFormulario()">‚ûï Agregar miembro</button>
    <table id="tablaMiembros">
      <thead>
        <tr>
          <th>Foto</th>
          <th>Nombre completo</th>
          <th>C√≥digo</th>
          <th>Edad</th>
          <th>Direcci√≥n</th>
          <th>Sociedad</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="contenidoTabla"></tbody>
    </table>
  </main>

  <div id="formularioModal" style="display: none">
    <form id="formularioMiembro">
      <h2>Datos Personales</h2>
      <input type="text" id="nombre" placeholder="Nombre completo" required />
      <input type="text" id="codigo" placeholder="C√≥digo" required />
      <input type="number" id="edad" placeholder="Edad" required />
      <input type="text" id="direccion" placeholder="Direcci√≥n" required />
      <input type="text" id="sociedad" placeholder="Sociedad" required />

      <h2>Datos Familiares</h2>
      <input type="text" id="nombrePadre" placeholder="Nombre del padre" />
      <input type="text" id="nombreMadre" placeholder="Nombre de la madre" />

      <h2>Datos Espirituales</h2>
      <input type="text" id="bautizado" placeholder="¬øBautizado? (S√≠/No)" />
      <input type="date" id="fechaBautismo" placeholder="Fecha de bautismo" />

      <input type="file" id="fotoInput" accept="image/*" />
      <button type="submit">Guardar</button>
      <button type="button" onclick="cerrarFormulario()">Cancelar</button>
    </form>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAyfPQzO7evryWcQ5d1lGV3z8aB-gFOh_k",
      authDomain: "iglesia-adoracion-viva.firebaseapp.com",
      projectId: "iglesia-adoracion-viva",
      storageBucket: "iglesia-adoracion-viva.appspot.com",
      messagingSenderId: "815332010058",
      appId: "1:815332010058:web:d2afff616469349d88deb3",
      measurementId: "G-43MZP6V55D"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const tabla = document.getElementById("contenidoTabla");
    const formulario = document.getElementById("formularioMiembro");

    formulario.addEventListener("submit", async (e) => {
      e.preventDefault();
      const miembro = {
        nombre: nombre.value,
        codigo: codigo.value,
        edad: edad.value,
        direccion: direccion.value,
        sociedad: sociedad.value,
        nombrePadre: nombrePadre.value,
        nombreMadre: nombreMadre.value,
        bautizado: bautizado.value,
        fechaBautismo: fechaBautismo.value,
        foto: ""
      };

      // Subida de foto
      const file = document.getElementById("fotoInput").files[0];
      if (file) {
        const reader = new FileReader();
        reader.onloadend = async () => {
          miembro.foto = reader.result;
          await db.collection("miembros").add(miembro);
          cerrarFormulario();
        };
        reader.readAsDataURL(file);
      } else {
        await db.collection("miembros").add(miembro);
        cerrarFormulario();
      }
    });

    function abrirFormulario() {
      document.getElementById("formularioModal").style.display = "block";
    }

    function cerrarFormulario() {
      document.getElementById("formularioModal").style.display = "none";
      formulario.reset();
    }

    function renderMiembro(doc) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><img src="${doc.data().foto}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%; cursor: pointer;" onclick="cambiarFoto('${doc.id}')" /></td>
        <td>${doc.data().nombre}</td>
        <td contenteditable onblur="actualizarCampo('${doc.id}', 'codigo', this.innerText)">${doc.data().codigo}</td>
        <td>${doc.data().edad}</td>
        <td>${doc.data().direccion}</td>
        <td>${doc.data().sociedad}</td>
        <td>
          <button onclick="editarMiembro('${doc.id}')">‚úèÔ∏è</button>
          <button onclick="eliminarMiembro('${doc.id}')">üóëÔ∏è</button>
        </td>
      `;
      tabla.appendChild(tr);
    }

    function cargarMiembros() {
      tabla.innerHTML = "";
      db.collection("miembros").onSnapshot((snapshot) => {
        tabla.innerHTML = "";
        snapshot.forEach(renderMiembro);
      });
    }

    function actualizarCampo(id, campo, valor) {
      db.collection("miembros").doc(id).update({ [campo]: valor });
    }

    function eliminarMiembro(id) {
      db.collection("miembros").doc(id).delete();
    }

    function cambiarFoto(id) {
      const nuevaFoto = document.createElement("input");
      nuevaFoto.type = "file";
      nuevaFoto.accept = "image/*";
      nuevaFoto.onchange = async () => {
        const file = nuevaFoto.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            db.collection("miembros").doc(id).update({ foto: reader.result });
          };
          reader.readAsDataURL(file);
        }
      };
      nuevaFoto.click();
    }

    function editarMiembro(id) {
      // Aqu√≠ puedes cargar los datos al formulario si quieres permitir edici√≥n completa
      alert("Funci√≥n de edici√≥n detallada a√∫n no implementada.");
    }

    function cerrarSesion() {
      localStorage.removeItem("usuario");
      location.href = "index.html";
    }

    window.onload = cargarMiembros;
  </script>
</body>
</html>
