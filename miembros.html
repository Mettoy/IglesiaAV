<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión de Miembros</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      background-color: #f5f6fa;
      font-family: "Segoe UI", sans-serif;
    }
    .content {
      padding: 20px;
      max-width: 1100px;
      margin: auto;
    }
    .btn-add {
      background-color: #ffcc00;
      color: black;
      font-weight: bold;
      border: none;
    }
    .form-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }
    th {
      background-color: #001f3f;
      color: white;
      vertical-align: middle;
    }
    td img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.3s ease;
    }
    td img:hover {
      border-color: #ffcc00;
    }
    .btn-action {
      background-color: #ffcc00;
      border: none;
      color: black;
      padding: 5px 10px;
      margin-right: 5px;
      cursor: pointer;
    }
    .file-upload-input {
      display: none;
    }
  </style>
</head>
<body>
  <div class="content">
    <h2>Gestión de Miembros</h2>
    <div class="text-center">
      <button class="btn btn-add" onclick="toggleForm()">+ Agregar miembro</button>
    </div>

    <!-- Formulario -->
    <div class="form-card" id="formulario" style="display: none">
      <ul class="nav nav-tabs" id="tabForm" role="tablist">
        <li class="nav-item">
          <button
            class="nav-link active"
            data-bs-toggle="tab"
            data-bs-target="#personales"
            type="button"
          >
            Personales
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            data-bs-toggle="tab"
            data-bs-target="#familiares"
            type="button"
          >
            Familiares
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            data-bs-toggle="tab"
            data-bs-target="#espirituales"
            type="button"
          >
            Espirituales
          </button>
        </li>
      </ul>
      <div class="tab-content pt-3">
        <!-- PERSONALES -->
        <div class="tab-pane fade show active" id="personales">
          <input
            class="form-control mb-2"
            id="nombre"
            placeholder="Nombre completo"
          />
          <input class="form-control mb-2" id="codigo" placeholder="Código" />
          <input
            class="form-control mb-2"
            id="telefono"
            placeholder="Teléfono"
          />
          <input
            class="form-control mb-2"
            id="edad"
            type="number"
            placeholder="Edad"
          />
          <input
            class="form-control mb-2"
            id="cumple"
            type="date"
            placeholder="Cumpleaños"
          />
          <input
            class="form-control mb-2"
            id="direccion"
            placeholder="Dirección"
          />
          <!-- NO foto aquí -->
        </div>

        <!-- FAMILIARES -->
        <div class="tab-pane fade" id="familiares">
          <select class="form-select mb-2" id="relacion">
            <option>Conyugue</option>
            <option>Papá</option>
            <option>Mamá</option>
            <option>Hermano/a</option>
          </select>
          <input
            class="form-control mb-2"
            id="nombreFamiliar"
            placeholder="Nombre del familiar"
          />
        </div>

        <!-- ESPIRITUALES -->
        <div class="tab-pane fade" id="espirituales">
          <input
            class="form-control mb-2"
            id="conversion"
            placeholder="Conversión"
          />
          <input
            class="form-control mb-2"
            id="bautismo"
            placeholder="Bautismo en Agua"
          />
          <input
            class="form-control mb-2"
            id="bautismoEsp"
            placeholder="Bautismo Espíritu Santo"
          />
          <input
            class="form-control mb-2"
            id="fechaBautismoEsp"
            type="date"
            placeholder="Fecha BA. Esp."
          />
          <input
            class="form-control mb-2"
            id="ubicacionBautismo"
            placeholder="Ubicación BA. Esp."
          />
        </div>
      </div>
      <div class="text-center mt-3">
        <button class="btn btn-add" onclick="guardarMiembro()">Guardar miembro</button>
      </div>
    </div>

    <!-- Tabla -->
    <table class="table table-bordered table-striped mt-4 align-middle">
      <thead>
        <tr>
          <th>Foto</th>
          <th>Nombre</th>
          <th>Código</th>
          <th>Edad</th>
          <th>Teléfono</th>
          <th>Dirección</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaMiembros"></tbody>
    </table>

    <!-- Input invisible para subir foto -->
    <input type="file" id="uploadFotoInput" class="file-upload-input" accept="image/*" />
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // Inicializar Firebase Firestore
    const firebaseConfig = {
      apiKey: "TU_API_KEY_FIREBASE",
      authDomain: "TU_AUTH_DOMAIN_FIREBASE",
      projectId: "TU_PROJECT_ID_FIREBASE",
      storageBucket: "TU_STORAGE_BUCKET_FIREBASE",
      messagingSenderId: "TU_MESSAGING_SENDER_ID_FIREBASE",
      appId: "TU_APP_ID_FIREBASE"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Inicializar Supabase
    const supabaseUrl = 'https://azywyqozwwbfctxeokug.supabase.co';
    const supabaseKey = 'TU_SUPABASE_ANON_KEY';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Variables globales
    let miembros = [];
    let editandoId = null; // ID del miembro en edición
    let fotoSubiendoId = null; // Para saber a qué miembro se le sube foto

    // Mostrar/ocultar formulario
    function toggleForm() {
      const form = document.getElementById('formulario');
      if(form.style.display === 'none') {
        form.style.display = 'block';
        limpiarFormulario();
        editandoId = null;
      } else {
        form.style.display = 'none';
      }
    }

    // Limpiar formulario
    function limpiarFormulario() {
      const ids = ['nombre','codigo','telefono','edad','cumple','direccion','relacion','nombreFamiliar','conversion','bautismo','bautismoEsp','fechaBautismoEsp','ubicacionBautismo'];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = '';
      });
      // Poner tab activos al inicio
      const firstTab = new bootstrap.Tab(document.querySelector('#tabForm button.nav-link'));
      firstTab.show();
    }

    // Guardar miembro en Firestore
    async function guardarMiembro() {
      const nombre = document.getElementById('nombre').value.trim();
      if(!nombre) {
        alert('El nombre es obligatorio');
        return;
      }
      const datos = {
        nombre,
        codigo: document.getElementById('codigo').value.trim(),
        telefono: document.getElementById('telefono').value.trim(),
        edad: Number(document.getElementById('edad').value) || null,
        cumple: document.getElementById('cumple').value || null,
        direccion: document.getElementById('direccion').value.trim(),
        relacion: document.getElementById('relacion').value || null,
        nombreFamiliar: document.getElementById('nombreFamiliar').value.trim(),
        conversion: document.getElementById('conversion').value.trim(),
        bautismo: document.getElementById('bautismo').value.trim(),
        bautismoEsp: document.getElementById('bautismoEsp').value.trim(),
        fechaBautismoEsp: document.getElementById('fechaBautismoEsp').value || null,
        ubicacionBautismo: document.getElementById('ubicacionBautismo').value.trim(),
        fotoUrl: null // Se carga aparte desde Supabase
      };

      try {
        if(editandoId) {
          // Actualizar
          await db.collection('miembros').doc(editandoId).update(datos);
          alert('Miembro actualizado');
        } else {
          // Nuevo
          const docRef = await db.collection('miembros').add(datos);
          editandoId = docRef.id;
          alert('Miembro agregado');
        }
        await cargarMiembros();
        toggleForm();
      } catch (error) {
        alert('Error guardando miembro: ' + error.message);
      }
    }

    // Cargar miembros de Firestore
    async function cargarMiembros() {
      const snapshot = await db.collection('miembros').get();
      miembros = [];
      snapshot.forEach(doc => {
        miembros.push({ id: doc.id, ...doc.data() });
      });
      mostrarMiembros();
    }

    // Mostrar miembros en tabla
    function mostrarMiembros() {
      const tbody = document.getElementById('tablaMiembros');
      tbody.innerHTML = '';
      miembros.forEach(miembro => {
        const tr = document.createElement('tr');

        // Foto con clic para subir
        const tdFoto = document.createElement('td');
        const img = document.createElement('img');
        img.src = miembro.fotoUrl || 'https://via.placeholder.com/60?text=Foto';
        img.alt = 'Foto';
        img.title = 'Click para cambiar foto';
        img.style.cursor = 'pointer';
        img.onclick = () => abrirSelectorFoto(miembro.id);
        tdFoto.appendChild(img);
        tr.appendChild(tdFoto);

        // Nombre
        tr.innerHTML += `<td>${miembro.nombre}</td>`;
        tr.innerHTML += `<td>${miembro.codigo || ''}</td>`;
        tr.innerHTML += `<td>${miembro.edad || ''}</td>`;
        tr.innerHTML += `<td>${miembro.telefono || ''}</td>`;
        tr.innerHTML += `<td>${miembro.direccion || ''}</td>`;

        // Acciones
        const tdAcciones = document.createElement('td');
        const btnEditar = document.createElement('button');
        btnEditar.className = 'btn-action';
        btnEditar.textContent = 'Editar';
        btnEditar.onclick = () => editarMiembro(miembro.id);
        tdAcciones.appendChild(btnEditar);
        tr.appendChild(tdAcciones);

        tbody.appendChild(tr);
      });
    }

    // Abrir selector para subir foto y guardar en Supabase
    function abrirSelectorFoto(id) {
      fotoSubiendoId = id;
      const inputFile = document.getElementById('uploadFotoInput');
      inputFile.value = ''; // Reset input para detectar cambio siempre
      inputFile.click();
    }

    // Subir foto a Supabase y guardar URL en Firestore
    async function subirFoto(file) {
      if (!fotoSubiendoId) return;
      try {
        const nombreArchivo = `fotos/${fotoSubiendoId}_${Date.now()}_${file.name}`;
        const { data, error } = await supabase.storage
          .from('fotos')
          .upload(nombreArchivo, file, { upsert: true });
        if (error) throw error;

        const { data: urlData } = supabase.storage
          .from('fotos')
          .getPublicUrl(nombreArchivo);

        // Actualizar Firestore con la URL pública
        await db.collection('miembros').doc(fotoSubiendoId).update({
          fotoUrl: urlData.publicUrl,
        });

        // Refrescar la tabla
        await cargarMiembros();
        alert('Foto subida y guardada correctamente');
      } catch (error) {
        alert('Error al subir foto: ' + error.message);
      } finally {
        fotoSubiendoId = null;
      }
    }

    // Al seleccionar archivo de foto
    document.getElementById('uploadFotoInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      subirFoto(file);
    });

    // Cargar datos en formulario para editar
    function editarMiembro(id) {
      const miembro = miembros.find(m => m.id === id);
      if (!miembro) return;
      editandoId = id;

      document.getElementById('nombre').value = miembro.nombre || '';
      document.getElementById('codigo').value = miembro.codigo || '';
      document.getElementById('telefono').value = miembro.telefono || '';
      document.getElementById('edad').value = miembro.edad || '';
      document.getElementById('cumple').value = miembro.cumple || '';
      document.getElementById('direccion').value = miembro.direccion || '';
      document.getElementById('relacion').value = miembro.relacion || 'Conyugue';
      document.getElementById('nombreFamiliar').value = miembro.nombreFamiliar || '';
      document.getElementById('conversion').value = miembro.conversion || '';
      document.getElementById('bautismo').value = miembro.bautismo || '';
      document.getElementById('bautismoEsp').value = miembro.bautismoEsp || '';
      document.getElementById('fechaBautismoEsp').value = miembro.fechaBautismoEsp || '';
      document.getElementById('ubicacionBautismo').value = miembro.ubicacionBautismo || '';

      // Mostrar formulario y poner tab "Personales"
      toggleForm();
      const firstTab = new bootstrap.Tab(document.querySelector('#tabForm button.nav-link'));
      firstTab.show();
    }

    // Cargar al inicio
    cargarMiembros();
  </script>
</body>
</html>
