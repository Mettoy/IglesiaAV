<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Miembros</title>
    <link rel="icon" href="logo.png" />

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>

    <style>
        /* Custom scrollbar for better aesthetics */
        body::-webkit-scrollbar {
            width: 8px;
        }
        body::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        body::-webkit-scrollbar-thumb {
            background-color: #fcd34d; /* yellow-400 */
            border-radius: 20px;
            border: 2px solid #1f2937;
        }

        /* Specific styles for date inputs to ensure text color */
        input[type="date"] {
            color-scheme: dark; /* For consistent dark mode date picker if supported by browser */
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* Makes the calendar icon white */
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">

    <div class="flex min-h-screen">
        <aside class="w-60 bg-blue-950 p-4 shadow-lg flex flex-col justify-between animate__animated animate__fadeInLeft">
            <div>
                <div class="mb-8 mt-4">
                    <img src="logo.png" alt="Logo" class="w-28 mx-auto animate__animated animate__pulse animate__infinite" style="animation-duration: 3s;" />
                    <h1 class="text-center text-xl font-bold mt-2 text-yellow-400">SAI Admin</h1>
                </div>
                <nav>
                    <ul class="space-y-3 text-white text-lg">
                        <li>
                            <a href="#" class="block px-4 py-2 rounded transition-all duration-300 hover:bg-blue-800 hover:text-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                                <i class="fas fa-users mr-2"></i>Miembros
                            </a>
                        </li>
                        <li>
                            <a href="#" class="block px-4 py-2 rounded transition-all duration-300 hover:bg-blue-800 hover:text-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                                <i class="fas fa-calendar-alt mr-2"></i>Eventos
                            </a>
                        </li>
                        <li>
                            <a href="#" class="block px-4 py-2 rounded transition-all duration-300 hover:bg-blue-800 hover:text-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-400">
                                <i class="fas fa-vote-yea mr-2"></i>Votaciones
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div class="mt-8 text-sm text-gray-400 text-center">
                &copy; 2024 SAI. Todos los derechos reservados.
            </div>
        </aside>

        <main class="flex-1 p-8 animate__animated animate__fadeInRight">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <button id="btnAgregarMiembro" class="bg-yellow-500 text-gray-900 px-6 py-3 rounded-lg shadow-md hover:bg-yellow-400 transition-colors duration-300 text-lg font-semibold w-full md:w-auto mb-4 md:mb-0 animate__animated animate__bounceIn">
                    <i class="fas fa-plus-circle mr-2"></i>Añadir Miembro
                </button>
                <div class="relative w-full md:w-80">
                    <input type="text" id="searchInput" placeholder="Buscar por nombre..." class="pl-10 pr-4 py-2 rounded-lg bg-gray-800 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full animate__animated animate__fadeIn" />
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>

            <div id="formContainer" class="bg-gray-800 rounded-lg shadow-xl p-8 mb-8 hidden animate__animated animate__fadeInUp">
                <form id="formMiembro" class="space-y-6">
                    <div>
                        <h2 class="text-yellow-400 text-2xl font-bold mb-4 flex items-center">
                            <i class="fas fa-user-circle mr-3"></i>Datos Personales
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div>
                                <label for="nombre" class="block text-gray-300 text-sm font-semibold mb-1">Nombre completo <span class="text-red-500">*</span></label>
                                <input id="nombre" name="nombre" type="text" placeholder="Nombre completo" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" required />
                            </div>
                            <div>
                                <label for="codigo" class="block text-gray-300 text-sm font-semibold mb-1">Código <span class="text-red-500">*</span></label>
                                <input id="codigo" name="codigo" type="text" placeholder="Código único" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" required />
                            </div>
                            <div>
                                <label for="edad" class="block text-gray-300 text-sm font-semibold mb-1">Edad</label>
                                <input id="edad" name="edad" type="number" placeholder="Edad" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" min="0" />
                            </div>
                            <div>
                                <label for="telefono" class="block text-gray-300 text-sm font-semibold mb-1">Teléfono</label>
                                <input id="telefono" name="telefono" type="tel" placeholder="Ej: +505 8888-7777" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <div>
                                <label for="direccion" class="block text-gray-300 text-sm font-semibold mb-1">Dirección</label>
                                <input id="direccion" name="direccion" type="text" placeholder="Dirección completa" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <div>
                                <label for="fechaNacimiento" class="block text-gray-300 text-sm font-semibold mb-1">Fecha de Nacimiento</label>
                                <input id="fechaNacimiento" name="fechaNacimiento" type="date" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <div class="col-span-1 md:col-span-2 lg:col-span-1">
                                <label for="fotoInput" class="block text-gray-300 text-sm font-semibold mb-1">Foto de Perfil</label>
                                <input type="file" id="fotoInput" name="foto" accept="image/*" class="w-full text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-500 file:cursor-pointer" />
                            </div>
                        </div>
                    </div>

                    <div>
                        <h2 class="text-yellow-400 text-2xl font-bold mb-4 flex items-center">
                            <i class="fas fa-family mr-3"></i>Datos Familiares
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-4">
                            <div>
                                <label for="tipoFamiliar" class="block text-gray-300 text-sm font-semibold mb-1">Tipo de Familiar</label>
                                <select id="tipoFamiliar" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full">
                                    <option value="">Seleccione tipo</option>
                                    <option value="Padre">Padre</option>
                                    <option value="Madre">Madre</option>
                                    <option value="Hermano">Hermano</option>
                                    <option value="Esposo/a">Esposo/a</option>
                                    <option value="Hijo/a">Hijo/a</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div>
                                <label for="nombreFamiliar" class="block text-gray-300 text-sm font-semibold mb-1">Nombre del Familiar</label>
                                <input id="nombreFamiliar" type="text" placeholder="Nombre completo del familiar" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <button type="button" id="btnAgregarFamiliar" class="bg-green-600 text-white px-5 py-3 rounded-lg hover:bg-green-500 transition-colors duration-300 self-end text-base">
                                <i class="fas fa-user-plus mr-2"></i>Agregar Familiar
                            </button>
                        </div>
                        <ul id="listaFamiliares" class="mt-2 space-y-2 max-h-40 overflow-y-auto pr-2 custom-scrollbar"></ul>
                    </div>

                    <div>
                        <h2 class="text-yellow-400 text-2xl font-bold mb-4 flex items-center">
                            <i class="fas fa-cross mr-3"></i>Datos Espirituales
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div>
                                <label for="fechaConversion" class="block text-gray-300 text-sm font-semibold mb-1">Fecha de Conversión</label>
                                <input id="fechaConversion" name="fechaConversion" type="date" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <div>
                                <label for="lugarConversion" class="block text-gray-300 text-sm font-semibold mb-1">Lugar de Conversión</label>
                                <input id="lugarConversion" name="lugarConversion" type="text" placeholder="Lugar donde se convirtió" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <div>
                                <label for="fechaBautismo" class="block text-gray-300 text-sm font-semibold mb-1">Fecha de Bautismo</label>
                                <input id="fechaBautismo" name="fechaBautismo" type="date" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <div>
                                <label for="lugarBautismo" class="block text-gray-300 text-sm font-semibold mb-1">Lugar de Bautismo</label>
                                <input id="lugarBautismo" name="lugarBautismo" type="text" placeholder="Lugar donde fue bautizado" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <div>
                                <label for="fechaEspiritu" class="block text-gray-300 text-sm font-semibold mb-1">Fecha Bautismo en el Espíritu</label>
                                <input id="fechaEspiritu" name="fechaEspiritu" type="date" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                            <div>
                                <label for="lugarEspiritu" class="block text-gray-300 text-sm font-semibold mb-1">Lugar Bautismo en el Espíritu</label>
                                <input id="lugarEspiritu" name="lugarEspiritu" type="text" placeholder="Lugar de bautismo en el Espíritu" class="p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 w-full" />
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4 pt-4 border-t border-gray-700">
                        <button type="button" id="btnCancelForm" class="bg-gray-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-gray-500 transition-colors duration-300 font-semibold">
                            <i class="fas fa-times-circle mr-2"></i>Cancelar
                        </button>
                        <button type="submit" class="bg-yellow-500 text-gray-900 px-6 py-3 rounded-lg shadow-md hover:bg-yellow-400 transition-colors duration-300 font-semibold">
                            <i class="fas fa-save mr-2"></i>Guardar Miembro
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-gray-800 rounded-lg shadow-xl overflow-hidden animate__animated animate__fadeIn">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700 text-yellow-400 uppercase text-sm">
                            <tr>
                                <th class="px-6 py-3 text-left font-semibold tracking-wider">Foto</th>
                                <th class="px-6 py-3 text-left font-semibold tracking-wider">Nombre</th>
                                <th class="px-6 py-3 text-left font-semibold tracking-wider">Código</th>
                                <th class="px-6 py-3 text-left font-semibold tracking-wider">Edad</th>
                                <th class="px-6 py-3 text-left font-semibold tracking-wider">Teléfono</th>
                                <th class="px-6 py-3 text-left font-semibold tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaMiembros" class="divide-y divide-gray-700 text-white text-base">
                            <tr>
                                <td colspan="6" class="text-center py-6 text-gray-400">
                                    Cargando miembros...
                                    <div id="loadingAnimation" style="width: 50px; height: 50px; margin: 10px auto;"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="https://kit.fontawesome.com/your-font-awesome-kit-code.js" crossorigin="anonymous"></script>

    <script type="module">
        // =========================================================
        // 1. CONFIGURACIÓN DE FIREBASE Y SUPABASE
        // ** ¡IMPORTANTE! REEMPLAZA LOS VALORES CON LOS DE TU PROYECTO **
        // =========================================================
        const firebaseConfig = {
            apiKey: "TU_FIREBASE_API_KEY",
            authDomain: "TU_FIREBASE_AUTH_DOMAIN",
            projectId: "TU_FIREBASE_PROJECT_ID",
            storageBucket: "TU_FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "TU_FIREBASE_MESSAGING_SENDER_ID",
            appId: "TU_FIREBASE_APP_ID"
        };

        const supabaseUrl = 'TU_SUPABASE_URL';
        const supabaseAnonKey = 'TU_SUPABASE_ANON_KEY';

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const miembrosCollection = db.collection('miembros');

        // Inicializar Supabase
        const supabase = createClient(supabaseUrl, supabaseAnonKey);
        const fotosBucket = 'fotos_miembros'; // Asegúrate de que este bucket exista en Supabase Storage

        // =========================================================
        // 2. REFERENCIAS A ELEMENTOS DEL DOM
        // =========================================================
        const btnAgregarMiembro = document.getElementById('btnAgregarMiembro');
        const formContainer = document.getElementById('formContainer'); // Contenedor del formulario
        const formMiembro = document.getElementById('formMiembro');
        const btnCancelForm = document.getElementById('btnCancelForm');
        const btnAgregarFamiliar = document.getElementById('btnAgregarFamiliar');
        const listaFamiliares = document.getElementById('listaFamiliares');
        const tablaMiembros = document.getElementById('tablaMiembros');
        const searchInput = document.getElementById('searchInput');
        const fotoInput = document.getElementById('fotoInput');
        // const loadingAnimation = document.getElementById('loadingAnimation'); // Para LottieFiles, si lo descomentas

        // =========================================================
        // 3. VARIABLES GLOBALES Y ESTADO
        // =========================================================
        let familiaresData = []; // Para almacenar temporalmente los familiares del miembro actual
        let editingMemberId = null; // Guarda el ID del miembro que se está editando

        // =========================================================
        // 4. FUNCIONES DE UTILIDAD Y UI
        // =========================================================

        /**
         * Muestra el formulario con una animación.
         */
        function showForm() {
            formContainer.classList.remove('hidden');
            formContainer.classList.remove('animate__fadeOutUp'); // Remove previous exit animation
            formContainer.classList.add('animate__fadeInDown'); // Add entry animation
            formMiembro.reset(); // Limpiar el formulario
            familiaresData = []; // Resetear familiares
            renderFamiliares();
            editingMemberId = null; // No estamos editando
        }

        /**
         * Oculta el formulario con una animación.
         */
        function hideForm() {
            formContainer.classList.remove('animate__fadeInDown');
            formContainer.classList.add('animate__fadeOutUp'); // Add exit animation
            formMiembro.addEventListener('animationend', () => {
                if (formContainer.classList.contains('animate__fadeOutUp')) {
                    formContainer.classList.add('hidden');
                    formMiembro.reset(); // Limpiar el formulario después de la animación
                    familiaresData = [];
                    renderFamiliares();
                    editingMemberId = null;
                }
            }, { once: true }); // Ensure event listener runs only once
        }

        /**
         * Muestra una alerta con SweetAlert2.
         * @param {string} icon - 'success', 'error', 'warning', 'info', 'question'
         * @param {string} title - Título de la alerta.
         * @param {string} text - Texto del cuerpo de la alerta.
         */
        function showAlert(icon, title, text) {
            Swal.fire({
                icon: icon,
                title: title,
                text: text,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                }
            });
        }

        /**
         * Muestra una confirmación con SweetAlert2.
         * @param {string} title - Título de la confirmación.
         * @param {string} text - Texto del cuerpo de la confirmación.
         * @returns {Promise<boolean>} - True si se confirma, false si se cancela.
         */
        async function showConfirm(title, text) {
            const result = await Swal.fire({
                title: title,
                text: text,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, continuar',
                cancelButtonText: 'No, cancelar'
            });
            return result.isConfirmed;
        }

        /**
         * Renderiza la lista de familiares en el formulario.
         */
        function renderFamiliares() {
            listaFamiliares.innerHTML = ''; // Limpiar la lista actual
            if (familiaresData.length === 0) {
                listaFamiliares.innerHTML = '<li class="text-gray-500 italic p-2">No hay familiares agregados.</li>';
                return;
            }
            familiaresData.forEach((familiar, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-lg mb-2 shadow-sm animate__animated animate__fadeIn';
                li.innerHTML = `
                    <span><strong>${familiar.tipo}:</strong> ${familiar.nombre}</span>
                    <button type="button" data-index="${index}" class="btn-eliminar-familiar text-red-400 hover:text-red-600 ml-4 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-400">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                listaFamiliares.appendChild(li);
            });

            // Añadir event listeners a los botones de eliminar
            document.querySelectorAll('.btn-eliminar-familiar').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = e.currentTarget.dataset.index; // Usar currentTarget
                    familiaresData.splice(index, 1);
                    renderFamiliares(); // Volver a renderizar la lista
                    showAlert('info', 'Familiar Eliminado', 'El familiar ha sido retirado de la lista.');
                });
            });
        }

        // =========================================================
        // 5. GESTIÓN DE FOTOS (SUPABASE STORAGE)
        // =========================================================

        /**
         * Sube un archivo de imagen a Supabase Storage.
         * @param {File} file - El archivo de imagen a subir.
         * @returns {Promise<string|null>} - La URL pública de la foto o null si falla.
         */
        async function uploadPhoto(file) {
            if (!file) return null;

            const uniqueFileName = `${Luxon.DateTime.now().toMillis()}_${file.name}`; // Nombre único con timestamp
            const filePath = uniqueFileName;

            try {
                const { data, error } = await supabase.storage
                    .from(fotosBucket)
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false // No sobrescribir si ya existe
                    });

                if (error) throw error;

                // Obtener la URL pública
                const { data: publicURLData } = supabase.storage
                    .from(fotosBucket)
                    .getPublicUrl(filePath);

                if (publicURLData && publicURLData.publicUrl) {
                    return publicURLData.publicUrl;
                } else {
                    console.error('Error: No se pudo obtener la URL pública de la foto.');
                    return null;
                }
            } catch (error) {
                showAlert('error', 'Error de Subida', `No se pudo subir la foto: ${error.message}`);
                console.error('Error al subir la foto a Supabase:', error);
                return null;
            }
        }

        /**
         * Elimina una foto de Supabase Storage.
         * @param {string} photoUrl - La URL pública de la foto a eliminar.
         */
        async function deletePhoto(photoUrl) {
            if (!photoUrl) return;

            try {
                // Extraer la ruta del archivo de la URL pública
                // Ejemplo: https://[project_id].supabase.co/storage/v1/object/public/fotos_miembros/timestamp_nombre.png
                const parts = photoUrl.split(`/${fotosBucket}/`);
                if (parts.length < 2) {
                    console.warn('URL de foto inválida para eliminar:', photoUrl);
                    return;
                }
                const filePath = parts[1];

                const { error } = await supabase.storage
                    .from(fotosBucket)
                    .remove([filePath]);

                if (error) throw error;
                console.log('Foto eliminada de Supabase:', filePath);

            } catch (error) {
                showAlert('error', 'Error al Eliminar Foto', `No se pudo eliminar la foto anterior: ${error.message}`);
                console.error('Error al eliminar la foto de Supabase:', error);
            }
        }

        // =========================================================
        // 6. OPERACIONES CRUD (FIRESTORE)
        // =========================================================

        /**
         * Guarda un nuevo miembro o actualiza uno existente en Firestore.
         * Maneja la subida/eliminación de fotos en Supabase.
         * @param {Event} event - El evento de envío del formulario.
         */
        async function saveMiembro(event) {
            event.preventDefault(); // Evita el envío tradicional del formulario

            const formElements = formMiembro.elements;
            const miembroData = {};

            // Recopilar datos del formulario
            for (let i = 0; i < formElements.length; i++) {
                const element = formElements[i];
                if (element.name && element.id !== 'fotoInput') { // Excluir input de archivo
                    miembroData[element.name] = element.value.trim();
                }
            }

            // Validar campos obligatorios
            if (!miembroData.nombre || !miembroData.codigo) {
                showAlert('error', 'Campos Obligatorios', 'El nombre y el código son obligatorios.');
                return;
            }

            // Asegurarse de que la edad es un número
            miembroData.edad = parseInt(miembroData.edad) || null; // Convertir a número o null

            // Añadir familiares
            miembroData.familiares = familiaresData;

            // Obtener el archivo de la foto
            const file = fotoInput.files[0];
            let photoUrl = null;

            // Iniciar animación de carga
            Swal.fire({
                title: 'Guardando Miembro...',
                text: 'Por favor, espere.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                if (file) {
                    photoUrl = await uploadPhoto(file);
                    if (photoUrl) {
                        miembroData.fotoUrl = photoUrl;
                    } else {
                        Swal.close();
                        showAlert('error', 'Error de Foto', 'No se pudo subir la foto. Inténtelo de nuevo.');
                        return;
                    }
                }

                if (editingMemberId) {
                    // Actualizar miembro existente
                    const memberRef = miembrosCollection.doc(editingMemberId);
                    const currentMemberSnapshot = await memberRef.get();
                    const currentMemberData = currentMemberSnapshot.data();
                    const oldPhotoUrl = currentMemberData.fotoUrl;

                    // Si hay una nueva foto y había una vieja diferente, eliminar la vieja
                    if (photoUrl && oldPhotoUrl && photoUrl !== oldPhotoUrl) {
                        await deletePhoto(oldPhotoUrl);
                    } else if (!file && oldPhotoUrl) {
                        // Si no se selecciona nueva foto y había una vieja, mantener la vieja
                        miembroData.fotoUrl = oldPhotoUrl;
                    } else if (!file && !oldPhotoUrl) {
                        // Si no hay foto y no había, asegurar que el campo no exista o sea null
                        delete miembroData.fotoUrl;
                    }


                    await memberRef.update(miembroData);
                    showAlert('success', '¡Actualizado!', 'Miembro actualizado exitosamente.');

                } else {
                    // Crear nuevo miembro
                    miembroData.createdAt = firebase.firestore.FieldValue.serverTimestamp(); // Fecha de creación
                    await miembrosCollection.add(miembroData);
                    showAlert('success', '¡Registrado!', 'Miembro agregado exitosamente.');
                }

                Swal.close(); // Cerrar el SweetAlert de carga
                hideForm(); // Ocultar el formulario
                loadMiembros(); // Recargar la tabla
            } catch (error) {
                Swal.close();
                showAlert('error', 'Error al Guardar', `No se pudo guardar el miembro: ${error.message}`);
                console.error("Error al guardar miembro: ", error);
            }
        }

        /**
         * Carga y muestra los miembros de Firestore en la tabla.
         * Permite buscar por nombre.
         * @param {string} searchTerm - Término de búsqueda (opcional).
         */
        async function loadMiembros(searchTerm = '') {
            // Muestra animación de carga en la tabla
            tablaMiembros.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-6 text-gray-400">
                        <i class="fas fa-spinner fa-spin text-yellow-500 text-3xl mb-2"></i>
                        <p>Cargando miembros...</p>
                    </td>
                </tr>
            `;

            try {
                let query = miembrosCollection.orderBy('nombre');

                if (searchTerm) {
                    // Simulación de búsqueda "starts with" en Firestore
                    const endTerm = searchTerm + '\uf8ff';
                    query = query.where('nombre', '>=', searchTerm).where('nombre', '<=', endTerm);
                }

                const snapshot = await query.get();
                tablaMiembros.innerHTML = ''; // Limpiar la tabla antes de añadir filas

                if (snapshot.empty) {
                    tablaMiembros.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-6 text-gray-400 animate__animated animate__fadeIn">
                                <i class="fas fa-box-open text-5xl mb-3"></i>
                                <p>No hay miembros registrados.</p>
                                <p class="text-sm">¡Añade uno para empezar!</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                snapshot.forEach(doc => {
                    const miembro = doc.data();
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-700 transition-colors duration-200 animate__animated animate__fadeInUp'; // Animación para cada fila
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <img src="${miembro.fotoUrl || 'placeholder.png'}" alt="${miembro.nombre}"
                                 class="w-12 h-12 rounded-full object-cover border-2 border-yellow-500 shadow-md">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${miembro.nombre}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-300">${miembro.codigo}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${miembro.edad || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${miembro.telefono || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${doc.id}" class="btn-editar bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-500 transition-colors duration-200 mr-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button data-id="${doc.id}" data-foto-url="${miembro.fotoUrl || ''}" class="btn-eliminar bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-500 transition-colors duration-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-red-400">
                                <i class="fas fa-trash-alt"></i> Eliminar
                            </button>
                        </td>
                    `;
                    tablaMiembros.appendChild(tr);
                });

                // Añadir event listeners a los botones de editar y eliminar
                document.querySelectorAll('.btn-editar').forEach(button => {
                    button.addEventListener('click', (e) => editMiembro(e.currentTarget.dataset.id));
                });
                document.querySelectorAll('.btn-eliminar').forEach(button => {
                    button.addEventListener('click', (e) => deleteMiembro(e.currentTarget.dataset.id, e.currentTarget.dataset.fotoUrl));
                });

            } catch (error) {
                showAlert('error', 'Error de Carga', `No se pudieron cargar los miembros: ${error.message}`);
                console.error("Error al cargar miembros: ", error);
                tablaMiembros.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-6 text-red-500 animate__animated animate__shakeX">
                            <i class="fas fa-exclamation-triangle text-4xl mb-2"></i>
                            <p>¡Ups! Hubo un problema al cargar los datos.</p>
                        </td>
                    </tr>
                `;
            }
        }

        /**
         * Carga los datos de un miembro en el formulario para su edición.
         * @param {string} id - El ID del documento del miembro en Firestore.
         */
        async function editMiembro(id) {
            // Iniciar SweetAlert de carga
            Swal.fire({
                title: 'Cargando datos...',
                text: 'Preparando formulario para edición.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const doc = await miembrosCollection.doc(id).get();
                if (doc.exists) {
                    const miembro = doc.data();
                    editingMemberId = id; // Establecer el ID para edición
                    showForm(); // Mostrar el formulario

                    // Llenar los campos del formulario
                    document.getElementById('nombre').value = miembro.nombre || '';
                    document.getElementById('codigo').value = miembro.codigo || '';
                    document.getElementById('edad').value = miembro.edad || '';
                    document.getElementById('telefono').value = miembro.telefono || '';
                    document.getElementById('direccion').value = miembro.direccion || '';
                    document.getElementById('fechaNacimiento').value = miembro.fechaNacimiento || '';

                    document.getElementById('fechaConversion').value = miembro.fechaConversion || '';
                    document.getElementById('lugarConversion').value = miembro.lugarConversion || '';
                    document.getElementById('fechaBautismo').value = miembro.fechaBautismo || '';
                    document.getElementById('lugarBautismo').value = miembro.lugarBautismo || '';
                    document.getElementById('fechaEspiritu').value = miembro.fechaEspiritu || '';
                    document.getElementById('lugarEspiritu').value = miembro.lugarEspiritu || '';

                    // Cargar familiares
                    familiaresData = miembro.familiares || [];
                    renderFamiliares();

                    Swal.close(); // Cerrar el SweetAlert de carga
                    showAlert('info', 'Editando Miembro', `Cargando datos de ${miembro.nombre}.`);
                } else {
                    Swal.close();
                    showAlert('error', 'No Encontrado', 'Miembro no encontrado.');
                }
            } catch (error) {
                Swal.close();
                showAlert('error', 'Error de Edición', `Error al cargar datos del miembro: ${error.message}`);
                console.error("Error al editar miembro: ", error);
            }
        }

        /**
         * Elimina un miembro de Firestore y su foto de Supabase Storage.
         * @param {string} id - El ID del documento del miembro en Firestore.
         * @param {string} photoUrl - La URL de la foto del miembro (puede ser vacía).
         */
        async function deleteMiembro(id, photoUrl) {
            const confirmed = await showConfirm('Confirmar Eliminación', '¿Está seguro de que desea eliminar este miembro? Esta acción es irreversible.');

            if (confirmed) {
                // Iniciar SweetAlert de carga
                Swal.fire({
                    title: 'Eliminando Miembro...',
                    text: 'Por favor, espere.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                try {
                    await miembrosCollection.doc(id).delete();
                    if (photoUrl) {
                        await deletePhoto(photoUrl); // Eliminar la foto de Supabase
                    }
                    Swal.close();
                    showAlert('success', '¡Eliminado!', 'Miembro eliminado exitosamente.');
                    loadMiembros(); // Recargar la tabla
                } catch (error) {
                    Swal.close();
                    showAlert('error', 'Error al Eliminar', `No se pudo eliminar el miembro: ${error.message}`);
                    console.error("Error al eliminar miembro: ", error);
                }
            }
        }

        // =========================================================
        // 7. EVENT LISTENERS
        // =========================================================

        // Botón "Añadir Miembro"
        btnAgregarMiembro.addEventListener('click', showForm);

        // Botón "Cancelar" en el formulario
        btnCancelForm.addEventListener('click', hideForm);

        // Envío del formulario
        formMiembro.addEventListener('submit', saveMiembro);

        // Botón "Agregar Familiar"
        btnAgregarFamiliar.addEventListener('click', () => {
            const tipo = document.getElementById('tipoFamiliar').value;
            const nombre = document.getElementById('nombreFamiliar').value.trim();

            if (tipo && nombre) {
                familiaresData.push({ tipo, nombre });
                renderFamiliares();
                document.getElementById('tipoFamiliar').value = ''; // Limpiar campos
                document.getElementById('nombreFamiliar').value = '';
                showAlert('success', 'Familiar Agregado', 'Familiar añadido a la lista temporal.');
            } else {
                showAlert('warning', 'Campos Incompletos', 'Por favor, seleccione un tipo y escriba el nombre del familiar.');
            }
        });

        // Búsqueda en tiempo real
        searchInput.addEventListener('input', () => {
            loadMiembros(searchInput.value.trim());
        });

        // =========================================================
        // 8. INICIALIZACIÓN
        // =========================================================
        document.addEventListener('DOMContentLoaded', () => {
            loadMiembros(); // Cargar los miembros al cargar la página
        });
    </script>
</body>
</html>
