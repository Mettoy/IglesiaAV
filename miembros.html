<!-- index.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestión de Miembros</title>
  <!-- Vuetify CSS -->
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.3.10/dist/vuetify.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <!-- Material Design Icons -->
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
</head>
<body>
  <div id="app"></div>

  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
  <!-- Vuetify JS -->
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.3.10/dist/vuetify.min.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>

  <script>
    const { createApp, ref, onMounted, computed } = Vue;
    const { createVuetify } = Vuetify;
    const vuetify = createVuetify();

    const firebaseConfig = {
      // Tu configuración de Firebase
      apiKey: "TU_API_KEY",
      authDomain: "TU_AUTH_DOMAIN",
      projectId: "TU_PROJECT_ID",
      storageBucket: "TU_STORAGE_BUCKET",
      messagingSenderId: "TU_MESSAGING_SENDER_ID",
      appId: "TU_APP_ID"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Inicializar Supabase
    const supabase = supabase.createClient('https://TU_SUPABASE_URL.supabase.co', 'TU_SUPABASE_ANON_KEY');

    createApp({
      setup() {
        const members = ref([]);
        const search = ref('');
        const dialog = ref(false);
        const isEdit = ref(false);
        const form = ref({
          id: null,
          name: '',
          email: '',
          status: 'Activo',
          photo: null,
          photoURL: ''
        });
        const snackbar = ref({
          show: false,
          text: '',
          color: ''
        });

        const headers = [
          { text: 'Foto', value: 'photo' },
          { text: 'Nombre', value: 'name' },
          { text: 'Correo Electrónico', value: 'email' },
          { text: 'Estado', value: 'status' },
          { text: 'Acciones', value: 'actions', sortable: false }
        ];

        const fetchMembers = async () => {
          try {
            const snapshot = await db.collection('members').get();
            members.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          } catch (error) {
            showSnackbar('Ocurrió un error al obtener los miembros', 'error');
          }
        };

        const openDialog = () => {
          resetForm();
          dialog.value = true;
        };

        const closeDialog = () => {
          dialog.value = false;
        };

        const resetForm = () => {
          form.value = {
            id: null,
            name: '',
            email: '',
            status: 'Activo',
            photo: null,
            photoURL: ''
          };
          isEdit.value = false;
        };

        const saveMember = async () => {
          try {
            let photoURL = form.value.photoURL;
            if (form.value.photo) {
              // Eliminar imagen anterior si existe
              if (photoURL) {
                const filePath = photoURL.split('/').pop();
                await supabase.storage.from('avatars').remove([filePath]);
              }
              // Subir nueva imagen
              const file = form.value.photo;
              const fileName = `${Date.now()}_${file.name}`;
              const { data, error } = await supabase.storage.from('avatars').upload(fileName, file);
              if (error) throw error;
              const { publicURL } = supabase.storage.from('avatars').getPublicUrl(fileName);
              photoURL = publicURL;
            }

            if (isEdit.value) {
              await db.collection('members').doc(form.value.id).update({
                name: form.value.name,
                email: form.value.email,
                status: form.value.status,
                photoURL
              });
              showSnackbar('Miembro actualizado exitosamente', 'success');
            } else {
              await db.collection('members').add({
                name: form.value.name,
                email: form.value.email,
                status: form.value.status,
                photoURL
              });
              showSnackbar('Miembro agregado exitosamente', 'success');
            }
            fetchMembers();
            closeDialog();
          } catch (error) {
            showSnackbar('Ocurrió un error al guardar el miembro', 'error');
          }
        };

        const editMember = (member) => {
          form.value = { ...member, photo: null };
          isEdit.value = true;
          dialog.value = true;
        };

        const deleteMember = async (member) => {
          try {
            await db.collection('members').doc(member.id).delete();
            if (member.photoURL) {
              const filePath = member.photoURL.split('/').pop();
              await supabase.storage.from('avatars').remove([filePath]);
            }
            fetchMembers();
            showSnackbar('Miembro eliminado exitosamente', 'success');
          } catch (error) {
            showSnackbar('Ocurrió un error al eliminar el miembro', 'error');
          }
        };

        const showSnackbar = (text, color) => {
          snackbar.value = { show: true, text, color };
        };

        const filteredMembers = computed(() => {
          return members.value.filter(member =>
            member.name.toLowerCase().includes(search.value.toLowerCase()) ||
            member.email.toLowerCase().includes(search.value.toLowerCase())
          );
        });

        onMounted(() => {
          fetchMembers();
        });

        return {
          members: filteredMembers,
          headers,
          search,
          dialog,
          form,
          isEdit,
          openDialog,
          closeDialog,
          saveMember,
          editMember,
          deleteMember,
          snackbar
        };
      },
      template: `
        <v-app>
          <v-container>
            <v-row justify="space-between" align="center">
              <v-col cols="12" sm="6">
                <h1>Gestión de Miembros</h1>
              </v-col>
              <v-col cols="12" sm="6" class="text-right">
                <v-btn color="primary" @click="openDialog">Agregar Miembro</v-btn>
              </v-col>
            </v-row>

            <v-text-field
              v-model="search"
              label="Buscar"
              clearable
            ></v-text-field>

            <v-data-table
              :headers="headers"
              :items="members"
              :items-per-page="5"
              class="elevation-1"
            >
              <template #item.photo="{ item }">
                <v-avatar size="40">
                  <img :src="item.photoURL" alt="Foto" />
                </v-avatar>
              </template>
              <template #item.actions="{ item }">
                <v-btn icon @click="editMember(item)">
                  <v-icon>mdi-pencil</v-icon>
                </v-btn>
                <v-btn icon @click="deleteMember(item)">
                  <v-icon>mdi-delete</v-icon>
                </v-btn>
              </template>
            </v-data-table>

            <v-dialog v-model="dialog" max-width="600px">
              <v-card>
                <v-card-title>
                  <span class="text-h5">{{ isEdit ? 'Editar Miembro' : 'Agregar Miembro' }}</span>
                </v-card-title>
                <v-card-text>
                  <v-form ref="form">
                    <v-text-field v-model="form.name" label="Nombre" required></v-text-field>
                    <v-text-field v-model="form.email" label="Correo Electrónico" required></v-text-field>
                    <v-select
                      v-model="form.status"
                      :items="['Activo', 'Inactivo']"
                      label="Estado"
                      required
                    ></v-select>
                    <v-file-input
                      v-model="form.photo"
                      label="Subir Foto"
                      accept="image/*"
                    ></v-file-input>
                  </v-form>
                </v-card-text>
                <v-card-actions>
                  <v-spacer></v-spacer>
                  <v-btn text @click="closeDialog">Cancelar</v-btn>
                  <v-btn color="primary" @click="saveMember">Guardar</v-btn>
                </v-card-actions>
              </v-card>
            </v-dialog>

            <v-snackbar v-model="snackbar.show" :color="snackbar.color">
              {{ snackbar.text }}
              <v-btn text @click="snackbar.show = false">Cerrar</v-btn>
            </v-snackbar>
          </v-container>
        </v-app>
      `
    }).use(vuetify).mount('#app');
  </script>
</body>
</html>
