<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestión de Miembros</title>
  <link rel="icon" href="https://azywyqozwwbfctxeokug.supabase.co/storage/v1/object/public/logos//images%20(1).png" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, updateDoc, doc
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhFOi7rQhuVauaNMTKqyLPFqwWPqkxb3U",
      authDomain: "iglesia-adoracion-viva-182e6.firebaseapp.com",
      projectId: "iglesia-adoracion-viva-182e6",
      storageBucket: "iglesia-adoracion-viva-182e6.appspot.com",
      messagingSenderId: "152824399391",
      appId: "1:152824399391:web:a4fc0937f35935b9b5f72a",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const supabase = createClient(
      'https://azywyqozwwbfctxeokug.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6eXd5cW96d3diZmN0eGVva3VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNzM1NjAsImV4cCI6MjA2MjY0OTU2MH0.tzJiz2LKQcVTb94uncIrGMfi4NV9XwR7xR6lzP3EELk'
    );

    document.addEventListener("DOMContentLoaded", () => {
      const formContainer = document.getElementById("form-modal");
      const form = document.getElementById("miembro-form");
      const btnAdd = document.getElementById("btn-add");
      const tabla = document.getElementById("miembros-tabla");
      const cerrarModal = document.getElementById("cerrar-modal");

      let editId = null;

      btnAdd.addEventListener("click", () => {
        form.reset();
        formContainer.style.display = "flex";
        editId = null;
        document.getElementById("preview").src = "";
      });

      cerrarModal.onclick = () => formContainer.style.display = "none";

      form.foto.addEventListener("change", () => {
        const file = form.foto.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => document.getElementById("preview").src = reader.result;
          reader.readAsDataURL(file);
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(form));
        const file = form.foto.files[0];

        let fotoURL = data.fotoURL;

        if (file) {
          const { data: upload, error } = await supabase.storage
            .from("fotos")
            .upload(`miembros/${Date.now()}_${file.name}`, file, { upsert: true });
          if (error) return alert("Error subiendo imagen");
          const { data: url } = supabase.storage.from("fotos").getPublicUrl(upload.path);
          fotoURL = url.publicUrl;
        }

        const miembroData = {
          nombre: data.nombre,
          edad: data.edad,
          codigo: data.codigo,
          telefono: data.telefono,
          direccion: data.direccion,
          nacimiento: data.nacimiento,
          conversion: data.conversion,
          lugar_conversion: data.lugar_conversion,
          bautismo: data.bautismo,
          lugar_bautismo: data.lugar_bautismo,
          bautismo_espiritu: data.bautismo_espiritu,
          lugar_bautismo_espiritu: data.lugar_bautismo_espiritu,
          familiar_tipo: data.familiar_tipo,
          familiar_nombre: data.familiar_nombre,
          fotoURL
        };

        if (editId) {
          await updateDoc(doc(db, "miembros", editId), miembroData);
        } else {
          await addDoc(collection(db, "miembros"), miembroData);
        }

        formContainer.style.display = "none";
        cargarMiembros();
      });

      async function cargarMiembros() {
        tabla.innerHTML = "";
        const querySnapshot = await getDocs(collection(db, "miembros"));
        querySnapshot.forEach((docSnap) => {
          const d = docSnap.data();
          const row = tabla.insertRow();
          row.insertCell(0).innerHTML = `<img src="${d.fotoURL}" width="60" />`;
          row.insertCell(1).innerText = d.nombre;
          row.insertCell(2).innerText = d.codigo;
          row.insertCell(3).innerText = d.telefono;
          row.insertCell(4).innerHTML = `<button onclick='editar(${JSON.stringify(d).replace(/'/g, "\\'")}, "${docSnap.id}")'>Editar</button>`;
        });
      }

      window.editar = (d, id) => {
        editId = id;
        for (let key in d) {
          if (form[key]) form[key].value = d[key];
        }
        document.getElementById("preview").src = d.fotoURL;
        formContainer.style.display = "flex";
      };

      cargarMiembros();
    });
  </script>
  <style>
    body {
      margin: 0; font-family: Arial; background: #0c1f3c; color: white;
      display: flex;
    }
    aside {
      width: 200px; background: #08152b; padding: 20px; min-height: 100vh;
    }
    aside img {
      width: 100%; border-radius: 8px;
    }
    main {
      flex: 1; padding: 20px;
    }
    h2 { color: gold; }
    table { width: 100%; background: white; color: black; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    img { border-radius: 6px; }
    button { background: gold; border: none; padding: 8px 12px; cursor: pointer; }
    #form-modal {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6); justify-content: center; align-items: center;
    }
    #form-box {
      background: #fff; color: black; padding: 20px; border-radius: 10px; width: 600px;
      max-height: 90vh; overflow-y: auto;
    }
    fieldset {
      border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; border-radius: 6px;
    }
    legend { font-weight: bold; color: #0c1f3c; }
    label { display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 6px; margin-top: 4px; }
    #preview { margin-top: 10px; max-width: 100%; }
    #cerrar-modal { float: right; cursor: pointer; color: red; font-weight: bold; }
  </style>
</head>
<body>
  <aside>
    <img src="https://azywyqozwwbfctxeokug.supabase.co/storage/v1/object/public/logos//images%20(1).png" />
    <nav style="margin-top: 20px;">
      <button id="btn-add">Añadir miembro</button>
    </nav>
  </aside>
  <main>
    <h2>Gestión de Miembros</h2>
    <table>
      <thead>
        <tr><th>Foto</th><th>Nombre</th><th>Código</th><th>Teléfono</th><th>Acciones</th></tr>
      </thead>
      <tbody id="miembros-tabla"></tbody>
    </table>
  </main>

  <!-- Modal de formulario -->
  <div id="form-modal">
    <div id="form-box">
      <span id="cerrar-modal">X</span>
      <form id="miembro-form">
        <input type="hidden" name="fotoURL">
        <fieldset>
          <legend>Datos Personales</legend>
          <label>Nombre completo: <input name="nombre" required></label>
          <label>Edad: <input name="edad" type="number"></label>
          <label>Código: <input name="codigo"></label>
          <label>Teléfono: <input name="telefono"></label>
          <label>Dirección: <input name="direccion"></label>
          <label>Fecha de nacimiento: <input type="date" name="nacimiento"></label>
          <label>Foto: <input type="file" name="foto" accept="image/*"></label>
          <img id="preview" />
        </fieldset>
        <fieldset>
          <legend>Datos Familiares</legend>
          <label>Tipo de familiar:
            <select name="familiar_tipo">
              <option value="Padre">Padre</option>
              <option value="Madre">Madre</option>
              <option value="Hermano/a">Hermano/a</option>
            </select>
          </label>
          <label>Nombre del familiar: <input name="familiar_nombre"></label>
        </fieldset>
        <fieldset>
          <legend>Datos Espirituales</legend>
          <label>Fecha de conversión: <input type="date" name="conversion"></label>
          <label>Lugar de conversión: <input name="lugar_conversion"></label>
          <label>Fecha de bautismo: <input type="date" name="bautismo"></label>
          <label>Lugar de bautismo: <input name="lugar_bautismo"></label>
          <label>Fecha de bautismo en el Espíritu: <input type="date" name="bautismo_espiritu"></label>
          <label>Lugar de bautismo en el Espíritu: <input name="lugar_bautismo_espiritu"></label>
        </fieldset>
        <button type="submit">Guardar</button>
      </form>
    </div>
  </div>
</body>
</html>
