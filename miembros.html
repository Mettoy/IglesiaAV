<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión de Miembros con Menú</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background-color: #f5f6fa;
    }
    /* Menú lateral */
    #sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 250px;
      height: 100vh;
      background-color: #001f3f;
      color: white;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #sidebar img {
      max-width: 120px;
      margin-bottom: 20px;
    }
    #sidebar h3 {
      margin-bottom: 40px;
      font-weight: 700;
      text-align: center;
    }
    #sidebar button {
      background-color: #ffcc00;
      border: none;
      color: black;
      font-weight: bold;
      padding: 10px 15px;
      width: 100%;
      cursor: pointer;
      border-radius: 6px;
      transition: background-color 0.3s ease;
    }
    #sidebar button:hover {
      background-color: #e6b800;
    }
    /* Contenido principal */
    #main-content {
      margin-left: 250px;
      padding: 30px;
      max-width: 900px;
      margin-top: 20px;
    }
    /* Formulario */
    .form-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }
    th {
      background-color: #001f3f;
      color: white;
      vertical-align: middle;
    }
    td img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.3s ease;
    }
    td img:hover {
      border-color: #ffcc00;
    }
    .btn-action {
      background-color: #ffcc00;
      border: none;
      color: black;
      padding: 5px 10px;
      margin-right: 5px;
      cursor: pointer;
      border-radius: 4px;
    }
    .file-upload-input {
      display: none;
    }
  </style>
</head>
<body>

  <div id="sidebar">
    <img src="https://azywyqozwwbfctxeokug.supabase.co/storage/v1/object/public/fotos/logo.png" alt="Logo" />
    <h3>Menú</h3>
    <button id="btnAgregarMiembro">+ Agregar miembro</button>
  </div>

  <div id="main-content">
    <h2>Gestión de Miembros</h2>

    <!-- Formulario -->
    <div class="form-card" id="formulario" style="display: none">
      <ul class="nav nav-tabs" id="tabForm" role="tablist">
        <li class="nav-item">
          <button
            class="nav-link active"
            data-bs-toggle="tab"
            data-bs-target="#personales"
            type="button"
          >
            Personales
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            data-bs-toggle="tab"
            data-bs-target="#familiares"
            type="button"
          >
            Familiares
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            data-bs-toggle="tab"
            data-bs-target="#espirituales"
            type="button"
          >
            Espirituales
          </button>
        </li>
      </ul>
      <div class="tab-content pt-3">
        <!-- PERSONALES -->
        <div class="tab-pane fade show active" id="personales">
          <input
            class="form-control mb-2"
            id="nombre"
            placeholder="Nombre completo"
          />
          <input class="form-control mb-2" id="codigo" placeholder="Código" />
          <input
            class="form-control mb-2"
            id="telefono"
            placeholder="Teléfono"
          />
          <input
            class="form-control mb-2"
            id="edad"
            type="number"
            placeholder="Edad"
          />
          <input
            class="form-control mb-2"
            id="cumple"
            type="date"
            placeholder="Cumpleaños"
          />
          <input
            class="form-control mb-2"
            id="direccion"
            placeholder="Dirección"
          />
          <!-- No subir foto aquí -->
        </div>

        <!-- FAMILIARES -->
        <div class="tab-pane fade" id="familiares">
          <select class="form-select mb-2" id="relacion">
            <option>Conyugue</option>
            <option>Papá</option>
            <option>Mamá</option>
            <option>Hermano/a</option>
          </select>
          <input
            class="form-control mb-2"
            id="nombreFamiliar"
            placeholder="Nombre del familiar"
          />
        </div>

        <!-- ESPIRITUALES -->
        <div class="tab-pane fade" id="espirituales">
          <input
            class="form-control mb-2"
            id="conversion"
            placeholder="Conversión"
          />
          <input
            class="form-control mb-2"
            id="bautismo"
            placeholder="Bautismo en Agua"
          />
          <input
            class="form-control mb-2"
            id="bautismoEsp"
            placeholder="Bautismo Espíritu Santo"
          />
          <input
            class="form-control mb-2"
            id="fechaBautismoEsp"
            type="date"
            placeholder="Fecha BA. Esp."
          />
          <input
            class="form-control mb-2"
            id="ubicacionBautismo"
            placeholder="Ubicación BA. Esp."
          />
        </div>
      </div>
      <div class="text-center mt-3">
        <button class="btn btn-add" id="btnGuardar">Guardar miembro</button>
      </div>
    </div>

    <!-- Tabla -->
    <table class="table table-bordered table-striped mt-4 align-middle">
      <thead>
        <tr>
          <th>Foto</th>
          <th>Nombre</th>
          <th>Código</th>
          <th>Edad</th>
          <th>Teléfono</th>
          <th>Dirección</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaMiembros"></tbody>
    </table>

    <!-- Input invisible para subir foto -->
    <input type="file" id="uploadFotoInput" class="file-upload-input" accept="image/*" />
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // Configura Firebase Firestore (pon tus datos reales aquí)
    const firebaseConfig = {
      apiKey: "AIzaSyAhFOi7rQhuVauaNMTKqyLPFqwWPqkxb3U",
      authDomain: "iglesia-adoracion-viva-182e6.firebaseapp.com",
      projectId: "iglesia-adoracion-viva-182e6",
      storageBucket: "iglesia-adoracion-viva-182e6.appspot.com",
      messagingSenderId: "152824399391",
      appId: "1:152824399391:web:a4fc0937f35935b9b5f72a",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Configura Supabase
    const supabaseUrl = 'https://azywyqozwwbfctxeokug.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6eXd5cW96d3diZmN0eGVva3VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNzM1NjAsImV4cCI6MjA2MjY0OTU2MH0.tzJiz2LKQcVTb94uncIrGMfi4NV9XwR7xR6lzP3EELk';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let miembros = [];
    let editandoId = null;
    let fotoSubiendoId = null;

    // Referencias DOM
    const btnAgregarMiembro = document.getElementById('btnAgregarMiembro');
    const formulario = document.getElementById('formulario');
    const btnGuardar = document.getElementById('btnGuardar');
    const uploadFotoInput = document.getElementById('uploadFotoInput');
    const tablaMiembros = document.getElementById('tablaMiembros');

    // Mostrar/ocultar formulario y limpiar
    function toggleForm(mostrar = true) {
      if(mostrar) {
        formulario.style.display = 'block';
        limpiarFormulario();
        editandoId = null;
        // Poner tab inicial activos
        const firstTab = new bootstrap.Tab(document.querySelector('#tabForm button.nav-link'));
        firstTab.show();
      } else {
        formulario.style.display = 'none';
      }
    }

    function limpiarFormulario() {
      const campos = ['nombre','codigo','telefono','edad','cumple','direccion','relacion','nombreFamiliar','conversion','bautismo','bautismoEsp','fechaBautismoEsp','ubicacionBautismo'];
campos.forEach(id => {
const el = document.getElementById(id);
if (el) el.value = '';
});
}
    // Renderizar tabla
function renderizarTabla() {
  tablaMiembros.innerHTML = '';
  miembros.forEach(m => {
    const tr = document.createElement('tr');

    // Foto
    const tdFoto = document.createElement('td');
    const img = document.createElement('img');
    img.src = m.fotoURL || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'; // placeholder
    img.alt = 'Foto';
    img.title = 'Click para cambiar foto';
    img.style.cursor = 'pointer';
    img.addEventListener('click', () => {
      fotoSubiendoId = m.id;
      uploadFotoInput.click();
    });
    tdFoto.appendChild(img);
    tr.appendChild(tdFoto);

    // Nombre
    tr.innerHTML += `
      <td>${m.nombre || ''}</td>
      <td>${m.codigo || ''}</td>
      <td>${m.edad || ''}</td>
      <td>${m.telefono || ''}</td>
      <td>${m.direccion || ''}</td>
    `;

    // Acciones
    const tdAcciones = document.createElement('td');
    const btnEditar = document.createElement('button');
    btnEditar.textContent = 'Editar';
    btnEditar.className = 'btn-action';
    btnEditar.addEventListener('click', () => cargarParaEditar(m.id));
    tdAcciones.appendChild(btnEditar);
    tr.appendChild(tdAcciones);

    tablaMiembros.appendChild(tr);
  });
}

// Cargar datos para editar
async function cargarParaEditar(id) {
  const m = miembros.find(x => x.id === id);
  if (!m) return;
  toggleForm(true);
  editandoId = id;

  // Llenar formulario
  document.getElementById('nombre').value = m.nombre || '';
  document.getElementById('codigo').value = m.codigo || '';
  document.getElementById('telefono').value = m.telefono || '';
  document.getElementById('edad').value = m.edad || '';
  document.getElementById('cumple').value = m.cumple || '';
  document.getElementById('direccion').value = m.direccion || '';
  document.getElementById('relacion').value = m.relacion || 'Conyugue';
  document.getElementById('nombreFamiliar').value = m.nombreFamiliar || '';
  document.getElementById('conversion').value = m.conversion || '';
  document.getElementById('bautismo').value = m.bautismo || '';
  document.getElementById('bautismoEsp').value = m.bautismoEsp || '';
  document.getElementById('fechaBautismoEsp').value = m.fechaBautismoEsp || '';
  document.getElementById('ubicacionBautismo').value = m.ubicacionBautismo || '';
}

// Guardar miembro en Firestore
async function guardarMiembro() {
  // Leer campos
  const nuevo = {
    nombre: document.getElementById('nombre').value.trim(),
    codigo: document.getElementById('codigo').value.trim(),
    telefono: document.getElementById('telefono').value.trim(),
    edad: Number(document.getElementById('edad').value),
    cumple: document.getElementById('cumple').value,
    direccion: document.getElementById('direccion').value.trim(),
    relacion: document.getElementById('relacion').value,
    nombreFamiliar: document.getElementById('nombreFamiliar').value.trim(),
    conversion: document.getElementById('conversion').value.trim(),
    bautismo: document.getElementById('bautismo').value.trim(),
    bautismoEsp: document.getElementById('bautismoEsp').value.trim(),
    fechaBautismoEsp: document.getElementById('fechaBautismoEsp').value,
    ubicacionBautismo: document.getElementById('ubicacionBautismo').value.trim(),
    fotoURL: null,
  };

  if (!nuevo.nombre) {
    alert('Debe ingresar nombre');
    return;
  }

  try {
    if (editandoId) {
      // Actualizar Firestore
      await db.collection('miembros').doc(editandoId).update(nuevo);
      // Actualizar array local
      const i = miembros.findIndex(m => m.id === editandoId);
      if(i >= 0) {
        miembros[i] = { ...miembros[i], ...nuevo };
      }
    } else {
      // Agregar a Firestore
      const docRef = await db.collection('miembros').add(nuevo);
      nuevo.id = docRef.id;
      miembros.push(nuevo);
    }
    renderizarTabla();
    toggleForm(false);
  } catch (error) {
    alert('Error guardando miembro: ' + error.message);
  }
}

// Cargar miembros de Firestore
async function cargarMiembros() {
  miembros = [];
  try {
    const snapshot = await db.collection('miembros').get();
    snapshot.forEach(doc => {
      miembros.push({ id: doc.id, ...doc.data() });
    });
    renderizarTabla();
  } catch (e) {
    alert('Error cargando miembros: ' + e.message);
  }
}

// Subir foto a Supabase y actualizar Firestore
async function subirFoto(file, idMiembro) {
  if (!file || !idMiembro) return;
  try {
    const nombreArchivo = `${idMiembro}_${Date.now()}_${file.name}`;
    // Subir a Supabase bucket 'fotos'
    let { data, error } = await supabase.storage
      .from('fotos')
      .upload(nombreArchivo, file, { upsert: true });
    if (error) throw error;

    // Obtener URL pública
    const { publicURL, error: urlError } = supabase.storage
      .from('fotos')
      .getPublicUrl(nombreArchivo);
    if (urlError) throw urlError;

    // Actualizar en Firestore el campo fotoURL
    await db.collection('miembros').doc(idMiembro).update({ fotoURL: publicURL });

    // Actualizar en array local y refrescar tabla
    const i = miembros.findIndex(m => m.id === idMiembro);
    if (i >= 0) {
      miembros[i].fotoURL = publicURL;
      renderizarTabla();
    }
  } catch (err) {
    alert('Error subiendo foto: ' + err.message);
  }
}

// Eventos
btnAgregarMiembro.addEventListener('click', () => toggleForm(true));
btnGuardar.addEventListener('click', guardarMiembro);

uploadFotoInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  if (!fotoSubiendoId) return alert('Error: No se sabe qué miembro actualizar');

  await subirFoto(file, fotoSubiendoId);
  uploadFotoInput.value = '';
  fotoSubiendoId = null;
});

// Inicial
cargarMiembros();
</script> 
</body>
</html>
