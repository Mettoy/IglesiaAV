<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestión de Miembros</title>
<style>
  body {
    margin: 0; font-family: Arial, sans-serif;
    background: #0d1b2a; color: #f5f5f5;
  }
  .sidebar {
    width: 220px; background: #1b263b;
    position: fixed; top: 0; left: 0; height: 100%;
    padding: 20px;
  }
  .sidebar h2 {
    color: #ffd700; text-align: center; margin-bottom: 40px;
  }
  .sidebar a {
    display: block; padding: 10px 15px; margin-bottom: 10px;
    color: #f5f5f5; text-decoration: none;
    background: #415a77; border-radius: 8px;
    transition: background-color 0.3s ease;
  }
  .sidebar a:hover {
    background: #778da9;
  }
  .main {
    margin-left: 240px; padding: 20px;
  }
  .gold { color: #ffd700; }
  button {
    background: #ffd700; color: #0d1b2a;
    padding: 10px 15px; border: none; border-radius: 8px;
    cursor: pointer;
  }
  .tab-btn {
    margin-right: 10px;
  }
  .hidden { display: none; }
  input, select {
    padding: 6px; margin-bottom: 10px;
    border-radius: 5px; border: none; width: 100%;
  }
  .form-section { margin-bottom: 20px; }
  table {
    width: 100%; border-collapse: collapse; margin-top: 20px;
  }
  th, td {
    padding: 10px; border: 1px solid #415a77;
    text-align: left;
  }
  tr:hover { background-color: #223554; }
  img.foto {
    width: 50px; height: 50px; object-fit: cover;
    border-radius: 50%;
  }
  #pagination {
    margin-top: 10px;
  }
  #pagination button {
    margin-right: 5px;
  }
</style>
</head>
<body>

<div class="sidebar">
  <h2>Miembros</h2>
  <a href="inicio.html">Inicio</a>
  <a href="#">Miembros</a>
  <a href="#">Reportes</a>
</div>

<div class="main">
  <h1><span class="gold">Gestión</span> de Miembros</h1>
  <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
    <button id="addMemberBtn">Añadir Miembro</button>
    <input type="text" id="searchInput" placeholder="Buscar por nombre o código" style="flex:1;">
  </div>

  <div style="margin-bottom:10px;">
    <button class="tab-btn" id="tabActivos">Activos</button>
    <button class="tab-btn" id="tabBaja">De Baja</button>
  </div>

  <div id="miembrosContainer"></div>

  <div id="pagination"></div>

  <!-- Modal -->
  <div id="modalForm" class="hidden" style="position:fixed; top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:1000;">
    <div style="background:#1b263b; padding:20px; border-radius:10px; width: 400px; max-height: 90vh; overflow-y: auto;">
      <h2 id="formTitle">Nuevo Miembro</h2>
      <form id="memberForm">
        <!-- Datos Personales -->
        <div class="form-section">
          <label for="nombre">Nombre *</label>
          <input type="text" id="nombre" required />
          <label for="codigo">Código *</label>
          <input type="text" id="codigo" required />
          <label for="fechaNacimiento">Fecha de Nacimiento *</label>
          <input type="date" id="fechaNacimiento" required />
          <label for="edad">Edad</label>
          <input type="number" id="edad" readonly />
          <label for="foto">Foto (jpg/png)</label>
          <input type="file" id="foto" accept="image/png, image/jpeg" />
        </div>
        <!-- Datos Familiares -->
        <div class="form-section">
          <label for="estadoCivil">Estado Civil</label>
          <input type="text" id="estadoCivil" />
        </div>
        <!-- Datos Espirituales -->
        <div class="form-section">
          <label for="ministerio">Ministerio</label>
          <input type="text" id="ministerio" />
        </div>

        <input type="hidden" id="memberId" />

        <div style="display:flex; justify-content:flex-end; gap:10px;">
          <button type="submit">Guardar</button>
          <button type="button" id="btnCancel">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

</div>

<script type="module">
// Firebase SDK
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc, updateDoc, doc, query, where, orderBy, limit, startAfter
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Supabase SDK
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAyfPQzO7evryWcQ5d1lGV3z8aB-gFOh_k",
  authDomain: "iglesia-adoracion-viva.firebaseapp.com",
  projectId: "iglesia-adoracion-viva",
  storageBucket: "iglesia-adoracion-viva.appspot.com",
  messagingSenderId: "815332010058",
  appId: "1:815332010058:web:d2afff616469349d88deb3"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Config Supabase (usa tus datos reales aquí)
const supabaseUrl = 'https://YOUR_SUPABASE_PROJECT.supabase.co';
const supabaseKey = 'YOUR_SUPABASE_ANON_KEY';
const supabase = createClient(supabaseUrl, supabaseKey);

const ftmemberBucket = 'ftmember';

// Variables y estado
let miembrosData = []; // datos cargados
let currentTab = 'activos'; // activos / baja
let currentPage = 1;
const itemsPerPage = 30;
let lastVisible = null;
let searchTerm = '';

// Elementos DOM
const modal = document.getElementById('modalForm');
const addMemberBtn = document.getElementById('addMemberBtn');
const btnCancel = document.getElementById('btnCancel');
const memberForm = document.getElementById('memberForm');
const miembrosContainer = document.getElementById('miembrosContainer');
const paginationContainer = document.getElementById('pagination');
const searchInput = document.getElementById('searchInput');
const tabActivosBtn = document.getElementById('tabActivos');
const tabBajaBtn = document.getElementById('tabBaja');

// Mostrar modal
addMemberBtn.onclick = () => {
  resetForm();
  modal.classList.remove('hidden');
  document.getElementById('formTitle').textContent = 'Nuevo Miembro';
};

// Cerrar modal
btnCancel.onclick = () => {
  modal.classList.add('hidden');
};

// Calcular edad
document.getElementById('fechaNacimiento').addEventListener('change', e => {
  const fecha = new Date(e.target.value);
  const hoy = new Date();
  let edad = hoy.getFullYear() - fecha.getFullYear();
  const m = hoy.getMonth() - fecha.getMonth();
  if (m < 0 || (m === 0 && hoy.getDate() < fecha.getDate())) edad--;
  document.getElementById('edad').value = edad >= 0 ? edad : '';
});

// Cargar miembros
async function cargarMiembros() {
  // Reset
  miembrosContainer.innerHTML = 'Cargando...';
  paginationContainer.innerHTML = '';

  let q = query(collection(db, 'miembros'), orderBy('codigo'));

  if(currentTab === 'activos') {
    q = query(collection(db, 'miembros'), where('estado', '==', 'activo'), orderBy('codigo'));
  } else if(currentTab === 'baja') {
    q = query(collection(db, 'miembros'), where('estado', '==', 'baja'), orderBy('codigo'));
  }

  const snapshot = await getDocs(q);
  miembrosData = [];

  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    miembrosData.push({ id: docSnap.id, ...data });
  });

  // Filtro búsqueda simple
  if(searchTerm.trim() !== '') {
    miembrosData = miembrosData.filter(m => 
      m.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
      m.codigo.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }

  renderTabla();
}

// Render tabla con paginación
function renderTabla() {
  if(miembrosData.length === 0) {
    miembrosContainer.innerHTML = `<p>No hay miembros en la categoría <strong>${currentTab}</strong>.</p>`;
    paginationContainer.innerHTML = '';
    return;
  }

  const start = (currentPage -1) * itemsPerPage;
  const end = start + itemsPerPage;
  const pageItems = miembrosData.slice(start, end);

  let html = `<table>
    <thead>
      <tr>
        <th>Foto</th><th>Nombre</th><th>Código</th><th>Edad</th><th>Estado</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody>`;

  pageItems.forEach(m => {
    html += `<tr>
      <td><img src="${m.fotoURL || ''}" alt="Foto" class="foto"/></td>
      <td>${m.nombre}</td>
      <td>${m.codigo}</td>
      <td>${m.edad || ''}</td>
      <td>${m.estado}</td>
      <td>
        <button onclick="editarMiembro('${m.id}')">Editar</button>
        <button onclick="toggleEstadoMiembro('${m.id}', '${m.estado}')">${m.estado === 'activo' ? 'Dar de Baja' : 'Reactivar'}</button>
      </td>
    </tr>`;
  });

  html += "</tbody></table>";

  miembrosContainer.innerHTML = html;

  renderPagination();
}

// Render paginación simple
function renderPagination() {
  paginationContainer.innerHTML = '';

  const totalPages = Math.ceil(miembrosData.length / itemsPerPage);
  if(totalPages <= 1) return;

  for(let i=1; i<=totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    if(i === currentPage) btn.disabled = true;
    btn.onclick = () => {
      currentPage = i;
      renderTabla();
    };
    paginationContainer.appendChild(btn);
  }
}

// Editar miembro (abrir modal con datos)
window.editarMiembro = async (id) => {
  const docRef = doc(db, 'miembros', id);
  const docSnap = await getDocs(query(collection(db, 'miembros'), where('__name__', '==', id)));
  if (!docSnap.empty) {
    const data = docSnap.docs[0].data();
    document.getElementById('formTitle').textContent = 'Editar Miembro';
    document.getElementById('nombre').value = data.nombre || '';
    document.getElementById('codigo').value = data.codigo || '';
    document.getElementById('fechaNacimiento').value = data.fechaNacimiento || '';
    document.getElementById('edad').value = data.edad || '';
    document.getElementById('estadoCivil').value = data.estadoCivil || '';
    document.getElementById('ministerio').value = data.ministerio || '';
    document.getElementById('memberId').value = id;
    modal.classList.remove('hidden');
  }
};

// Cambiar estado
window.toggleEstadoMiembro = async (id, estadoActual) => {
  const nuevoEstado = estadoActual === 'activo' ? 'baja' : 'activo';
  const docRef = doc(db, 'miembros', id);
  await updateDoc(docRef, { estado: nuevoEstado });
  alert(`Miembro ${nuevoEstado === 'activo' ? 'reactivado' : 'dado de baja'}.`);
  cargarMiembros();
};

// Guardar miembro nuevo o editado
memberForm.addEventListener('submit', async e => {
  e.preventDefault();

  const id = document.getElementById('memberId').value;
  const nombre = document.getElementById('nombre').value.trim();
  const codigo = document.getElementById('codigo').value.trim();
  const fechaNacimiento = document.getElementById('fechaNacimiento').value;
  const edad = document.getElementById('edad').value;
  const estadoCivil = document.getElementById('estadoCivil').value.trim();
  const ministerio = document.getElementById('ministerio').value.trim();
  const fotoInput = document.getElementById('foto');

  if(!nombre || !codigo || !fechaNacimiento) {
    alert('Nombre, código y fecha de nacimiento son obligatorios.');
    return;
  }

  modal.classList.add('hidden');

  // Subir foto si hay
  let fotoURL = null;

  if(fotoInput.files.length > 0) {
    const file = fotoInput.files[0];
    const fileExt = file.name.split('.').pop();
    const fileName = `miembros/${codigo}-${Date.now()}.${fileExt}`;

    // Subir a Supabase
    const { data, error } = await supabase.storage
      .from(ftmemberBucket)
      .upload(fileName, file, { upsert: true });

    if(error) {
      alert('Error al subir la foto: ' + error.message);
      return;
    }

    // Obtener URL pública de la foto (con signed URL para privado)
    const { data: urlData, error: urlError } = await supabase.storage
      .from(ftmemberBucket)
      .createSignedUrl(fileName, 60 * 60 * 24); // URL válida 24h

    if(urlError) {
      alert('Error al obtener URL de la foto: ' + urlError.message);
      return;
    }

    fotoURL = urlData.signedUrl;
  }

  const dataToSave = {
    nombre,
    codigo,
    fechaNacimiento,
    edad: Number(edad),
    estadoCivil,
    ministerio,
    estado: 'activo',
    fotoURL: fotoURL || null,
  };

  try {
    if(id) {
      // Editar - actualizar
      const docRef = doc(db, 'miembros', id);
      // Si se subió foto nueva, actualizar fotoURL, sino mantener existente
      if(fotoURL) dataToSave.fotoURL = fotoURL;
      else delete dataToSave.fotoURL; // para no borrar

      await updateDoc(docRef, dataToSave);
      alert('Miembro actualizado.');
    } else {
      // Nuevo miembro
      await addDoc(collection(db, 'miembros'), dataToSave);
      alert('Miembro añadido.');
    }
  } catch (error) {
    alert('Error guardando miembro: ' + error.message);
  }

  resetForm();
  cargarMiembros();
});

function resetForm() {
  memberForm.reset();
  document.getElementById('memberId').value = '';
  document.getElementById('edad').value = '';
  document.getElementById('foto').value = '';
}

// Buscar miembros en tiempo real
searchInput.addEventListener('input', e => {
  searchTerm = e.target.value;
  currentPage = 1;
  cargarMiembros();
});

// Cambiar pestañas
tabActivosBtn.addEventListener('click', () => {
  currentTab = 'activos';
  currentPage = 1;
  cargarMiembros();
});
tabBajaBtn.addEventListener('click', () => {
  currentTab = 'baja';
  currentPage = 1;
  cargarMiembros();
});

// Inicial
cargarMiembros();

</script>
</body>
</html>
