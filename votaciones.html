<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Votaciones</title>
  <link rel="icon" href="ruta-del-logo.png" />

  <!-- ----------  ESTILOS  ---------- -->
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
    }
    .menu-lateral {
      width: 200px;
      background-color: #2c3e50;
      padding: 1rem;
      color: white;
      height: 100vh;
    }
    .logo-menu {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    main {
      flex: 1;
      padding: 1rem;
      background-color: #ecf0f1;
    }
    .acciones button {
      margin: 0.5rem;
      padding: 0.6rem 1rem;
      font-weight: bold;
    }
    #eventosGuardados { margin-top: 2rem; }
    .evento {
      background-color: white;
      border: 1px solid #ccc;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 8px;
    }
    .evento button { margin-right: 1rem; }
    .modal {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex; justify-content: center; align-items: center;
    }
    .modal-contenido {
      background-color: white;
      padding: 2rem;
      border-radius: 8px;
      width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .oculto { display: none; }
    input { margin: 0.3rem; padding: 0.4rem; }
  </style>

  <!-- Firebase SDK (compat para evitar bundlers) -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
</head>
<body>

  <!-- ----------  MENÚ LATERAL  ---------- -->
  <div class="menu-lateral">
    <img src="ruta-del-logo.png" alt="Logo" class="logo-menu" />
  </div>

  <!-- ----------  CONTENIDO PRINCIPAL  ---------- -->
  <main>
    <div class="acciones">
      <button id="btnAgregarEvento">Agregar Evento</button>
      <button id="btnAgregarCandidato">Agregar Candidato</button>
    </div>

    <section id="eventosGuardados"></section>

    <!-- ----------  MODAL VOTACIÓN  ---------- -->
    <div id="modalVotacion" class="modal oculto">
      <div class="modal-contenido">
        <span class="cerrar" onclick="cerrarModal()">&times;</span>
        <h2>Ingresar votos</h2>
        <div id="contenedorCandidatos"></div>
        <button onclick="guardarVotacion()">Guardar</button>
      </div>
    </div>
  </main>

  <!-- ----------  LÓGICA JS  ---------- -->
  <script type="module">
    /* ------------ Configuración Firebase ------------ */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc,
      getDocs, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const iglesia-adoracion-viva",
  storageBucket: "iglesia-adoracion-viva.firebasestorage.app",
  messagingSenderId: "815332010058",
  appId: "1:815332010058:web:d2afff616469349d88deb3",
  measurementId: "G-43MZP6V55D"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function toggleForm() {
    const app   = initializeApp(firebaseConfig);
    const db    = getFirestore(app);
    const colEv = collection(db, "eventos");

    /* ---------------- Estado local ------------------ */
    let candidatos   = ["Candidato 1", "Candidato 2"];
    let eventoActual = null;

    /* ---------------- Utilidades -------------------- */
    const qs  = s => document.querySelector(s);
    const qsa = s => document.querySelectorAll(s);

    /* ------------- Carga inicial -------------------- */
    cargarEventos();

    /* ------------- Botones principales -------------- */
    qs("#btnAgregarEvento").addEventListener("click", async () => {
      const nombre = prompt("Nombre del evento:");
      if (!nombre) return;
      await addDoc(colEv, { nombre, finalizado: false, votos: [] });
      cargarEventos();
    });

    qs("#btnAgregarCandidato").addEventListener("click", () => {
      const nuevo = prompt("Nombre del nuevo candidato:");
      if (nuevo) {
        candidatos.push(nuevo);
        alert("Candidato agregado.");
      }
    });

    /* ------------- Renderizar eventos -------------- */
    async function cargarEventos() {
      const snap = await getDocs(colEv);
      const eventos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      const cont = qs("#eventosGuardados");
      cont.innerHTML = "";

      eventos.forEach(ev => {
        const div = document.createElement("div");
        div.className = "evento";
        div.innerHTML = `
          <h3>${ev.nombre}</h3>
          <button ${ev.finalizado ? "disabled" : ""} onclick="abrirModal('${ev.id}')">Votar</button>
          <button ${ev.finalizado ? "disabled" : ""} onclick="finalizarEvento('${ev.id}')">Finalizar</button>
          ${ev.votos.length ? `<button onclick="verResultados('${ev.id}')">Ver resultados</button>` : ""}
          ${ev.finalizado ? `<p style='color:red;'><strong>Votación cancelada</strong></p>` : ""}
        `;
        cont.appendChild(div);
      });
    }

    /* ---------------- Modal votación ---------------- */
    window.abrirModal = async id => {
      eventoActual = id;
      qs("#modalVotacion").classList.remove("oculto");
      const cont = qs("#contenedorCandidatos");
      cont.innerHTML = "";

      candidatos.forEach(nombre => {
        cont.insertAdjacentHTML("beforeend", `
          <div>
            <label><strong>${nombre}</strong></label><br/>
            Votos 1: <input type="number" class="voto1" value="0"><br/>
            Votos 2: <input type="number" class="voto2" value="0"><br/>
            Total: <input type="number" class="total" readonly><hr/>
          </div>
        `);
      });

      actualizarTotales();
      qsa(".voto1, .voto2").forEach(inp => inp.addEventListener("input", actualizarTotales));
    };

    window.cerrarModal = () => qs("#modalVotacion").classList.add("oculto");

    function actualizarTotales() {
      qsa("#contenedorCandidatos > div").forEach(div => {
        const v1 = +div.querySelector(".voto1").value || 0;
        const v2 = +div.querySelector(".voto2").value || 0;
        div.querySelector(".total").value = v1 + v2;
      });
    }

    /* -------------- Guardar votación --------------- */
    window.guardarVotacion = async () => {
      const votos = [];
      qsa("#contenedorCandidatos > div").forEach((div, i) => {
        const nombre = candidatos[i];
        const v1 = +div.querySelector(".voto1").value || 0;
        const v2 = +div.querySelector(".voto2").value || 0;
        votos.push({ nombre, voto1: v1, voto2: v2, total: v1 + v2 });
      });

      await updateDoc(doc(db, "eventos", eventoActual), { votos });
      cerrarModal();
      cargarEventos();
    };

    /* ----------------- Finalizar ------------------- */
    window.finalizarEvento = async id => {
      await updateDoc(doc(db, "eventos", id), { finalizado: true });
      cargarEventos();
    };

    /* -------------- Ver resultados ---------------- */
    window.verResultados = async id => {
      const snap = await getDocs(colEv);
      const docSnap = snap.docs.find(d => d.id === id);
      if (!docSnap) return;
      const { nombre, votos } = docSnap.data();
      let msg = `Resultados de ${nombre}:\n\n`;
      votos.forEach(v => msg += `${v.nombre}: ${v.voto1} + ${v.voto2} = ${v.total}\n`);
      alert(msg);
    };
  </script>
</body>
</html>
