<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Diezmos</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #0b1c2c;
      color: gold;
    }
    .sidebar {
      position: fixed;
      width: 200px;
      height: 100%;
      background-color: #081521;
      padding-top: 20px;
    }
    .sidebar-header {
      text-align: center;
      font-size: 1.5em;
      margin-bottom: 20px;
      font-weight: bold;
    }
    .sidebar-link {
      display: block;
      padding: 10px 20px;
      color: gold;
      text-decoration: none;
    }
    .sidebar-link.active, .sidebar-link:hover {
      background-color: #11283f;
    }
    .logout {
      position: absolute;
      bottom: 20px;
      width: 100%;
      text-align: center;
      cursor: pointer;
    }
    .main {
      margin-left: 220px;
      padding: 20px;
    }
    button {
      background-color: gold;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-weight: bold;
    }
    input, select {
      padding: 6px;
      margin: 5px;
    }
    table {
      width: 100%;
      margin-top: 10px;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid gold;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #1a2c3b;
      padding: 20px;
      width: 400px;
      color: gold;
      border-radius: 10px;
    }
  </style>
</head>
<body>

<div class="sidebar"> 
  <div class="sidebar-header">Ofrendas</div>
  <a href="acceso.html" class="sidebar-link">Dar acceso</a>
  <a href="diezmos.html" class="sidebar-link active">Diezmos</a>
  <a href="ofrendas.html" class="sidebar-link">Ofrendas</a>
  <a href="reportes.html" class="sidebar-link">Reportes</a>
  <a href="discipulado.html" class="sidebar-link">Discipulado</a>
  <div class="logout" onclick="cerrarSesion()">Cerrar sesión</div>
</div>

<div class="main">
  <h2>Diezmos</h2>
  <input type="text" id="busquedaDiezmo" placeholder="Buscar diezmo por nombre o código">
  <button onclick="abrirModal()">Añadir Diezmo</button>
  <br><br>
  <label>Desde: <input type="date" id="desde"></label>
  <label>Hasta: <input type="date" id="hasta"></label>
  <button onclick="cargarDiezmos()">Filtrar</button>

  <h3>Resumen</h3>
  <p>Total Córdobas: <span id="totalCordoba">C$0.00</span></p>
  <p>Total Dólares: <span id="totalDolar">$0.00</span></p>

  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Código</th>
        <th>Monto</th>
        <th>Moneda</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody id="tablaDiezmos"></tbody>
  </table>
</div>

<div class="modal" id="modalDiezmo">
  <div class="modal-content">
    <h3>Registrar Diezmo</h3>
    <label>¿Es miembro? 
      <select id="esMiembro" onchange="mostrarCampos()">
        <option value="si">Sí</option>
        <option value="no">No</option>
      </select>
    </label><br>
    <div id="miembroCampos">
      <input type="text" id="busquedaMiembro" placeholder="Buscar por código o nombre" oninput="buscarMiembros()">
      <select id="selectMiembro"></select>
    </div>
    <div id="noMiembroCampos" style="display:none;">
      <input type="text" id="nombreNoMiembro" placeholder="Nombre completo"><br>
      <input type="text" id="codigoNoMiembro" placeholder="Código"><br>
    </div>
    <input type="number" id="cantidad" placeholder="Cantidad"><br>
    <select id="moneda">
      <option value="cordoba">Córdoba</option>
      <option value="dolar">Dólar</option>
    </select><br>
    <input type="date" id="fecha"><br><br>
    <button onclick="guardarDiezmo()">Guardar</button>
    <button onclick="cerrarModal()">Cancelar</button>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAyfPQzO7evryWcQ5d1lGV3z8aB-gFOh_k",
    authDomain: "iglesia-adoracion-viva.firebaseapp.com",
    databaseURL: "https://iglesia-adoracion-viva-default-rtdb.firebaseio.com",
    projectId: "iglesia-adoracion-viva",
    storageBucket: "iglesia-adoracion-viva.firebasestorage.app",
    messagingSenderId: "815332010058",
    appId: "1:815332010058:web:d2afff616469349d88deb3",
    measurementId: "G-43MZP6V55D"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const abrirModal = () => document.getElementById('modalDiezmo').style.display = 'flex';
  const cerrarModal = () => document.getElementById('modalDiezmo').style.display = 'none';

  const mostrarCampos = () => {
    const es = document.getElementById('esMiembro').value;
    document.getElementById('miembroCampos').style.display = es === 'si' ? 'block' : 'none';
    document.getElementById('noMiembroCampos').style.display = es === 'no' ? 'block' : 'none';
  };

  const buscarMiembros = async () => {
    const q = document.getElementById('busquedaMiembro').value.toLowerCase();
    const snap = await db.collection('miembros').get();
    const select = document.getElementById('selectMiembro');
    select.innerHTML = '';
    snap.forEach(doc => {
      const d = doc.data();
      if (d.nombre.toLowerCase().includes(q) || d.codigo?.toLowerCase().includes(q)) {
        const opt = document.createElement('option');
        opt.value = JSON.stringify({ nombre: d.nombre, codigo: d.codigo });
        opt.text = `${d.codigo} - ${d.nombre}`;
        select.appendChild(opt);
      }
    });
  };

  const guardarDiezmo = async () => {
    let nombre, codigo;
    if (document.getElementById('esMiembro').value === 'si') {
      const val = document.getElementById('selectMiembro').value;
      if (!val) return alert("Seleccione un miembro.");
      const obj = JSON.parse(val);
      nombre = obj.nombre;
      codigo = obj.codigo;
    } else {
      nombre = document.getElementById('nombreNoMiembro').value;
      codigo = document.getElementById('codigoNoMiembro').value;
    }
    const cantidad = parseFloat(document.getElementById('cantidad').value);
    const moneda = document.getElementById('moneda').value;
    const fecha = document.getElementById('fecha').value;
    if (!nombre || !codigo || !cantidad || !fecha) return alert("Todos los campos son obligatorios.");

    await db.collection('diezmos').add({ nombre, codigo, cantidad, moneda, fecha });
    cerrarModal();
    cargarDiezmos();
  };

  const cargarDiezmos = async () => {
    const desde = document.getElementById('desde').value;
    const hasta = document.getElementById('hasta').value;
    const snap = await db.collection('diezmos')
      .where("fecha", ">=", desde)
      .where("fecha", "<=", hasta)
      .get();

    const tbody = document.getElementById('tablaDiezmos');
    tbody.innerHTML = "";
    let totalCordoba = 0, totalDolar = 0;

    snap.forEach(doc => {
      const d = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${d.nombre}</td><td>${d.codigo}</td><td>${d.cantidad}</td><td>${d.moneda}</td><td>${d.fecha}</td>`;
      tbody.appendChild(tr);
      if (d.moneda === "cordoba") totalCordoba += d.cantidad;
      else totalDolar += d.cantidad;
    });

    document.getElementById('totalCordoba').innerText = `C$${totalCordoba.toFixed(2)}`;
    document.getElementById('totalDolar').innerText = `$${totalDolar.toFixed(2)}`;
  };

  const setFechasIniciales = () => {
    const hoy = new Date();
    const desde = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
    const hasta = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
    document.getElementById('desde').value = desde.toISOString().split('T')[0];
    document.getElementById('hasta').value = hasta.toISOString().split('T')[0];
    cargarDiezmos();
  };

  window.onload = setFechasIniciales;
</script>

</body>
</html>
