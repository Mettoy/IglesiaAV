<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestión Miembros - Iglesia</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0b2241;
      color: #f0e9db;
      padding: 20px;
    }
    input, button {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      max-width: 300px;
      border-radius: 4px;
      border: none;
    }
    button {
      background-color: #b9a550;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    .miembro {
      background: #142c5c;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .miembro img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
    }
    label {
      display: block;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h1>Gestión de Miembros - Iglesia Adoración Viva</h1>

<form id="formMiembro">
  <label>Nombre completo:
    <input type="text" id="nombre" required placeholder="Nombre completo" />
  </label>
  <label>Código:
    <input type="text" id="codigo" required placeholder="Código único" />
  </label>
  <label>Edad:
    <input type="number" id="edad" required min="0" />
  </label>
  <label>Teléfono:
    <input type="tel" id="telefono" placeholder="Opcional" />
  </label>
  <label>Dirección:
    <input type="text" id="direccion" placeholder="Opcional" />
  </label>
  <label>Foto:
    <input type="file" id="foto" accept="image/*" required />
  </label>
  <button type="submit">Agregar Miembro</button>
</form>

<h2>Lista de Miembros</h2>
<div id="listaMiembros"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

<script>
  // --- CONFIGURACIÓN FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyAyfPQzO7evryWcQ5d1lGV3z8aB-gFOh_k",
    authDomain: "iglesia-adoracion-viva.firebaseapp.com",
    databaseURL: "https://iglesia-adoracion-viva-default-rtdb.firebaseio.com",
    projectId: "iglesia-adoracion-viva",
    storageBucket: "iglesia-adoracion-viva.firebasestorage.app",
    messagingSenderId: "815332010058",
    appId: "1:815332010058:web:d2afff616469349d88deb3",
    measurementId: "G-43MZP6V55D"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // --- CONFIGURACIÓN SUPABASE ---
  const SUPABASE_URL = 'https://azywyqozwwbfctxeokug.supabase.co';
  const SUPABASE_ANON_KEY = 'eneyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6eXd5cW96d3diZmN0eGVva3VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNzM1NjAsImV4cCI6MjA2MjY0OTU2MH0.tzJiz2LKQcVTb94uncIrGMfi4NV9XwR7xR6lzP3EELk';

  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // --- FUNCIONES ---

  async function subirFoto(file) {
    const fileExt = file.name.split('.').pop();
    const fileName = `${Date.now()}.${fileExt}`;
    const filePath = `fotos/${fileName}`;

    const { data, error } = await supabase.storage
      .from('fotos')
      .upload(filePath, file);

    if (error) {
      alert('Error al subir la foto: ' + error.message);
      return null;
    }

    // Obtener URL pública
    const { data: urlData } = supabase.storage
      .from('fotos')
      .getPublicUrl(filePath);

    return urlData.publicUrl;
  }

  async function agregarMiembro(event) {
    event.preventDefault();

    const nombre = document.getElementById('nombre').value.trim();
    const codigo = document.getElementById('codigo').value.trim();
    const edad = Number(document.getElementById('edad').value);
    const telefono = document.getElementById('telefono').value.trim();
    const direccion = document.getElementById('direccion').value.trim();
    const fotoInput = document.getElementById('foto');

    if (fotoInput.files.length === 0) {
      alert('Por favor, selecciona una foto.');
      return;
    }

    const fotoFile = fotoInput.files[0];
    const urlFoto = await subirFoto(fotoFile);
    if (!urlFoto) return;

    // Guardar en Firestore
    try {
      await db.collection('miembros').add({
        nombre,
        codigo,
        edad,
        telefono,
        direccion,
        fotoURL: urlFoto,
        creadoEn: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert('Miembro agregado con éxito.');
      document.getElementById('formMiembro').reset();
      cargarMiembros();
    } catch (error) {
      alert('Error guardando miembro: ' + error.message);
    }
  }

  async function cargarMiembros() {
    const lista = document.getElementById('listaMiembros');
    lista.innerHTML = 'Cargando...';

    try {
      const snapshot = await db.collection('miembros').orderBy('creadoEn', 'desc').get();
      lista.innerHTML = '';
      if (snapshot.empty) {
        lista.innerHTML = '<p>No hay miembros registrados.</p>';
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement('div');
        div.className = 'miembro';

        const img = document.createElement('img');
        img.src = data.fotoURL;
        img.alt = data.nombre;

        const info = document.createElement('div');
        info.innerHTML = `<strong>${data.nombre}</strong><br>Código: ${data.codigo}<br>Edad: ${data.edad}<br>Teléfono: ${data.telefono || 'N/A'}<br>Dirección: ${data.direccion || 'N/A'}`;

        div.appendChild(img);
        div.appendChild(info);

        lista.appendChild(div);
      });
    } catch (error) {
      lista.innerHTML = 'Error cargando miembros: ' + error.message;
    }
  }

  // --- EVENTOS ---
  document.getElementById('formMiembro').addEventListener('submit', agregarMiembro);

  // Cargar miembros al inicio
  cargarMiembros();

</script>

</body>
</html>
