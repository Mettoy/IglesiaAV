<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sistema de Administración Iglesia Adoración Viva</title>
<link rel="icon" href="https://azywyqozwwbfctxeokug.supabase.co/storage/v1/object/public/logos//images%20(1).png" />
<style>
  /* Estilos generales, esquema azul oscuro + dorado + blanco */
  body {
    margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #0b1d40;
    color: white;
  }
  header {
    background-color: #08162e;
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    border-bottom: 2px solid #d4af37;
  }
  header img.logo {
    height: 48px;
  }
  header h1 {
    font-weight: 700;
    font-size: 1.8rem;
    color: #d4af37;
    margin: 0;
  }
  main {
    padding: 1.5rem;
  }
  button {
    background-color: #d4af37;
    color: #0b1d40;
    border: none;
    padding: 0.6rem 1.2rem;
    font-weight: 700;
    cursor: pointer;
    border-radius: 4px;
    transition: background-color 0.25s ease;
  }
  button:hover {
    background-color: #c39f2b;
  }
  /* Tabla con foto */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  th, td {
    padding: 0.6rem 0.8rem;
    border-bottom: 1px solid #2f3e65;
    text-align: left;
  }
  th {
    background-color: #152a5a;
  }
  td img.photo {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 50%;
    vertical-align: middle;
    margin-right: 0.6rem;
  }
  /* Formulario */
  form {
    background-color: #152a5a;
    padding: 1rem;
    margin-top: 1rem;
    border-radius: 6px;
    max-width: 700px;
  }
  form > div.section {
    margin-bottom: 1rem;
  }
  form label {
    display: block;
    margin-bottom: 0.3rem;
    font-weight: 600;
    color: #d4af37;
  }
  form input[type=text],
  form input[type=number],
  form input[type=date],
  form select {
    width: 100%;
    padding: 0.4rem 0.6rem;
    border-radius: 4px;
    border: none;
    font-size: 1rem;
  }
  form input[type=file] {
    padding: 0.3rem;
  }
  /* Barra búsqueda y botón */
  .top-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    max-width: 700px;
  }
  .top-controls input[type=search] {
    padding: 0.5rem 0.7rem;
    border-radius: 4px;
    border: none;
    font-size: 1rem;
    width: 60%;
  }
</style>
</head>
<body>
<header>
  <img class="logo" src="https://azywyqozwwbfctxeokug.supabase.co/storage/v1/object/public/logos//images%20(1).png" alt="Logo Iglesia Adoración Viva" />
  <h1>Iglesia Adoración Viva</h1>
</header>
<main>
  <div class="top-controls">
    <button id="btnAddMember">Añadir miembro</button>
    <input type="search" id="searchMember" placeholder="Buscar miembro..." />
  </div>
  <table id="membersTable" aria-label="Lista de miembros">
    <thead>
      <tr>
        <th>Foto</th>
        <th>Nombre completo</th>
        <th>Código</th>
        <th>Edad</th>
        <th>Teléfono</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <!-- Miembros cargados aquí -->
    </tbody>
  </table>

  <form id="memberForm" style="display:none" aria-label="Formulario para agregar o editar miembros">
    <!-- Datos personales -->
    <div class="section">
      <h3 style="color:#d4af37">Datos personales</h3>
      <label for="fullName">Nombre completo</label>
      <input type="text" id="fullName" required />
      <label for="code">Código</label>
      <input type="text" id="code" required />
      <label for="age">Edad</label>
      <input type="number" id="age" min="0" required />
      <label for="phone">Teléfono</label>
      <input type="text" id="phone" />
      <label for="address">Dirección</label>
      <input type="text" id="address" />
      <label for="birthDate">Fecha de nacimiento</label>
      <input type="date" id="birthDate" />
      <label for="photo">Foto</label>
      <input type="file" id="photo" accept="image/*" />
    </div>

    <!-- Datos familiares -->
    <div class="section">
      <h3 style="color:#d4af37">Datos familiares</h3>
      <label for="relativeType">Tipo de familiar</label>
      <select id="relativeType">
        <option value="" disabled selected>Seleccione</option>
        <option value="Padre">Padre</option>
        <option value="Madre">Madre</option>
        <option value="Hermano">Hermano</option>
        <option value="Esposo/a">Esposo/a</option>
        <option value="Hijo/a">Hijo/a</option>
      </select>
      <label for="relativeName">Nombre del familiar</label>
      <input type="text" id="relativeName" />
      <button type="button" id="btnAddRelative">Agregar familiar</button>
      <ul id="relativesList" style="color:#fff; margin-top:0.5rem;"></ul>
    </div>

    <!-- Datos espirituales -->
    <div class="section">
      <h3 style="color:#d4af37">Datos espirituales</h3>
      <label for="conversionDate">Fecha de conversión</label>
      <input type="date" id="conversionDate" />
      <label for="conversionPlace">Lugar de conversión</label>
      <input type="text" id="conversionPlace" />
      <label for="baptismDate">Fecha de bautismo</label>
      <input type="date" id="baptismDate" />
      <label for="baptismPlace">Lugar de bautismo</label>
      <input type="text" id="baptismPlace" />
      <label for="spiritBaptismDate">Fecha de bautismo en el Espíritu</label>
      <input type="date" id="spiritBaptismDate" />
      <label for="spiritBaptismPlace">Lugar de bautismo en el Espíritu</label>
      <input type="text" id="spiritBaptismPlace" />
    </div>

    <button type="submit">Guardar miembro</button>
    <button type="button" id="btnCancel">Cancelar</button>
  </form>
</main>

<script>
  // Datos simulados (para prueba), aquí integrarás con Firestore y Supabase Storage según tu backend real
  let members = [];
  let editingMemberId = null;
  const relatives = [];

  const membersTableBody = document.querySelector("#membersTable tbody");
  const memberForm = document.getElementById("memberForm");
  const btnAddMember = document.getElementById("btnAddMember");
  const btnCancel = document.getElementById("btnCancel");
  const searchMember = document.getElementById("searchMember");

  const relativesList = document.getElementById("relativesList");
  const btnAddRelative = document.getElementById("btnAddRelative");
  const relativeType = document.getElementById("relativeType");
  const relativeName = document.getElementById("relativeName");

  function renderMembers(filter = "") {
    membersTableBody.innerHTML = "";
    let filteredMembers = members.filter(m =>
      m.fullName.toLowerCase().includes(filter.toLowerCase()) ||
      m.code.toLowerCase().includes(filter.toLowerCase())
    );
    filteredMembers.forEach((member, index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><img class="photo" src="${member.photoURL || 'https://via.placeholder.com/40'}" alt="Foto ${member.fullName}" /></td>
        <td>${member.fullName}</td>
        <td>${member.code}</td>
        <td>${member.age}</td>
        <td>${member.phone || ""}</td>
        <td><button type="button" data-index="${index}" class="editBtn">Editar</button></td>
      `;
      membersTableBody.appendChild(tr);
    });

    // Añadir evento editar
    document.querySelectorAll(".editBtn").forEach(btn => {
      btn.addEventListener("click", e => {
        const idx = e.target.dataset.index;
        loadMemberForm(idx);
      });
    });
  }

  function loadMemberForm(index) {
    const m = members[index];
    editingMemberId = index;
    memberForm.style.display = "block";
    btnAddMember.style.display = "none";
    // Cargar datos en formulario
    document.getElementById("fullName").value = m.fullName;
    document.getElementById("code").value = m.code;
    document.getElementById("age").value = m.age;
    document.getElementById("phone").value = m.phone || "";
    document.getElementById("address").value = m.address || "";
    document.getElementById("birthDate").value = m.birthDate || "";
    // Foto se carga sólo si cambias y subes, no la precargamos aquí

    // Cargar familiares
    relatives.length = 0; // limpiar array
    if (m.relatives) {
      m.relatives.forEach(r => relatives.push(r));
    }
    updateRelativesList();

    // Datos espirituales
    document.getElementById("conversionDate").value = m.conversionDate || "";
    document.getElementById("conversionPlace").value = m.conversionPlace || "";
    document.getElementById("baptismDate").value = m.baptismDate || "";
    document.getElementById("baptismPlace").value = m.baptismPlace || "";
    document.getElementById("spiritBaptismDate").value = m.spiritBaptismDate || "";
    document.getElementById("spiritBaptismPlace").value = m.spiritBaptismPlace || "";
  }

  function clearForm() {
    editingMemberId = null;
    memberForm.reset();
    relatives.length = 0;
    updateRelativesList();
  }

  btnAddMember.addEventListener("click", () => {
    clearForm();
    memberForm.style.display = "block";
    btnAddMember.style.display = "none";
  });

  btnCancel.addEventListener("click", () => {
    memberForm.style.display = "none";
    btnAddMember.style.display = "inline-block";
  });

  btnAddRelative.addEventListener("click", () => {
    const type = relativeType.value;
    const name = relativeName.value.trim();
    if (!type || !name) {
      alert("Por favor, seleccione tipo de familiar y escriba el nombre.");
      return;
    }
    relatives.push({ type, name });
    updateRelativesList();
    relativeType.value = "";
    relativeName.value = "";
  });

  function updateRelativesList() {
    relativesList.innerHTML = "";
    relatives.forEach((r, i) => {
      const li = document.createElement("li");
      li.textContent = `${r.type}: ${r.name}`;
      relativesList.appendChild(li);
    });
  }

  memberForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    // Recolectar datos
    const fullName = document.getElementById("fullName").value.trim();
    const code = document.getElementById("code").value.trim();
    const age = parseInt(document.getElementById("age").value);
    const phone = document.getElementById("phone").value.trim();
    const address = document.getElementById("address").value.trim();
    const birthDate = document.getElementById("birthDate").value;
    const conversionDate = document.getElementById("conversionDate").value;
    const conversionPlace = document.getElementById("conversionPlace").value.trim();
    const baptismDate = document.getElementById("baptismDate").value;
    const baptismPlace = document.getElementById("baptismPlace").value.trim();
    const spiritBaptismDate = document.getElementById("spiritBaptismDate").value;
    const spiritBaptismPlace = document.getElementById("spiritBaptismPlace").value.trim();

    // Foto - para este ejemplo se mantiene la URL por defecto
    let photoURL = 'https://via.placeholder.com/40';
    const photoInput = document.getElementById("photo");
    if (photoInput.files.length > 0) {
      // Aquí deberías subir la foto a Supabase Storage y obtener la URL
      // Para demo, solo usamos URL local:
      photoURL = URL.createObjectURL(photoInput.files[0]);
    } else if (editingMemberId !== null) {
      photoURL = members[editingMemberId].photoURL || photoURL;
    }

    const memberData = {
      fullName,
      code,
      age,
      phone,
      address,
      birthDate,
      relatives: [...relatives],
      conversionDate,
      conversionPlace,
      baptismDate,
      baptismPlace,
      spiritBaptismDate,
      spiritBaptismPlace,
      photoURL,
    };

    if (editingMemberId !== null) {
      members[editingMemberId] = memberData;
    } else {
      members.push(memberData);
    }
    memberForm.style.display = "none";
    btnAddMember.style.display = "inline-block";
    clearForm();
    renderMembers(searchMember.value);
  });

  searchMember.addEventListener("input", () => {
    renderMembers(searchMember.value);
  });

  // Render inicial
  renderMembers();
</script>
</body>
</html>
