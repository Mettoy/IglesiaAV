<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Iglesia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Estilos específicos para este dashboard */
        body {
            display: flex;
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        #sidebar {
            width: 250px;
            background-color: #343a40;
            color: white;
            padding-top: 20px;
            flex-shrink: 0;
            transition: all 0.3s;
        }
        #sidebar.collapsed {
            width: 80px;
        }
        #sidebar.collapsed .sidebar-header h3,
        #sidebar.collapsed .sidebar-header img {
            display: none;
        }
        #sidebar.collapsed .list-unstyled.components li a span {
            display: none;
        }
        #sidebar.collapsed .list-unstyled.components li a i {
            margin-right: 0;
            font-size: 1.5em;
        }
        #sidebar.collapsed .sidebar-header {
            padding: 10px;
            text-align: center;
        }
        #content {
            flex-grow: 1;
            padding: 20px;
        }
        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .sidebar-header h3 {
            margin-bottom: 10px;
            font-size: 1.5rem;
        }
        .sidebar-header img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
        }
        .list-unstyled.components {
            padding: 20px 0;
            border-bottom: 1px solid #47748b;
        }
        .list-unstyled.components li a {
            padding: 10px 15px;
            font-size: 1.1em;
            display: block;
            color: #dee2e6;
            text-decoration: none;
        }
        .list-unstyled.components li a:hover {
            color: #fff;
            background: #495057;
        }
        .list-unstyled.components li.active > a,
        a[aria-expanded="true"] {
            color: #fff;
            background: #007bff; /* Color primario de Bootstrap */
        }
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
            padding: 10px 20px;
            margin-bottom: 20px;
        }
        .card {
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #007bff;
            color: white;
            border-radius: 0.5rem 0.5rem 0 0;
            padding: 1rem 1.5rem;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .chart-container {
            position: relative;
            height: 400px; /* Altura fija para los gráficos */
            width: 100%;
        }
    </style>
</head>
<body>
    <nav id="sidebar">
        <div class="sidebar-header">
            <img id="appLogo" src="img/default_logo.png" alt="Logo">
            <h3>Dashboard Iglesia</h3>
        </div>
        <ul class="list-unstyled components">
            <li>
                <a href="inicio.html"><i class="fas fa-home"></i> <span>Inicio</span></a>
            </li>
            <li id="menuMiembros" style="display: none;">
                <a href="miembros.html"><i class="fas fa-users"></i> <span>Miembros</span></a>
            </li>
            <li id="menuFinanzas" style="display: none;">
                <a href="finanzas.html"><i class="fas fa-dollar-sign"></i> <span>Finanzas</span></a>
            </li>
            <li id="menuActividades" style="display: none;">
                <a href="actividades.html"><i class="fas fa-calendar-alt"></i> <span>Actividades</span></a>
            </li>
            <li id="menuReportes" style="display: none;">
                <a href="reportes.html"><i class="fas fa-chart-line"></i> <span>Reportes</span></a>
            </li>
            <li id="menuUsuarios" style="display: none;">
                <a href="usuarios.html"><i class="fas fa-user-shield"></i> <span>Usuarios</span></a>
            </li>
            <li id="menuConfiguracion" style="display: none;">
                <a href="configuracion.html"><i class="fas fa-cogs"></i> <span>Configuración</span></a>
            </li>
            <li>
                <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span>Cerrar Sesión</span></a>
            </li>
        </ul>
    </nav>

    <div id="content">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <button type="button" id="sidebarCollapse" class="btn btn-info">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <span class="navbar-text me-3" id="userNameDisplay"></span>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <h2>Dashboard de la Iglesia</h2>
        <p class="lead">Bienvenido al panel de control. Aquí puedes ver un resumen rápido de las estadísticas importantes.</p>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Distribución de Miembros por Sociedad
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="sociedadChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Top 7 Miembros con Más Asistencia
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="asistenciaMiembrosChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        Asistencia en las Últimas 7 Actividades
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="actividadesAsistenciaChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/11.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="js/config.js"></script>
    <script>
        // Inicializa Firebase usando la configuración de config.js
        try {
            const app = firebase.initializeApp(firebaseConfig);
            window.auth = app.auth();
            window.db = app.firestore();
            console.log('Firebase inicializado correctamente.');
        } catch (error) {
            console.error('Error al inicializar Firebase:', error);
            alert('Error al conectar con Firebase. Por favor, revisa la consola para más detalles.');
        }

        // Definiciones de funciones de Chart.js y carga de datos
        let sociedadChartInstance;
        let asistenciaMiembrosChartInstance;
        let actividadesAsistenciaChartInstance;

        async function cargarEstadisticasSociedad() {
            try {
                const miembrosRef = window.db.collection('miembros');
                const snapshot = await miembrosRef.get();
                const sociedades = {};

                snapshot.forEach(doc => {
                    const miembro = doc.data();
                    const sociedad = miembro.sociedad || 'Sin Sociedad';
                    sociedades[sociedad] = (sociedades[sociedad] || 0) + 1;
                });

                const labels = Object.keys(sociedades);
                const data = Object.values(sociedades);

                const ctx = document.getElementById('sociedadChart').getContext('2d');

                if (sociedadChartInstance) {
                    sociedadChartInstance.destroy();
                }
                sociedadChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                '#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6610f2', '#fd7e14'
                            ],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Distribución de Miembros por Sociedad'
                            }
                        }
                    }
                });
                console.log("'miembros' data fetched from Firestore:", sociedades);
            } catch (error) {
                console.error("Error al cargar estadísticas de sociedad:", error);
            }
        }

        async function cargarEstadisticasAsistenciaMiembros() {
            try {
                const miembrosRef = window.db.collection('miembros');
                const snapshot = await miembrosRef.get();
                const asistenciaData = [];

                snapshot.forEach(doc => {
                    const miembro = doc.data();
                    if (miembro.nombre && miembro.asistencia) {
                        asistenciaData.push({
                            nombre: miembro.nombre,
                            asistencia: miembro.asistencia
                        });
                    }
                });

                // Ordenar por asistencia de mayor a menor y tomar el top 7
                asistenciaData.sort((a, b) => b.asistencia - a.asistencia);
                const top7 = asistenciaData.slice(0, 7);

                const labels = top7.map(m => m.nombre);
                const data = top7.map(m => m.asistencia);

                const ctx = document.getElementById('asistenciaMiembrosChart').getContext('2d');

                if (asistenciaMiembrosChartInstance) {
                    asistenciaMiembrosChartInstance.destroy();
                }
                asistenciaMiembrosChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Número de Asistencias',
                            data: data,
                            backgroundColor: '#17a2b8',
                            borderColor: '#17a2b8',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Top 7 Miembros con Más Asistencia'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                console.log("'miembros' (asistencia) data fetched from Firestore:", top7);
            } catch (error) {
                console.error("Error al cargar estadísticas de asistencia de miembros:", error);
            }
        }

        async function cargarEstadisticasActividades() {
            try {
                // Asegúrate que esta es la colección correcta: 'actividades' (en español)
                const actividadesRef = window.db.collection('actividades');
                const q = actividadesRef.orderBy("fecha", "desc").limit(7);
                const snapshot = await q.get();
                const actividadesData = [];

                snapshot.forEach(doc => {
                    const actividad = doc.data();
                    if (actividad.nombre && actividad.asistencia) {
                        // Formatear la fecha si existe
                        let fechaStr = actividad.fecha ? new Date(actividad.fecha.toDate()).toLocaleDateString() : 'Sin Fecha';
                        actividadesData.push({
                            nombre: actividad.nombre,
                            fecha: fechaStr,
                            asistencia: actividad.asistencia
                        });
                    }
                });

                // Invertir el orden para que el gráfico muestre la actividad más antigua a la izquierda
                actividadesData.reverse();

                const labels = actividadesData.map(a => `${a.nombre} (${a.fecha})`);
                const data = actividadesData.map(a => a.asistencia);

                const ctx = document.getElementById('actividadesAsistenciaChart').getContext('2d');

                if (actividadesAsistenciaChartInstance) {
                    actividadesAsistenciaChartInstance.destroy();
                }
                actividadesAsistenciaChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Número de Asistentes',
                            data: data,
                            backgroundColor: 'rgba(0, 123, 255, 0.5)',
                            borderColor: '#007bff',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Asistencia en las Últimas 7 Actividades'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Asistencia'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Actividad'
                                }
                            }
                        }
                    }
                });
                console.log("'actividades' data fetched from Firestore:", actividadesData);
            } catch (error) {
                console.error("Error al cargar estadísticas de actividades:", error);
            }
        }

        async function cargarLogo() {
            try {
                const configDocRef = window.db.collection('configuracion').doc('appConfig');
                const docSnap = await configDocRef.get();

                if (docSnap.exists) {
                    const config = docSnap.data();
                    if (config.logoUrl) {
                        document.getElementById('appLogo').src = config.logoUrl;
                    }
                }
            } catch (error) {
                console.error("Error al cargar el logo:", error);
            }
        }

        // Función para ocultar todos los elementos del menú
        function ocultarTodosLosMenus() {
            document.getElementById('menuMiembros').style.display = 'none';
            document.getElementById('menuFinanzas').style.display = 'none';
            document.getElementById('menuActividades').style.display = 'none';
            document.getElementById('menuReportes').style.display = 'none';
            document.getElementById('menuUsuarios').style.display = 'none';
            document.getElementById('menuConfiguracion').style.display = 'none';
        }

        // Manejar el estado de autenticación
        window.auth.onAuthStateChanged(async (user) => {
            ocultarTodosLosMenus(); // Oculta todos los menús por defecto

            if (user) {
                console.log('Usuario autenticado:', user.email);
                document.getElementById('userNameDisplay').textContent = `Bienvenido, ${user.email}`;

                try {
                    const userDocRef = window.db.collection('usuarios').doc(user.uid);
                    const docSnap = await userDocRef.get();

                    if (docSnap.exists) {
                        const userData = docSnap.data();
                        console.log('Datos del usuario:', userData);

                        if (userData.rol) {
                            switch (userData.rol) {
                                case 'Administrador':
                                    document.getElementById('menuMiembros').style.display = 'block';
                                    document.getElementById('menuFinanzas').style.display = 'block';
                                    document.getElementById('menuActividades').style.display = 'block';
                                    document.getElementById('menuReportes').style.display = 'block';
                                    document.getElementById('menuUsuarios').style.display = 'block';
                                    document.getElementById('menuConfiguracion').style.display = 'block';
                                    break;
                                case 'Pastor':
                                    document.getElementById('menuMiembros').style.display = 'block';
                                    document.getElementById('menuActividades').style.display = 'block';
                                    document.getElementById('menuReportes').style.display = 'block';
                                    break;
                                case 'Secretario':
                                    document.getElementById('menuMiembros').style.display = 'block';
                                    document.getElementById('menuActividades').style.display = 'block';
                                    break;
                                case 'Tesorero':
                                    document.getElementById('menuFinanzas').style.display = 'block';
                                    document.getElementById('menuReportes').style.display = 'block';
                                    break;
                                default:
                                    console.log('Rol no reconocido o sin permisos específicos para el menú.');
                                    // Podrías dejar algunos menús básicos aquí si lo deseas para roles no reconocidos.
                                    break;
                            }
                        } else {
                            console.log('Usuario sin rol definido.');
                        }
                    } else {
                        console.log('No hay datos de rol para este usuario en Firestore.');
                        // Podrías redirigir a una página de perfil o pedirle que complete su información
                        // O simplemente mostrar un menú muy limitado.
                    }
                } catch (error) {
                    console.error("Error al obtener el rol del usuario:", error);
                    alert("Error al cargar el rol del usuario. Por favor, intenta de nuevo.");
                }

                // Cargar estadísticas y logo una vez que el usuario está autenticado
                cargarEstadisticasSociedad();
                cargarEstadisticasAsistenciaMiembros();
                cargarEstadisticasActividades();
                cargarLogo();

            } else {
                console.log('Usuario no autenticado. Redirigiendo a login.html');
                window.location.href = 'login.html'; // Redirige si no está autenticado
            }
        });

        // Botón de cerrar sesión
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await window.auth.signOut();
                console.log('Sesión cerrada exitosamente.');
                // onAuthStateChanged se encargará de la redirección a login.html
            } catch (error) {
                console.error('Error al cerrar sesión:', error);
                alert('Error al cerrar sesión. Por favor, intenta de nuevo.');
            }
        });

        // Toggle sidebar
        document.getElementById('sidebarCollapse').addEventListener('click', function () {
            document.getElementById('sidebar').classList.toggle('collapsed');
            document.getElementById('content').classList.toggle('active');
        });

        // Asegurarse de que el contenido se ajuste si la sidebar se colapsa/expande
        window.addEventListener('resize', function() {
            // Puedes añadir lógica aquí si necesitas ajustar algo al redimensionar
        });

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
